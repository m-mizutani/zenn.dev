---
title: "Regoãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆ"
emoji: "ğŸ‘Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["opa", "rego"]
published: true
---

ã“ã®è¨˜äº‹ã¯[OPA/Regoã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼](https://adventar.org/calendars/6601)ã®10æ—¥ç›®ã§ã™ã€‚

ä»Šå›ã®è¨˜äº‹ã§ã¯Regoã«ã‚ˆã‚‹ãƒ«ãƒ¼ãƒ«è¡¨ç¾ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã²ãŸã™ã‚‰åˆ—æŒ™ã—ã¦ã„ãã¾ã™ã€‚

# ãƒ‡ãƒãƒƒã‚°

## å€¤ã®ãƒã‚§ãƒƒã‚¯

```rego
r := input.user
print(r)
```

## ãƒˆãƒ¬ãƒ¼ã‚¹

explainã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã€‚

```rego
trace(sprintf("x = %d", [x]))
```

# æ–‡å­—åˆ—æ“ä½œ

## æ•´å½¢

```rego
"blue 5" == sprintf("%s %d", ["blue", 5])
```

## æ–‡å­—åˆ—ã®çµåˆãƒ»åˆ†å‰²
```rego
"red, yellow, blue" == concat(", ", ["red", "yellow", "blue"])
["red", "yellow", "blue"] == split("red, yellow, blue", ", ")
```

## éƒ¨åˆ†ä¸€è‡´
```rego
contains("blue", "l")
2 == indexof("blue", "u")
startswith("blue", "bl")
endswith("blue", "ue")
```

## å°æ–‡å­—åŒ–ãƒ»å¤§æ–‡å­—åŒ–
```rego
"blue" == lower("BLUE")
"BLUE" == upper("blue")
```

## æŠœãå‡ºã—
```rego
"blue!" == substring("the blue!?", 4, 5)
```

## åˆ‡ã‚Šå–ã‚Š
```rego
"blue" == trim("_blue!", "_!") # ç¬¬2å¼•æ•°ã¯æ–‡å­—ã‚»ãƒƒãƒˆ
"blue" == trim_left("e__blue", "e_") # ç¬¬2å¼•æ•°ã¯æ–‡å­—ã‚»ãƒƒãƒˆ
"blue" == trim_right("blue__b", "_b") # ç¬¬2å¼•æ•°ã¯æ–‡å­—ã‚»ãƒƒãƒˆ
"blue" == trim_prefix("bblue", "b") # ç¬¬2å¼•æ•°ã¯æ–‡å­—åˆ—
"blue" == trim_suffix("bluee", "e") # ç¬¬2å¼•æ•°ã¯æ–‡å­—åˆ—
"blue" == trim_space("   blue   ")
```

## æ­£è¦è¡¨ç¾ã®ä¸€è‡´
```rego
regex.match("[a-z]+", "_blue_")
```

# é…åˆ—ãƒ»é›†åˆæ“ä½œ

## çµåˆï¼ˆé…åˆ—ï¼‰
```rego
["blue", "yellow", "red"] == array.concat(["blue", "yellow"], ["red"])
```

## æŠœãå‡ºã—ï¼ˆé…åˆ—ï¼‰
```rego
["yellow", "blue"] == array.slice(["red", "yellow", "blue"], 1, 3)
```

## è¦ç´ æ•°ï¼ˆé…åˆ—ãƒ»é›†åˆï¼‰
```rego
3 == count(["red", "yellow", "blue"])
```

## æœ€å¤§å€¤ãƒ»æœ€å°å€¤ãƒ»åˆè¨ˆï¼ˆé…åˆ—ãƒ»é›†åˆï¼‰

```rego
5 == max([3, 2, 5, 1, 4])
1 == min([3, 2, 5, 1, 4])
15 == sum([3, 2, 5, 1, 4])
```

## ã‚½ãƒ¼ãƒˆï¼ˆé…åˆ—ãƒ»é›†åˆï¼‰

è¿”ã‚Šå€¤ã¯é…åˆ—ã«ãªã‚Šã¾ã™ã€‚

```rego
[1, 2, 3, 4, 5] == sort([3, 2, 5, 1, 4]) # array
[1, 2, 3, 4, 5] == sort({3, 2, 5, 1, 4}) # set
["blue", "red", "yellow"] == sort(["red", "yellow", "blue"])
```

## ç©é›†åˆãƒ»å’Œé›†åˆãƒ»å·®é›†åˆï¼ˆé›†åˆï¼‰

```rego
{"blue"} == {"blue", "red"} & {"orange", "blue"}
{"blue", "red", "orange"} == {"blue", "red"} | {"orange", "blue"}
{"blue"} == {"blue", "red"} - {"red"}
```

# ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆãƒãƒƒãƒ—å‹ï¼‰æ“ä½œ

## å€¤ã®å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æŒ‡å®šï¼‰

```rego
dict := {
    "white": 3,
    "blue": 5,
}
1 == object.get(dict, "none", 1)
```

## ã‚­ãƒ¼ã®é›†åˆã®å–å¾—

```rego
dict := {
    "white": 3,
    "blue": 5,
}

{"white", "blue"} == {x | dict[x]}
```

## å€¤ã®é›†åˆã®å–å¾—

```rego
dict := {
    "white": 3,
    "blue": 5,
}

{3, 5} == {dict[x] | dict[x]}
```

## ç‰¹å®šã‚­ãƒ¼ã®é™¤å¤–

```rego
dict := {
    "red": 2,
    "white": 3,
    "blue": 5,
}

{"blue": 5} == object.remove(dict, ["white", "red"])
```

## ç‰¹å®šã‚­ãƒ¼ã‚’æ®‹ã™

```rego
dict := {
    "red": 2,
    "white": 3,
    "blue": 5,
}

{"blue": 5} == object.filter(dict, ["blue"])
```

## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®åˆæˆ

```rego
obj1 := {
    "white": 3,
    "blue": 0,
}
obj2 := {
    "red": 2,
    "blue": 5,
}

{
    "red": 2,
    "white": 3,
    "blue": 5, # å¾Œå‹ã¡ã§obj2ãŒå„ªå…ˆ
} == object.union(obj1, obj2)
```

# ãƒãƒƒãƒ

## æœ€ä½1ã¤ã«ãƒãƒƒãƒ

### é…åˆ—

```rego
    arr := ["red", "blue", "yellow"]
    "blue" == arr[_]
```

### ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹

```rego
    obj := {
        "red": 2,
        "white": 3,
        "blue": 5,
    }
    5 == obj[_]
```

## å…¨éƒ¨ã«ãƒãƒƒãƒ

### é…åˆ—

```rego
arr := [1, 1, 1]
3 == count([x | arr[x] == 1])
```

### ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹

```rego
obj := {
    "red": 1,
    "yellow": 1,
    "blue": 1,
}
3 == count([x | obj[x] == 1])
```

## JOIN

```rego
users = [
    {
        "name": "alice",
        "id": 1,
    },
    {
        "name": "bob",
        "id": 2,
    },
]
assigns = [
    {
        "id": 1,
        "role": "admin",
    },
    {
        "id": 1,
        "role": "reader",
    },
    {
        "id": 2,
        "role": "reader",
    },
]

some x, y
users[x].name == "alice"
assigns[y].id == users[x].id
assigns[y].role == "admin"
```
