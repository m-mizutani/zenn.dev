---
title: "Goã§ä½œã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æLLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ(13): ä¼šè©±ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åœ§ç¸®"
emoji: "ğŸ’¬"
type: "tech"
topics: ["ai", "go", "llm", "agent"]
published: true
---

ã“ã®è¨˜äº‹ã¯ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€Œ[Goã§ä½œã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æLLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ](https://adventar.org/calendars/11354)ã€ã®13æ—¥ç›®ã§ã™ã€‚

ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯ https://github.com/m-mizutani/leveret ã® [day13-context-compression](https://github.com/m-mizutani/leveret/tree/day13-context-compression) ãƒ–ãƒ©ãƒ³ãƒã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã®ã§é©å®œå‚ç…§ã—ã¦ãã ã•ã„ã€‚

# ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã®èª²é¡Œ

LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é‹ç”¨ã—ã¦ã„ãã†ãˆã§é¿ã‘ã¦é€šã‚Œãªã„å•é¡ŒãŒã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³é™ç•Œï¼‰ã®è¶…éã§ã™ã€‚ã“ã‚Œã¾ã§ã®è¨˜äº‹ã§ã‚‚ä½•åº¦ã‹è§¦ã‚Œã¦ãã¾ã—ãŸãŒã€ä¼šè©±ãŒé•·ããªã£ãŸã‚Šãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡ŒçµæœãŒè“„ç©ã•ã‚ŒãŸã‚Šã™ã‚‹ã¨ã€å¿…ãšã“ã®å•é¡Œã«ç›´é¢ã—ã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ã€ã“ã®å•é¡Œã«ã©ã†å¯¾å‡¦ã™ã‚‹ã‹ã‚’è§£èª¬ã—ã¾ã™ã€‚

## LLMã«ãŠã‘ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã«é–¢ã™ã‚‹åŸºç¤çŸ¥è­˜

ã¾ãšã€ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¤ã„ã¦ã®åŸºç¤çŸ¥è­˜ã‚’æ•´ç†ã—ã¦ãŠãã¾ã™ã€‚ã“ã“ã§ã„ã†ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã¯ã€ç”ŸæˆAIï¼ˆç‰¹ã«Large Language Modelï¼‰ãŒå‡¦ç†ã™ã‚‹ãŸã‚ã«æ–‡å­—åˆ—ã‚’åˆ†å‰²ã—ãŸå˜ä½ã®ã“ã¨ã§ã™ã€‚è‹±èªã®å ´åˆã¯1å˜èªãŒ1ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãªã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã™ãŒã€å¿…ãšã—ã‚‚ãã†ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚è¨˜å·ã‚„ç‰¹æ®Šæ–‡å­—ãªã©ã‚‚1ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã—ã¦è¡¨ã•ã‚Œã¾ã™ã—ã€é•·ã„å˜èªã¯è¤‡æ•°ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«åˆ†å‰²ã•ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚

ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã¯åŸå‰‡ã¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã«å•ã„åˆã‚ã›ãªã„ã¨æ­£ç¢ºãªå€¤ãŒã‚ã‹ã‚Šã¾ã›ã‚“ã€‚Geminiã®å ´åˆã€ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã®å–å¾—è‡ªä½“ã¯ç„¡æ–™ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¦‚å¿µã‚„åˆ†å‰²æ–¹æ³•ã¯ãƒ¢ãƒ‡ãƒ«ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ç•°ãªã‚Šã€BPEï¼ˆByte Pair Encodingï¼‰ã‚„WordPieceã¨ã„ã£ãŸæ‰‹æ³•ãŒç”¨ã„ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸã€è¨€èªã«ã‚ˆã£ã¦ã‚‚ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã®å‚¾å‘ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚è‹±èªã§ã¯1å˜èªãŒ1ãƒˆãƒ¼ã‚¯ãƒ³å‰å¾Œã«ãªã‚‹ã“ã¨ãŒå¤šã„ã®ã«å¯¾ã—ã€æ—¥æœ¬èªã§ã¯åŒã˜æ–‡å­—åˆ—é•·ã«å¯¾ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãŒå¤šããªã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚

Geminiã§ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã„ã¾ã™ã€‚

```go:
client, err := genai.NewClient(ctx, &genai.ClientConfig{
    Project:  os.Getenv("GEMINI_PROJECT"),
    Location: location,
    Backend:  genai.BackendVertexAI,
})
if err != nil {
    return goerr.Wrap(err, "failed to create genai client")
}

// Count tokens
contents := genai.Text(text)
resp, err := client.Models.CountTokens(ctx, model, contents, nil)
if err != nil {
    return goerr.Wrap(err, "failed to count tokens")
}

fmt.Printf("Token count: %d tokens\n", resp.TotalTokens)
```

å®Ÿéš›ã«å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ã€ãƒˆãƒ¼ã‚¯ãƒ³åˆ†å‰²ã®æ§˜å­ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```bash
$ cd examples/count-token
$ env GEMINI_PROJECT=your-project go run . "hello world"
Token count: 2 tokens
$ go run . '{"hello":"world"}'
Token count: 5 tokens
$ go run . 'ã“ã‚“ã«ã¡ã¯'
Token count: 1 tokens
$ go run . 'å¯¿é™ç„¡å¯¿é™ç„¡äº”åŠ«ã®æ“¦ã‚Šåˆ‡ã‚Œ'
Token count: 12 tokens
```

è‹±èªã® "hello world" ã¯2ãƒˆãƒ¼ã‚¯ãƒ³ã€JSONå½¢å¼ã®æ–‡å­—åˆ—ã¯æ‹¬å¼§ã‚„ã‚³ãƒ­ãƒ³ãªã©ã®è¨˜å·ã‚‚å«ã‚ã¦5ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãªã‚Šã¾ã™ã€‚æ—¥æœ¬èªã®å ´åˆã€ã€Œã“ã‚“ã«ã¡ã¯ã€ã¯1ãƒˆãƒ¼ã‚¯ãƒ³ã€ã€Œå¯¿é™ç„¡å¯¿é™ç„¡äº”åŠ«ã®æ“¦ã‚Šåˆ‡ã‚Œã€ï¼ˆ15æ–‡å­—ï¼‰ã¯12ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãªã£ã¦ã„ã¾ã™ã€‚è‹±èªã¯æ–‡å­—æ•°ï¼ˆ10æ–‡å­—ï¼‰ã«å¯¾ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼ˆ2ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ãŒå°‘ãªã„ã®ã«å¯¾ã—ã€æ—¥æœ¬èªã¯æ–‡å­—æ•°ã«è¿‘ã„ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã«ãªã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚

## LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ©ç”¨æ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™å•é¡Œ

ãƒ¢ãƒ‡ãƒ«ã”ã¨ã®ãƒˆãƒ¼ã‚¯ãƒ³é™ç•Œã¯å¹´ã€…å¢—åŠ ã—ã¦ã„ã¾ã™ãŒã€ãã‚Œã§ã‚‚æœ‰é™ã§ã™ã€‚ä¾‹ãˆã°Geminiã®å ´åˆã€100ä¸‡ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆæ­£ç¢ºã«ã¯1,048,576ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ãŒä¸Šé™ã¨ãªã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ãƒ†ã‚­ã‚¹ãƒˆæ›ç®—ã§ãŠã‚ˆã4MBç¨‹åº¦ã®å®¹é‡ã«ç›¸å½“ã—ã€ä¸€è¦‹ã™ã‚‹ã¨éå¸¸ã«é•·ã„ã‚ˆã†ã«æ€ãˆã¾ã™ãŒã€LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é‹ç”¨ã—ã¦ã„ã‚‹ã¨æ„å¤–ã¨ç°¡å˜ã«åˆ°é”ã—ã¦ã—ã¾ã„ã¾ã™ã€‚

LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ãŒå•é¡Œã«ãªã‚‹ã‚±ãƒ¼ã‚¹ã¯ã€å¤§ããåˆ†ã‘ã¦2ã¤ã‚ã‚Šã¾ã™ã€‚

### (1) ä¼šè©±ãŒç¶šãã“ã¨ã§å±¥æ­´ãŒé•·ããªã‚‹

ã™ã§ã«å®Ÿè£…ã—ãŸé€šã‚Šã€LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã®ã€Œä¼šè©±ã€ã®å®Ÿæ…‹ã¯ã€Œéƒ½åº¦ä¼šè©±ã®å±¥æ­´ã‚’å…¨éƒ¨æŠ•ã’ã¤ã‘ã‚‹ã€ã¨ã„ã†ã“ã¨ã§ã—ãŸã€‚LLMã¯åŸºæœ¬çš„ã«ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã§ã‚ã‚‹ãŸã‚ã€å‰å›ã¾ã§ã®æ–‡è„ˆã‚’ä¿æŒã™ã‚‹ã«ã¯ã€æ¯å›ã™ã¹ã¦ã®å±¥æ­´ã‚’å«ã‚ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ä¼šè©±ãŒç¶šãã¨è‡ªãšã¨å±¥æ­´ãŒé•·ããªã£ã¦ã„ãã¾ã™ã€‚å€‹ã€…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒçŸ­ãã¦ã‚‚ã€ã‚„ã‚Šå–ã‚Šã®å›æ•°ãŒå¢—ãˆã‚Œã°å…¨ä½“ã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã¯å¢—åŠ ã—ã€æœ€çµ‚çš„ã«ã¯ãƒˆãƒ¼ã‚¯ãƒ³é™ç•Œã‚’è¶…éã—ã¦ã—ã¾ã„ã¾ã™ã€‚ç‰¹ã«ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã‚’ç¹°ã‚Šè¿”ã™ã‚ˆã†ãªå‡¦ç†ã§ã¯ã€ãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡Œçµæœã‚‚å±¥æ­´ã«å«ã¾ã‚Œã‚‹ãŸã‚ã€ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ãŒåŠ é€Ÿã—ã¾ã™ã€‚

### (2) ä¸€åº¦ã«é•·ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæŠ•å…¥ã•ã‚Œã‚‹å ´åˆ

ã‚‚ã†ä¸€ã¤ã®ã‚±ãƒ¼ã‚¹ã¯ã€å˜ä¸€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒéå¸¸ã«é•·ã„å ´åˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãŒå¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥å…¥åŠ›ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ç™ºç”Ÿã—ã‚„ã™ã„å•é¡Œã§ã™ã€‚ã¾ãŸã€ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã®çµæœãŒéå¸¸ã«å¤§ãã„å ´åˆï¼ˆä¾‹ãˆã°ãƒ­ã‚°æ¤œç´¢ã®çµæœãŒæ•°ä¸‡è¡Œã«åŠã¶ãªã©ï¼‰ã«ã‚‚åŒæ§˜ã®å•é¡ŒãŒèµ·ã“ã‚Šã¾ã™ã€‚

ã“ã®ã‚±ãƒ¼ã‚¹ã¯ä¼šè©±å±¥æ­´ã®è¦ç´„ã ã‘ã§ã¯è§£æ±ºã§ãã¾ã›ã‚“ã€‚å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãã®ã‚‚ã®ã®ã‚µã‚¤ã‚ºãŒé™ç•Œã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã€ãƒ‡ãƒ¼ã‚¿è‡ªä½“ã‚’åœ§ç¸®ã—ãŸã‚Šãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ãŸã‚Šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ä¸»ã«(1)ã®ã‚±ãƒ¼ã‚¹ã€ã¤ã¾ã‚Šä¼šè©±å±¥æ­´ã®è“„ç©ã«ã‚ˆã‚‹ãƒˆãƒ¼ã‚¯ãƒ³è¶…éã¸ã®å¯¾å‡¦æ–¹æ³•ã‚’æ‰±ã„ã¾ã™ã€‚

# ä¼šè©±å±¥æ­´ã®è¦ç´„ã¨æˆ¦ç•¥

ä¼šè©±å±¥æ­´ãŒé™ç•Œã‚’è¶…ãˆãŸå ´åˆã€å¤ã„å±¥æ­´ã‚’å˜ç´”ã«å‰Šé™¤ã™ã‚‹ã¨ã„ã†å¯¾å‡¦ã‚‚å¯èƒ½ã§ã™ã€‚ã—ã‹ã—ã“ã‚Œã«ã¯é‡å¤§ãªå•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚éå»ã«ä¼šè©±ã—ãŸå†…å®¹ã‚’ã€Œå¿˜ã‚Œã¦ã€ã—ã¾ã†ã“ã¨ã«ãªã‚‹ã‹ã‚‰ã§ã™ã€‚

ä¾‹ãˆã°ã€æœ€åˆã«ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰é‡è¦ãªæŒ‡ç¤ºã‚„åˆ¶ç´„æ¡ä»¶ãŒä¸ãˆã‚‰ã‚Œã¦ã„ãŸå ´åˆã€ãã‚Œã‚’å‰Šé™¤ã—ã¦ã—ã¾ã†ã¨ä»¥é™ã®å¿œç­”ãŒãƒ¦ãƒ¼ã‚¶ã®æ„å›³ã‹ã‚‰å¤–ã‚Œã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€èª¿æŸ»ã®é€”ä¸­ã§å¾—ã‚‰ã‚ŒãŸé‡è¦ãªçŸ¥è¦‹ã‚„åˆ¤æ–­ææ–™ã‚’å¤±ã£ã¦ã—ã¾ã†ã¨ã€åŒã˜èª¿æŸ»ã‚’ä½•åº¦ã‚‚ç¹°ã‚Šè¿”ã™ã“ã¨ã«ãªã‚Šã‹ã­ã¾ã›ã‚“ã€‚

ãã“ã§æ¡ç”¨ã™ã‚‹ã®ãŒã€ä¼šè©±ã‚’è¦ç´„ã™ã‚‹ã“ã¨ã§ã‚µã‚¤ã‚ºã‚’åœ§ç¸®ã™ã‚‹ã¨ã„ã†æ‰‹æ³•ã§ã™ã€‚ã“ã‚Œã¯å˜ãªã‚‹ãƒ‡ãƒ¼ã‚¿ã®å¯é€†åœ§ç¸®ã§ã¯ãªãã€è¦ç´„ã«ã‚ˆã£ã¦è¦ç‚¹ã ã‘ã‚’æ®‹ã™ã¨ã„ã†æ‰‹æ³•ã§ã™ã€‚ä¾‹ãˆã°ã€é€”ä¸­ã§ãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã—ãŸéš›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ç´°ã€çŸ¥è¦‹ã‚’å¾—ã‚‹å‰ã®ç”Ÿãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ãªã©ã¯ã€å¾Œç¶šã®å‡¦ç†ã«ã¯ã‚ã¾ã‚Šæ„å‘³ã‚’æŒã¡ã¾ã›ã‚“ã€‚ã“ã®ã‚ˆã†ãªæƒ…å ±ã‚’çœç•¥ã—ã€é‡è¦åº¦ã®é«˜ã„æƒ…å ±ã®ã¿ã‚’ä¿æŒã™ã‚‹ã“ã¨ã§ã€æƒ…å ±ã®æ¬ è½ã‚’æœ€å°é™ã«æŠ‘ãˆãªãŒã‚‰ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚

ã‚‚ã¡ã‚ã‚“ã€è¦ç´„ã«ã‚ˆã£ã¦ä¸€å®šã®æƒ…å ±æ¬ è½ã¯é¿ã‘ã‚‰ã‚Œã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€å¯èƒ½ã§ã‚ã‚Œã°è¦ç´„ã‚’è¡Œã‚ãªã„ã«è¶Šã—ãŸã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã—ã‹ã—ç¾å®Ÿçš„ã«ã¯é¿ã‘ã‚‰ã‚Œãªã„å•é¡Œã§ã‚ã‚‹ãŸã‚ã€é©åˆ‡ãªè¦ç´„æˆ¦ç•¥ã‚’ç«‹ã¦ã‚‹ã“ã¨ãŒé‡è¦ã«ãªã‚Šã¾ã™ã€‚

## è¦ç´„ã®å…·ä½“çš„æ–¹æ³•

å¤§å®¹é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦ç´„ã™ã‚‹æ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€è¦ç´„è‡ªä½“ã‚’LLMã«ã‚¯ã‚¨ãƒªã™ã‚‹ã¨ã„ã†æ–¹æ³•ã‚’æ¡ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚‚ã¨ã‚‚ã¨ãƒˆãƒ¼ã‚¯ãƒ³é™ç•Œã«åã¾ã£ã¦ã„ãŸãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚ºã‚’åœ§ç¸®ã—ãŸã„ã ã‘ã§ã‚ã‚Šã€å¿…è¦ãªå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾æŠ•å…¥ã§ãã‚‹ãŸã‚ã§ã™ã€‚

ã‚ˆã‚Šé«˜åº¦ãªè¦ç´„æ–¹æ³•ã¨ã—ã¦ã¯ã€ä¾‹ãˆã°å±¥æ­´ã‚’è¤‡æ•°ã®æ–­ç‰‡ã«åˆ†å‰²ã—ã¦å€‹åˆ¥ã«è¦ç´„ã‚’ä½œæˆã—ã€ãã‚Œã‚‰ã‚’çµ±åˆã™ã‚‹ã¨ã„ã£ãŸæ‰‹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ã‚’å„ªå…ˆã—ã€ã“ã®ã‚ˆã†ãªé«˜åº¦ãªæ‰‹æ³•ã¯æ‰±ã„ã¾ã›ã‚“ã€‚èˆˆå‘³ã®ã‚ã‚‹æ–¹ã¯ Map-Reduce å‹ã®è¦ç´„æ‰‹æ³•ãªã©ã‚’èª¿ã¹ã¦ã¿ã¦ãã ã•ã„ã€‚

ãªãŠã€è¦ç´„è‡ªä½“ã‚‚LLMã¸ã®ã‚¯ã‚¨ãƒªã¨ãªã‚‹ãŸã‚ã€è¦ç´„å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™å†…ã«åã¾ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚è¦ç´„å¯¾è±¡ãŒæ—¢ã«ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯ã€å…ˆè¿°ã—ãŸMap-Reduceå‹ã®åˆ†å‰²è¦ç´„ãªã©ã®åˆ¥ã®æ‰‹æ³•ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ä»Šå›ã®å®Ÿè£…ã§ã¯ã€ã‚‚ã¨ã‚‚ã¨ãƒˆãƒ¼ã‚¯ãƒ³é™ç•Œå†…ã ã£ãŸå±¥æ­´ãŒæ™‚é–“çµŒéã§è†¨ã‚Œä¸ŠãŒã£ãŸã‚±ãƒ¼ã‚¹ã‚’æƒ³å®šã—ã¦ã„ã‚‹ãŸã‚ã€ã“ã®ç‚¹ã¯å•é¡Œã«ãªã‚Šã¾ã›ã‚“ã€‚

## è¦ç´„ã®æ–¹é‡

è¦ç´„ã§æœ€ã‚‚é‡è¦ãªåŸå‰‡ã¯ã€ã€Œä½•ãŒåˆ†ã‹ã£ãŸã‹ï¼ˆçµæœãƒ»çŸ¥è¦‹ï¼‰ã€ã‚’æ®‹ã—ã€ã€Œã©ã†ã‚„ã£ã¦èª¿ã¹ãŸã‹ï¼ˆãƒ—ãƒ­ã‚»ã‚¹ï¼‰ã€ã‚’æ¨ã¦ã‚‹ã“ã¨ã§ã™ã€‚ã“ã®è¦³ç‚¹ã‹ã‚‰ã€ä½•ã‚’ä¿æŒã—ä½•ã‚’çœç•¥ã™ã¹ãã‹ã‚’è€ƒãˆã¾ã™ã€‚

å˜ã«ã€Œè¦ç´„ã—ã¦ã€ã¨ã ã‘æŒ‡ç¤ºã™ã‚‹ã¨ã€æ¼ ç„¶ã¨ã—ãŸã¾ã¨ã‚ã«ãªã£ãŸã‚Šã€é‡è¦ãªæƒ…å ±ãŒæ¬ å¦‚ã—ãŸã‚Šã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€ã©ã†ã„ã†æƒ…å ±ã‚’æ®‹ã™ã¹ãã‹ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã§æ˜ç¢ºã«æŒ‡ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®æ–¹é‡ã¯ã‚¿ã‚¹ã‚¯ã«ã‚ˆã£ã¦å¤§ããå¤‰ã‚ã‚‹ãŸã‚ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã”ã¨ã«èª¿æ•´ã™ã¹ãéƒ¨åˆ†ã§ã™ã€‚

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã‚’ä¸»ãªç›®çš„ã¨ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªæƒ…å ±ã‚’å„ªå…ˆçš„ã«ä¿æŒã™ã¹ãã§ã™ã€‚ã¾ãšæœ€ã‚‚é‡è¦ãªã®ã¯ã€ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰ã®æŒ‡ç¤ºã‚„è³ªå•ã€ãã—ã¦ä½•ã‚’ã‚´ãƒ¼ãƒ«ã«ã—ã¦ã„ã‚‹ã‹ã¨ã„ã†æƒ…å ±ã§ã™ã€‚ã“ã‚Œã‚‰ãŒå¤±ã‚ã‚Œã‚‹ã¨ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¡Œå‹•æŒ‡é‡ãã®ã‚‚ã®ãŒå¤±ã‚ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚æ¬¡ã«ã€åˆ†æã®éç¨‹ã§å¾—ã‚‰ã‚ŒãŸé‡è¦ãªçŸ¥è¦‹ã‚„æ”»æ’ƒã«é–¢ã™ã‚‹æƒ…å ±ã‚‚å¿…é ˆã§ã™ã€‚IOCï¼ˆIndicator of Compromise: ä¾µå®³æŒ‡æ¨™ï¼‰ã¯ç‰¹ã«é‡è¦ã§ã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‰ãƒ¡ã‚¤ãƒ³åã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚·ãƒ¥ã€URLãªã©ã¯ç¢ºå®Ÿã«ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã•ã‚‰ã«ã€é‡è¦åº¦ã‚„å½±éŸ¿åº¦ã®åˆ¤å®šã«åˆ©ç”¨ã§ããã†ãªè¨¼è·¡ã‚„ç—•è·¡ã€èª¿æŸ»ä½œæ¥­ã®é€²è¡ŒçŠ¶æ³ã‚„æ–‡è„ˆã€æ¬¡ä»¥é™ã®èª¿æŸ»ã«å¿…è¦ãã†ãªæ‰‹ãŒã‹ã‚Šã€ãƒã‚¯ã‚¹ãƒˆã‚¹ãƒ†ãƒƒãƒ—ãªã©ã‚‚ä¿æŒã™ã¹ãæƒ…å ±ã§ã™ã€‚ã“ã‚Œã‚‰ãŒã‚ã‚‹ã“ã¨ã§ã€èª¿æŸ»ã‚’ä¸­æ–­ã›ãšã«ç¶™ç¶šã§ãã¾ã™ã€‚

é€†ã«ã€çœç•¥ã—ã¦ã‚‚ã‚ˆã„æƒ…å ±ã‚‚ã‚ã‚Šã¾ã™ã€‚ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã®è©³ç´°ï¼ˆé–¢æ•°åã‚„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã©ï¼‰ã‚„ã€ãã®çµæœã®ç”Ÿãƒ‡ãƒ¼ã‚¿å…¨ä½“ã€ãƒ„ãƒ¼ãƒ«åˆ©ç”¨ãŒå¤±æ•—ã—ãŸå±¥æ­´ãªã©ã¯ã€æœ€çµ‚çš„ãªçµæœã«ã¯å½±éŸ¿ã—ãªã„ãŸã‚å‰Šé™¤ã§ãã¾ã™ã€‚èª¿æŸ»ã®éç¨‹ã§å¾—ã‚‰ã‚ŒãŸå†—é•·ãªæƒ…å ±ã‚„ã€èª¿æŸ»ã®éç¨‹ãã®ã‚‚ã®ï¼ˆæ‰‹ç¶šãã®è©³ç´°ï¼‰ã‚‚åŒæ§˜ã§ã™ã€‚

ã“ã†ã„ã£ãŸæŒ‡ç¤ºã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ä¸ãˆã‚‹ã“ã¨ã§ã€ç›®çš„ã«å¿œã˜ãŸé©åˆ‡ãªè¦ç´„ã‚’ç”Ÿæˆã§ãã¾ã™ã€‚

## è¦ç´„ã®ç¯„å›²

ä¼šè©±å±¥æ­´ã‚’è¦ç´„ã™ã‚‹éš›ã€ç¾çŠ¶ã®å±¥æ­´å…¨ä½“ã‚’è¦ç´„ã™ã‚‹ã¨ã„ã†é¸æŠè‚¢ã‚‚ã‚ã‚Šã¾ã™ãŒã€å¿…ãšã—ã‚‚ãã†ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚ˆã‚ŠåŠ¹æœçš„ãªæˆ¦ç•¥ã¨ã—ã¦ã€æ–°ã—ã„ä¼šè©±ã¯æ®‹ã—ã€å¤ã„éƒ¨åˆ†ã®ã¿ã‚’è¦ç´„ã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€è¦ç´„å¯¾è±¡ã¯å¤ã„æ–¹ã®70%ç¨‹åº¦ã«ã—ã¦ãŠãã€æ–°ã—ã„30%ã¯ãã®ã¾ã¾æ®‹ã™ã¨ã„ã†æ–¹é‡ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç›´è¿‘ã®æ–‡è„ˆãŒè¦ç´„ã«ã‚ˆã£ã¦å¤±ã‚ã‚Œã‚‹ã“ã¨ã‚’é˜²ã’ã¾ã™ã€‚ç‰¹ã«ã€æœ€è¿‘ã®ã‚„ã‚Šå–ã‚Šã«ã¯ç¾åœ¨é€²è¡Œä¸­ã®èª¿æŸ»ã«é–¢ã™ã‚‹é‡è¦ãªæƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå¤šã„ãŸã‚ã€ã“ã‚Œã‚’ãã®ã¾ã¾ä¿æŒã™ã‚‹ã“ã¨ã§èª¿æŸ»ã®ç¶™ç¶šæ€§ã‚’ä¿ã¡ã‚„ã™ããªã‚Šã¾ã™ã€‚

ã“ã®ã‚ãŸã‚Šã®å‹˜æ‰€ã¯ã‚¿ã‚¹ã‚¯ã«ã‚ˆã£ã¦å¤‰ã‚ã‚Šã¾ã™ã€‚å¯¾è©±ãŒçŸ­æœŸé–“ã§å®Œçµã™ã‚‹ã‚¿ã‚¹ã‚¯ã§ã‚ã‚Œã°ç›´è¿‘ã®å±¥æ­´ã®é‡è¦æ€§ãŒé«˜ã„ã§ã™ã—ã€é•·æœŸã«ã‚ãŸã‚‹èª¿æŸ»ã§ã‚ã‚Œã°åˆæœŸã®æƒ…å ±ã‚‚é‡è¦ã«ãªã‚Šã¾ã™ã€‚é‹ç”¨ã—ãªãŒã‚‰é©åˆ‡ãªæ¯”ç‡ã‚’è¦‹ã¤ã‘ã¦ã„ãã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚

## ã„ã¤è¦ç´„ã™ã‚‹ã‹

è¦ç´„ã‚’å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã¯ã€å¤§ããåˆ†ã‘ã¦2ã¤ã®æ–¹å¼ãŒã‚ã‚Šã¾ã™ã€‚

### äºˆé˜²çš„åœ§ç¸®ï¼ˆäº‹å‰ç›£è¦–æ–¹å¼ï¼‰

ä¸€ã¤ç›®ã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚µã‚¤ã‚ºã‚’ç›£è¦–ã—ãªãŒã‚‰ä¸€å®šå€¤ã‚’è¶…ãˆãŸã‚‰åœ§ç¸®ã™ã‚‹ã¨ã„ã†æ–¹å¼ã§ã™ã€‚ä¾‹ãˆã°ã€ãƒˆãƒ¼ã‚¯ãƒ³é™ç•Œã®80%ã«é”ã—ãŸã‚‰è¦ç´„ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã„ã£ãŸå…·åˆã§ã™ã€‚ã“ã®æ–¹å¼ã®åˆ©ç‚¹ã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³è¶…éã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å‰ã«å¯¾å‡¦ã§ãã‚‹ã“ã¨ã§ã™ã€‚

ãŸã ã—ã€æ­£ç¢ºãªãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’å–å¾—ã™ã‚‹ã«ã¯APIã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Geminiã®å ´åˆã€ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã®å–å¾—è‡ªä½“ã¯ç„¡æ–™ã§ã™ãŒã€æ¯å›ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹ã¨å¿œç­”æ™‚é–“ãŒåŠ£åŒ–ã—ã¾ã™ã€‚ã¾ãŸã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«ã‚‚æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚ã¾ãŸã€ãƒ¢ãƒ‡ãƒ«ã”ã¨ã«ãƒˆãƒ¼ã‚¯ãƒ³é™ç•ŒãŒç•°ãªã‚‹ãŸã‚ã€è¤‡æ•°ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã„åˆ†ã‘ã‚‹å ´åˆã¯ãã‚Œãã‚Œã®åˆ¶é™ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€å®Ÿè£…ãŒè¤‡é›‘ã«ãªã‚Šã¾ã™ã€‚ãƒã‚¤ãƒˆæ•°ã«ã‚ˆã‚‹è¿‘ä¼¼ã§ã‚ã‚Œã°ã€ãƒ¢ãƒ‡ãƒ«ã«ä¾å­˜ã—ãªã„å˜ç´”ãªå®Ÿè£…ã§æ¸ˆã¿ã¾ã™ã€‚

### ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–åœ§ç¸®ï¼ˆã‚¨ãƒ©ãƒ¼é§†å‹•æ–¹å¼ï¼‰

ã‚‚ã†ä¸€ã¤ã®æ–¹å¼ã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³è¶…éã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰ç™ºç«ã™ã‚‹ã¨ã„ã†æ–¹å¼ã§ã™ã€‚ä»Šå›ã®å®Ÿè£…ã§ã¯ã“ã¡ã‚‰ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚å®Ÿè£…ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã€ä¸è¦ãªç›£è¦–ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‰ãªã„ãŸã‚ã§ã™ã€‚

ãªãŠã€ä»Šå›ã®å®Ÿè£…ã§ã¯æ–‡è„ˆã‚’å¯èƒ½ãªé™ã‚Šç¶­æŒã™ã‚‹ãŸã‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã¾ã§åœ§ç¸®ã‚’è¡Œã‚ãªã„æ–¹å¼ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ãŒã€ã‚³ã‚¹ãƒˆå‰Šæ¸›ã‚’å„ªå…ˆã™ã‚‹å ´åˆã¯ã‚‚ã£ã¨æ—©ã„æ®µéšã§è¦ç´„ã‚’å®Ÿè¡Œã—ã¦ã‚‚ã‚ˆã„ã§ã—ã‚‡ã†ã€‚GenerateContentã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯ç¾åœ¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ï¼ˆ`UsageMetadata`ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã®æƒ…å ±ã‚’åˆ©ç”¨ã—ã¦ä¸€å®šã®å‰²åˆï¼ˆä¾‹ãˆã°é™ç•Œã®60-70%ï¼‰ã«é”ã—ãŸã‚‰äºˆé˜²çš„ã«åœ§ç¸®ã™ã‚‹å®Ÿè£…ã‚‚å¯èƒ½ã§ã™ã€‚æ–‡è„ˆã®ç¶­æŒã¨ã‚³ã‚¹ãƒˆã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®ã—ã¦ã€è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«åˆã£ãŸæˆ¦ç•¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚

ä¸¡æ–¹å¼ã®æ¯”è¼ƒã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

| æ–¹å¼ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|------|---------|-----------|
| äºˆé˜²çš„åœ§ç¸® | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿå‰ã«å¯¾å‡¦ã§ãã‚‹ | ãƒˆãƒ¼ã‚¯ãƒ³æ•°å–å¾—ã®ã‚³ã‚¹ãƒˆã€é–¾å€¤è¨­å®šã®é›£ã—ã• |
| ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–åœ§ç¸® | å®Ÿè£…ãŒã‚·ãƒ³ãƒ—ãƒ«ã€ä¸è¦ãªç›£è¦–ã‚³ã‚¹ãƒˆãªã— | ä¸€åº¦ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€ãƒªãƒˆãƒ©ã‚¤ãŒå¿…è¦ |

Geminiã®å ´åˆã€ãƒˆãƒ¼ã‚¯ãƒ³è¶…éã‚¨ãƒ©ãƒ¼ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è¿”ã•ã‚Œã¾ã™ã€‚

```bash
% cd examples/too-large-request
% env GEMINI_PROJECT=your-project go run .
APIError - Code:400 Status:INVALID_ARGUMENT Message:The input token count (2500030) exceeds the maximum number of tokens allowed (1048576). Details:[]
```

ã“ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œçŸ¥ã—ã¦è¦ç´„å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`examples/too-large-request/main.go` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€å®Ÿéš›ã«ã“ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã§ãã¾ã™ã€‚

ãŸã ã—æ³¨æ„ç‚¹ã¨ã—ã¦ã€APIå´ã®æŒ™å‹•ãŒå¤‰ã‚ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå¤‰æ›´ã•ã‚Œã‚‹ï¼‰å ´åˆãªã©ã«å½±éŸ¿ã‚’å—ã‘ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚AIé–¢é€£ã®ãƒ„ãƒ¼ãƒ«ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã¯ã“ã†ã„ã£ãŸä»•æ§˜ã®æ›´æ–°ãŒé »ç¹ã«è¡Œã‚ã‚Œã‚‹ãŸã‚ã€å®Ÿè£…ãŒä¸å®‰å®šã«ãªã‚Šã‚„ã™ã„é¢ãŒã‚ã‚Šã¾ã™ã€‚é‡è¦ãªã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ†ã‚¹ãƒˆã‚’å®šæœŸçš„ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€`isTokenLimitError` é–¢æ•°ãŒå®Ÿéš›ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ­£ã—ãæ¤œçŸ¥ã§ãã‚‹ã‹ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’ç”¨æ„ã—ã€APIä»•æ§˜å¤‰æ›´ã®å½±éŸ¿ã‚’æ—©æœŸã«æ¤œå‡ºã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚

# å®Ÿè£…ä¾‹

ãã‚Œã§ã¯ã€å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚å…¨ä½“ã®æµã‚Œã¨ã—ã¦ã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³è¶…éã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã—ãŸã‚‰è¦ç´„ã‚’å®Ÿè¡Œã—ã€åœ§ç¸®ã•ã‚ŒãŸå±¥æ­´ã§ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹ã¨ã„ã†ä»•çµ„ã¿ã§ã™ã€‚

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯

ã¾ãšã€ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªãƒˆãƒ©ã‚¤ã®ãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‚`pkg/usecase/chat/session.go` ã® `Send` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå‡¦ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

```go:pkg/usecase/chat/session.go
resp, err := s.gemini.GenerateContent(ctx, s.history.Contents, config)
if err != nil {
    // Check if error is due to token limit exceeded
    if isTokenLimitError(err) {
        // Attempt compression
        fmt.Println("\nğŸ“¦ Token limit exceeded. Compressing conversation history...")

        compressedContents, compressErr := compressHistory(ctx, s.gemini, s.history.Contents)
        if compressErr != nil {
            return nil, goerr.Wrap(compressErr, "failed to compress history")
        }

        // Update history with compressed contents
        s.history.Contents = compressedContents

        // Save compressed history immediately
        if saveErr := saveHistory(ctx, s.repo, s.storage, s.alertID, s.history); saveErr != nil {
            fmt.Printf("âš ï¸  Warning: failed to save compressed history: %v\n", saveErr)
        }

        fmt.Println("âœ… Conversation history compressed successfully. Retrying...")
        continue // Retry with compressed history
    }
    return nil, goerr.Wrap(err, "failed to generate content")
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€å…ˆè¿°ã—ãŸé€šã‚Šã‚·ãƒ³ãƒ—ãƒ«ã«ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã¨ãã«è¦ç´„ã‚’è©¦ã¿ã¦ã„ã¾ã™ã€‚`isTokenLimitError` é–¢æ•°ã§ãƒˆãƒ¼ã‚¯ãƒ³è¶…éã‚¨ãƒ©ãƒ¼ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã€è©²å½“ã™ã‚‹å ´åˆã¯ `compressHistory` é–¢æ•°ã§å±¥æ­´ã‚’åœ§ç¸®ã—ã¾ã™ã€‚åœ§ç¸®ã•ã‚ŒãŸå±¥æ­´ã§ `s.history.Contents` ã‚’å·®ã—æ›¿ãˆã€`continue` ã§ãƒ«ãƒ¼ãƒ—ã®å…ˆé ­ã«æˆ»ã‚‹ã“ã¨ã§ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™ã€‚ãƒˆãƒ¼ã‚¯ãƒ³è¶…éã‚¨ãƒ©ãƒ¼ã§ãªã‘ã‚Œã°ã€ãã®ã¾ã¾ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã™ã€‚

é‡è¦ãªç‚¹ã¨ã—ã¦ã€è¦ç´„å¾Œã¯å³åº§ã« `saveHistory` ã§å±¥æ­´ã‚’æ°¸ç¶šåŒ–ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ¬¡å›ä»¥é™ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã‚‚åœ§ç¸®å¾Œã®çŠ¶æ…‹ã‹ã‚‰å†é–‹ã§ãã¾ã™ã€‚åœ§ç¸®å‡¦ç†ã¯ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹ãŸã‚ã€ä¸€åº¦åœ§ç¸®ã—ãŸã‚‚ã®ã¯ä¿å­˜ã—ã¦ãŠãã“ã¨ã§ã€ç„¡é§„ãªå†åœ§ç¸®ã‚’é¿ã‘ã‚‰ã‚Œã¾ã™ã€‚

## å±¥æ­´ã®ç¯„å›²è¨ˆç®—

æ¬¡ã«ã€`compressHistory` é–¢æ•°ã®ä¸­èº«ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ã¾ãšæœ€åˆã«è¡Œã†ã®ãŒã€è¦ç´„å¯¾è±¡ã¨ãªã‚‹å±¥æ­´éƒ¨åˆ†ã®æŠ½å‡ºã§ã™ã€‚`pkg/usecase/chat/compress.go` ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ç¯„å›²ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚

```go:pkg/usecase/chat/compress.go
	// Calculate byte size for each content
	totalBytes := 0
	byteSizes := make([]int, len(contents))
	for i, content := range contents {
		size := contentSize(content)
		byteSizes[i] = size
		totalBytes += size
	}

	// Calculate compression threshold (70% of total bytes)
	compressThreshold := int(float64(totalBytes) * compressionRatio)

	// Find the index where we cross the 70% threshold
	cumulativeBytes := 0
	compressIndex := 0
	for i, size := range byteSizes {
		cumulativeBytes += size
		if cumulativeBytes >= compressThreshold {
			compressIndex = i + 1 // Include this message in compression
			break
		}
	}

	// If compression index is 0 or at the end, nothing to compress
	if compressIndex == 0 || compressIndex >= len(contents) {
		return nil, goerr.New("insufficient content to compress")
	}
```

ã“ã“ã§ã¯å¯¾è±¡ã‚’ãƒã‚¤ãƒˆæ•°ã§è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚`contentSize` é–¢æ•°ã¯ã€å„ `Content` ã‚’ JSON ã«ãƒãƒ¼ã‚·ãƒ£ãƒ«ã—ã¦ãƒã‚¤ãƒˆæ•°ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã§ã™ã€‚

```go:pkg/usecase/chat/compress.go
// contentSize calculates the byte size of a content by JSON marshaling
func contentSize(content *genai.Content) int {
	data, err := json.Marshal(content)
	if err != nil {
		return 0
	}
	return len(data)
}
```

ã“ã®é–¢æ•°ã¯ã€ãƒ†ã‚­ã‚¹ãƒˆã ã‘ã§ãªããƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã®æƒ…å ±ãªã©ã‚‚å«ã‚ãŸæ­£ç¢ºãªã‚µã‚¤ã‚ºã‚’æ¸¬å®šã§ãã¾ã™ã€‚

æœ¬æ¥ã§ã‚ã‚Œã°ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã§è¨ˆç®—ã™ã¹ãã§ã™ãŒã€éƒ½åº¦APIã§ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’å•ã„åˆã‚ã›ã¦ã„ã‚‹ã¨é…å»¶ãŒç™ºç”Ÿã—ã¾ã™ã—ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«å¼•ã£ã‹ã‹ã‚‹æã‚Œã‚‚ã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€å¤šå°‘ç²—ãã¦ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã§è¨ˆç®—ã§ãã‚‹ãƒã‚¤ãƒˆæ•°ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

ãƒã‚¤ãƒˆæ•°ã¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã«ã¯ç›¸é–¢ãŒã‚ã‚‹ãŸã‚ã€å®Œå…¨ã«æ­£ç¢ºã§ãªãã¦ã‚‚åœ§ç¸®ã®ç›®çš„ã¯é”æˆã§ãã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰å†…ã® `compressionRatio` ã¯ 0.7 ã«è¨­å®šã•ã‚Œã¦ãŠã‚Šã€å…¨ä½“ã®70%ã®ãƒã‚¤ãƒˆæ•°ã«é”ã™ã‚‹ã¾ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦ç´„å¯¾è±¡ã¨ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ–°ã—ã„30%ã®å±¥æ­´ã¯ãã®ã¾ã¾ä¿æŒã•ã‚Œã¾ã™ã€‚

## è¦ç´„ã®å®Ÿè¡Œã¨å±¥æ­´ã®å†æ§‹ç¯‰

ç¯„å›²è¨ˆç®—ãŒçµ‚ã‚ã£ãŸã‚‰ã€å®Ÿéš›ã«è¦ç´„ã‚’å®Ÿè¡Œã—ã¦æ–°ã—ã„å±¥æ­´ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

```go:pkg/usecase/chat/compress.go
	// Extract contents to compress and to keep
	toCompress := contents[:compressIndex]
	toKeep := contents[compressIndex:]

	// Generate summary of compressed contents
	summary, err := summarizeContents(ctx, gemini, toCompress)
	if err != nil {
		return nil, goerr.Wrap(err, "failed to summarize contents")
	}

	// Create summary content as user message
	summaryContent := &genai.Content{
		Role: genai.RoleUser,
		Parts: []*genai.Part{
			{Text: "=== Previous Conversation Summary ===\n\n" + summary},
		},
	}

	// Return new history: summary + kept contents
	newContents := append([]*genai.Content{summaryContent}, toKeep...)
	return newContents, nil
}
```

ã¾ãšã€è¨ˆç®—ã—ãŸ `compressIndex` ã‚’ä½¿ã£ã¦å±¥æ­´ã‚’2ã¤ã«åˆ†å‰²ã—ã¾ã™ã€‚`toCompress` ãŒè¦ç´„å¯¾è±¡ã®å¤ã„å±¥æ­´ã€`toKeep` ãŒãã®ã¾ã¾ä¿æŒã™ã‚‹æ–°ã—ã„å±¥æ­´ã§ã™ã€‚

æ¬¡ã«ã€`summarizeContents` é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦è¦ç´„ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã®é–¢æ•°ã¯ã€è¦ç´„å¯¾è±¡ã®å±¥æ­´ã«è¦ç´„ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå¾Œè¿°ï¼‰ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦è¿½åŠ ã—ã€LLMã«æŠ•ã’ã¦è¦ç´„ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚

è¦ç´„çµæœã¯æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦å±¥æ­´ã®å…ˆé ­ã«æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚`Role` ã‚’ `genai.RoleUser` ã«è¨­å®šã—ã€ãƒ†ã‚­ã‚¹ãƒˆã®å†’é ­ã« `=== Previous Conversation Summary ===` ã¨ã„ã†ãƒãƒ¼ã‚«ãƒ¼ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§ã€LLMãŒã€Œã“ã‚Œã¯éå»ã®ä¼šè©±ã®è¦ç´„ã§ã‚ã‚‹ã€ã¨èªè­˜ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚æœ€å¾Œã«ã€è¦ç´„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ä¿æŒã™ã‚‹å±¥æ­´ã‚’çµåˆã—ã¦è¿”ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å…ƒã®å±¥æ­´ã‚ˆã‚Šã‚‚å¤§å¹…ã«å°ã•ã„æ–°ã—ã„å±¥æ­´ãŒæ§‹ç¯‰ã•ã‚Œã€ãƒˆãƒ¼ã‚¯ãƒ³é™ç•Œã‚’å›é¿ã§ãã¾ã™ã€‚

## è¦ç´„ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

æœ€å¾Œã«ã€è¦ç´„ã‚’ç”Ÿæˆã™ã‚‹éš›ã«ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã™ã€‚`pkg/usecase/chat/prompt/summarize.md` ã«ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚

```markdown:pkg/usecase/chat/prompt/summarize.md
You are an assistant for security alert analysis.

## Context and Purpose

The conversation history has exceeded the token limit. Create a summary that will replace the older parts of the conversation, preserving all critical information needed to continue the security investigation.

This summary will be inserted at the beginning of the conversation history. Focus on what matters for ongoing analysis, not the investigation process itself.

## What to Preserve (Highest Priority)

**1. User's Intent and Goals (MOST CRITICAL)**
- User's questions and what they want to know
- Investigation goals and what conclusion the user seeks
- Explicit instructions or constraints the user has given
- User's concerns or areas of focus

**2. Attack and Security Intelligence**
- Key findings about the incident (malicious/benign/false positive)
- Attack patterns, techniques, TTPs identified
- IOCs: IP addresses, domains, file hashes, URLs, email addresses, usernames
- Evidence supporting severity/impact assessment
- Timeline of the attack or suspicious activities

**3. Investigation Progress and Context**
- Current state of the investigation
- Important insights or discoveries from the analysis
- Clues or leads for next steps
- What has been verified vs. what remains uncertain

**4. Next Steps and Actions**
- Recommended next steps in the investigation
- Decisions requiring user input
- Outstanding questions that need answers

## What to Deprioritize or Omit (Lowest Priority)

**Do NOT include:**
- Tool call details (function names, parameters, how they were invoked)
- Full tool output or raw data dumps
- Failed tool calls or error messages
- Exploratory queries that yielded no useful information
- The investigation process itself (step-by-step procedures)
- Redundant or repeated information
- Assistant's internal reasoning or thought process

**Remember:** Summarize RESULTS and FINDINGS, not the PROCESS of obtaining them.

## Output Format

Format the summary in markdown:

- **User's Goals**: What the user wants to achieve or understand
- **Investigation Status**: Current understanding of the incident
- **Key Findings**: Critical security conclusions and determinations
- **Attack Intelligence**: IOCs, TTPs, timeline, attack patterns
- **Evidence**: Important facts supporting severity/impact assessment
- **Next Steps**: What to investigate next or decisions needed
- **Open Questions**: Unresolved issues requiring attention

Be extremely concise. One sentence per point is ideal. Preserve facts, not explanations.
```

ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã€å…ˆã»ã©èª¬æ˜ã—ãŸè¦ç´„ã®æ–¹é‡ã‚’å…·ä½“çš„ã«æŒ‡ç¤ºã—ãŸã‚‚ã®ã§ã™ã€‚ã‚ãã¾ã§ä¸€ä¾‹ã§ã‚ã‚Šã€å®Ÿéš›ã®é‹ç”¨ã«åˆã‚ã›ã¦èª¿æ•´ã§ãã¾ã™ã€‚

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã¯ã€Œä½•ã‚’æ®‹ã™ã‹ã€ã€Œä½•ã‚’æ¨ã¦ã‚‹ã‹ã€ã‚’æ˜ç¢ºã«æŒ‡ç¤ºã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ç‰¹ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã§ã¯ã€IOCã‚„æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³ãªã©ã®é‡è¦æƒ…å ±ã‚’ç¢ºå®Ÿã«ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¸€æ–¹ã§ã€ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã®è©³ç´°ã‚„èª¿æŸ»ãƒ—ãƒ­ã‚»ã‚¹ã¯çœç•¥å¯èƒ½ã§ã™ã€‚ã€ŒRESULTS and FINDINGS, not the PROCESSã€ã¨ã„ã†åŸå‰‡ã‚’æ˜è¨˜ã™ã‚‹ã“ã¨ã§ã€LLMã«é©åˆ‡ãªè¦ç´„ã‚’ç”Ÿæˆã•ã›ã‚‰ã‚Œã¾ã™ã€‚

ã¾ãŸã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€è¦ç´„çµæœã®æ§‹é€ ã‚’ä¸€å®šã«ä¿ã¤ã“ã¨ãŒã§ãã¾ã™ã€‚æ§‹é€ åŒ–ã•ã‚ŒãŸè¦ç´„ã¯ã€å¾Œç¶šã®å‡¦ç†ã§ã‚‚æ‰±ã„ã‚„ã™ããªã‚Šã¾ã™ã€‚å„é …ç›®ã‚’1æ–‡ã§ç°¡æ½”ã«è¨˜è¿°ã™ã‚‹ã‚ˆã†æŒ‡ç¤ºã—ã¦ã„ã‚‹ã®ã‚‚ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚å†—é•·ãªèª¬æ˜ã‚’é¿ã‘ã€äº‹å®Ÿã®ã¿ã‚’ä¿æŒã™ã‚‹ã“ã¨ã§ã€è¦ç´„å¾Œã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’æœ€å°é™ã«æŠ‘ãˆã‚‰ã‚Œã¾ã™ã€‚

ã“ã®ã‚ãŸã‚Šã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã€å®Ÿéš›ã«å‹•ã‹ã—ã¦ã¿ãªãŒã‚‰èª¿æ•´ã—ã¦ã„ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æœ€åˆã‹ã‚‰å®Œç’§ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œã‚‹ã“ã¨ã¯é›£ã—ã„ãŸã‚ã€å®Ÿé‹ç”¨ã§ã®è¦ç´„çµæœã‚’è¦³å¯Ÿã—ãªãŒã‚‰æ”¹å–„ã—ã¦ã„ãã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚

# ã¾ã¨ã‚

æœ¬è¨˜äº‹ã§ã¯ã€LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ãŠã‘ã‚‹ä¼šè©±ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åœ§ç¸®æˆ¦ç•¥ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã—ãŸã€‚

ä¼šè©±å±¥æ­´ã®åœ§ç¸®ã§æœ€ã‚‚é‡è¦ãªã®ã¯ã€ã€Œä½•ã‚’æ®‹ã—ã€ä½•ã‚’æ¨ã¦ã‚‹ã‹ã€ã‚’æ˜ç¢ºã«å®šç¾©ã™ã‚‹ã“ã¨ã§ã™ã€‚LLMã«ã‚ˆã‚‹è¦ç´„ã§é‡è¦ãªæƒ…å ±ã®ã¿ã‚’æŠ½å‡ºã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ–‡è„ˆç†è§£ã‚’ä¿ã¡ãªãŒã‚‰ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚æœ¬è¨˜äº‹ã§ç´¹ä»‹ã—ãŸè¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã«ç‰¹åŒ–ã—ãŸã‚‚ã®ã§ã™ãŒã€è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«åˆã‚ã›ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ãã ã•ã„ã€‚

è¦ç´„ã«ã‚ˆã‚‹æƒ…å ±æ¬ è½ã¯é¿ã‘ã‚‰ã‚Œãªã„ãŸã‚ã€å¯èƒ½ãªé™ã‚Šè¦ç´„ã‚’ç™ºç”Ÿã•ã›ãªã„è¨­è¨ˆï¼ˆãƒ„ãƒ¼ãƒ«å®Ÿè¡Œçµæœã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãªã©ï¼‰ã‚‚ä½µã›ã¦æ¤œè¨ã™ã‚‹ã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­è¨ˆå…¨ä½“ã§è€ƒãˆã‚‹ã¹ãèª²é¡Œã§ã‚ã‚Šã€ä»Šå¾Œã®è¨˜äº‹ã§ã‚‚ã“ã®è¦³ç‚¹ã‚’æ„è­˜ã—ãªãŒã‚‰æ©Ÿèƒ½æ‹¡å¼µã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚
