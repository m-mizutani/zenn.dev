---
title: "Goã§ä½œã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æLLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ(11): ã‚ˆã‚Šå®Ÿè·µçš„ãªãƒ„ãƒ¼ãƒ«ã®å®Ÿè£…ï¼šBigQueryã‹ã‚‰ã®ãƒ­ã‚°å–å¾—"
emoji: "ğŸ—„ï¸"
type: "tech"
topics: ["ai", "go", "llm", "agent"]
published: true
---

ã“ã®è¨˜äº‹ã¯ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€Œ[Goã§ä½œã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æLLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ](https://adventar.org/calendars/11354)ã€ã®11æ—¥ç›®ã§ã™ã€‚ã“ã“ã¾ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªAPIå•ã„åˆã‚ã›ã®ãƒ„ãƒ¼ãƒ«ã‚„å¤–éƒ¨ã¨æ¥ç¶šã§ãã‚‹MCPï¼ˆModel Context Protocolï¼‰ã«ã¤ã„ã¦è§£èª¬ã—ã¦ãã¾ã—ãŸãŒã€ä»Šå›ã¯ã‚ˆã‚Šå®Ÿè·µçš„ã‹ã¤è¤‡é›‘ãªãƒ„ãƒ¼ãƒ«ã®å®Ÿè£…ã‚’ã—ã¦ã¿ã¾ã™ã€‚é¡Œæã¨ã—ã¦ã€Google Cloudã®BigQueryã‹ã‚‰ãƒ­ã‚°ã‚’æ¤œç´¢ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’ã¨ã‚Šã‚ã’ã¾ã™ã€‚

ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯ https://github.com/m-mizutani/leveret ã® [day11-db-query-tool](https://github.com/m-mizutani/leveret/tree/day11-db-query-tool) ãƒ–ãƒ©ãƒ³ãƒã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã®ã§é©å®œå‚ç…§ã—ã¦ãã ã•ã„ã€‚

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ã«ãŠã‘ã‚‹BigQueryã®åˆ©ç”¨

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ã«ãŠã„ã¦ãƒ­ã‚°ã®æ¤œç´¢ãƒ»é›†è¨ˆæ©Ÿèƒ½ã¯ä¸­æ ¸çš„ãªå½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚ãƒ­ã‚°ã‚’æ´»ç”¨ã™ã‚‹å ´é¢ã¯å¤§ãã3ã¤ã«åˆ†ã‘ã‚‰ã‚Œã¾ã™ã€‚ã¾ãšæ¤œçŸ¥ã§ã¯ã€ãƒ­ã‚°ã‚’é›†è¨ˆã—ã¦ç‰¹å®šã®äº‹è±¡ã‚„ä¸å¯©ãªäº‹è±¡ã‚’è¦‹ã¤ã‘å‡ºã—ã¾ã™ã€‚æ¬¡ã«èª¿æŸ»ã§ã¯ã€ä½•ã‚‰ã‹ã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸéš›ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°ã‚’èª¿æŸ»ã™ã‚‹ã“ã¨ã§ã€äº‹å®Ÿã®æ¤œè¨¼ã€åŸå› ã®ç©¶æ˜ã€å½±éŸ¿ç¯„å›²ã®ç¢ºèªãªã©ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚ã•ã‚‰ã«è„…å¨ãƒãƒ³ãƒ†ã‚£ãƒ³ã‚°ã®ã‚ˆã†ã«ã€èƒ½å‹•çš„ã«ç•°å¸¸ã‚’æ¢ç´¢ã™ã‚‹æ´»å‹•ã«ã‚‚ãƒ­ã‚°ã¯æ¬ ã‹ã›ã¾ã›ã‚“ã€‚

ãƒ­ã‚°ã®ä¿å­˜å…ˆã¨ã—ã¦ã¯æ§˜ã€…ãªé¸æŠè‚¢ãŒã‚ã‚Šã¾ã™ãŒã€BigQueryã¯ç¾å®Ÿçš„ãªæœ€é©è§£ã®ä¸€ã¤ã¨ã„ãˆã¾ã™ã€‚SIEMï¼ˆSecurity Information Event Managerï¼‰ãªã©ã®å°‚ç”¨ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ­ã‚°ã‚’ä¿ç®¡ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ã‚³ã‚¹ãƒˆãŒé«˜é¡ã«ãªã‚ŠãŒã¡ã§ã™ã€‚ä¸€æ–¹ã§BigQueryã¯ã€é‹ç”¨ã‚’è‡ªã‚‰è¡Œã†å¿…è¦ãŒã‚ã‚‹ä»£ã‚ã‚Šã«ã€ãƒ­ã‚°ã®æŠ•å…¥ã‚³ã‚¹ãƒˆã¨ç¶­æŒã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆã‚‰ã‚Œã¾ã™ã€‚ç‰¹ã«ã‚¯ã‚¨ãƒªå®Ÿè¡Œé‡ã«å¿œã˜ãŸèª²é‡‘ãŒä¸­å¿ƒã¨ãªã‚‹ãŸã‚ã€ãƒ­ã‚°ã‚’å¤§é‡ã«ä¿å­˜ã—ãªãŒã‚‰ã‚‚ã‚³ã‚¹ãƒˆã‚’ç®¡ç†ã—ã‚„ã™ã„ç‚¹ãŒé‹ç”¨ä¸Šã®åˆ©ç‚¹ã¨ãªã‚Šã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€ã“ã®BigQueryã«å¯¾ã—ã¦ãƒ­ã‚°ã‚’æ¤œç´¢ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’é¡Œæã¨ã—ã¦ã€ã‚ˆã‚Šå®Ÿè·µçš„ã§è¤‡é›‘ãªãƒ„ãƒ¼ãƒ«ã®å®Ÿè£…æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚BigQueryãƒ„ãƒ¼ãƒ«ã¯ã€å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„ã€è¤‡é›‘ãªã‚¹ã‚­ãƒ¼ãƒã€ã‚³ã‚¹ãƒˆåˆ¶å¾¡ãªã©ã€å®Ÿç”¨çš„ãªãƒ„ãƒ¼ãƒ«å®Ÿè£…ã§ç›´é¢ã™ã‚‹èª²é¡Œã‚’å¤šãå«ã‚“ã§ã„ã‚‹ãŸã‚ã€å­¦ç¿’é¡Œæã¨ã—ã¦é©ã—ã¦ã„ã¾ã™ã€‚

# ãƒ„ãƒ¼ãƒ«è¨­è¨ˆã«ãŠã„ã¦é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

BigQueryãƒ„ãƒ¼ãƒ«ã®å…·ä½“çš„ãªå®Ÿè£…ã«å…¥ã‚‹å‰ã«ã€ç”ŸæˆAIã‚’æ´»ç”¨ã—ãŸãƒ„ãƒ¼ãƒ«è¨­è¨ˆã«ãŠã‘ã‚‹ä¸€èˆ¬çš„ãªèª²é¡Œã«ã¤ã„ã¦æ•´ç†ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®èª²é¡Œã¯ã€BigQueryã«é™ã‚‰ãšä»–ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹ãƒ„ãƒ¼ãƒ«å®Ÿè£…ã§ã‚‚å…±é€šã™ã‚‹é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

## ã€ŒçŸ¥ã‚‰ãªã„ãƒ¢ãƒã¯æ¢ã•ãªã„ã€

ç”ŸæˆAIã‚’æ´»ç”¨ã—ãŸãƒ„ãƒ¼ãƒ«è¨­è¨ˆã§ã¯ã€ãƒ„ãƒ¼ãƒ«ãŒæƒ…å ±ã‚’å–å¾—ã§ãã‚‹ã“ã¨ã¨ã€LLMãŒãã®æƒ…å ±ã®å­˜åœ¨ã‚’èªè­˜ã™ã‚‹ã“ã¨ã¯åˆ¥ã®å•é¡Œã§ã™ã€‚ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã£ã¦å–å¾—å¯èƒ½ãªæƒ…å ±ãŒã‚ã£ãŸã¨ã—ã¦ã‚‚ã€ç”ŸæˆAIå´ãŒä½•ãŒå–å¾—ã§ãã‚‹ã®ã‹ã‚’çŸ¥ã‚‰ãªã‘ã‚Œã°ã€ãã‚‚ãã‚‚æ¢ç´¢è¡Œå‹•ã‚’é–‹å§‹ã—ã¾ã›ã‚“ã€‚ä¾‹ãˆã°ã€BigQueryã«10å€‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¦ã„ã¦ã‚‚ã€LLMãŒãã®ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’çŸ¥ã‚‰ãªã‘ã‚Œã°ã€ã€Œã©ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’èª¿ã¹ã‚Œã°ã‚ˆã„ã‹ã€ã¨ã„ã†åˆ¤æ–­ãŒã§ããšã€çµæœã¨ã—ã¦ãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã•ãªã„ã¾ã¾è«¦ã‚ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

ã•ã‚‰ã«ã€Œæ¢ã›ã°ã‚ã‹ã‚‹ã€çŠ¶æ³ã§ã‚ã£ã¦ã‚‚ã€LLMãŒæ¢ç´¢ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–ã‚‰ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ç‰¹ã«è¡Œå‹•å›æ•°ã‚’çŸ­ç¸®ã•ã›ã‚ˆã†ã¨ã™ã‚‹å ´åˆã«é¡•è‘—ã§ã™ã€‚ã‚³ã‚¹ãƒˆã‚„å¿œç­”é€Ÿåº¦ã®è¦³ç‚¹ã‹ã‚‰è¡Œå‹•å›æ•°ã®å‰Šæ¸›ã‚’å›³ã‚‹ã“ã¨ã¯ä¸€èˆ¬çš„ã§ã™ãŒã€ãã®çµæœã¨ã—ã¦å¿…è¦ãªæƒ…å ±åé›†ãŒè¡Œã‚ã‚Œãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€LLMã«å¯¾ã—ã¦é©åˆ‡ã«æƒ…å ±ã‚’ä¼æ’­ã•ã›ã‚‹ä»•çµ„ã¿ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ»ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®é™ç•Œ

ã“ã‚Œã¾ã§ç¹°ã‚Šè¿”ã—è¿°ã¹ã¦ããŸé€šã‚Šã€LLMã‚’ã¯ã˜ã‚ã¨ã™ã‚‹LLMã«ã¯å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã®é™ç•Œã€ã™ãªã‚ã¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒå­˜åœ¨ã—ã¾ã™ã€‚ã“ã®åˆ¶é™ã‚’è¶…ãˆã‚‹ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãƒ¢ãƒ‡ãƒ«ãŒæ­£å¸¸ã«å‹•ä½œã—ãªããªã‚Šã¾ã™ã€‚å›é¿ã™ã‚‹æ–¹æ³•ã‚‚å­˜åœ¨ã—ã¾ã™ãŒã€ãã‚‚ãã‚‚ä¸å¿…è¦ã«å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ãªã„ã“ã¨ãŒåŸºæœ¬çš„ã‹ã¤é‡è¦ãªè¨­è¨ˆåŸå‰‡ã¨ãªã‚Šã¾ã™ã€‚

## åˆ¶å¾¡ã®å•é¡Œ

LLMã«å¯¾ã—ã¦ã€Œã€œã‚’ã™ã‚‹ãªã€ã€Œã€œã¨ã„ã†ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚Œã€ã¨ã„ã£ãŸæŒ‡ç¤ºã‚’å‡ºã—ã¦ã‚‚ã€éµå®ˆã•ã‚Œã‚‹å ´åˆã¨ãã†ã§ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ç”ŸæˆAIã®ç¢ºç‡çš„ãªæ€§è³ªã«èµ·å› ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

åŠ ãˆã¦ã€LLMãŒæƒ…å ±ã‚’ã€Œå¿˜ã‚Œã‚‹ã€ã¨ã„ã†ç¾è±¡ã‚‚ç™ºç”Ÿã—ã¾ã™ã€‚ã“ã‚Œã¯å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒä»–ã®æƒ…å ±ã«åŸ‹ã‚‚ã‚Œã¦ã—ã¾ã£ãŸã‚Šã€é€”ä¸­ã§æ–‡è„ˆã‚’æ•´ç†ã™ã‚‹éç¨‹ã§æƒ…å ±ãŒå¤±ã‚ã‚ŒãŸã‚Šã™ã‚‹ã“ã¨ã§èµ·ã“ã‚Šã¾ã™ã€‚ç‰¹ã«é•·ã„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä¸­é–“éƒ¨åˆ†ã«é…ç½®ã•ã‚ŒãŸæƒ…å ±ã¯å¿˜ã‚Œã‚‰ã‚Œã‚„ã™ã„ã“ã¨ãŒçŸ¥ã‚‰ã‚Œã¦ãŠã‚Šã€ã“ã®ç¾è±¡ã¯ Lost in the Middle[^lost-in-middle] ã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚ä¾‹ãˆã°ã€å¤§é‡ã®ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’ä¼šè©±ã®é€”ä¸­ã§æä¾›ã—ã¦ã‚‚ã€LLMãŒæœ€åˆã‚„æœ€å¾Œã®æ–¹ã®æƒ…å ±ã—ã‹èªè­˜ã›ãšã€ä¸­é–“ã«é…ç½®ã•ã‚ŒãŸé‡è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æƒ…å ±ã‚’è¦‹é€ƒã—ã¦ã—ã¾ã†ã¨ã„ã£ãŸã“ã¨ãŒèµ·ã“ã‚Šå¾—ã¾ã™ã€‚

ã“ã®ã‚ˆã†ãªç”ŸæˆAIã®ç‰¹æ€§ã‚’è¸ã¾ãˆã‚‹ã¨ã€ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªåˆ¶å¾¡ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚ˆã‚‹æŒ‡ç¤ºã«ä¾å­˜ã›ãšã€ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ„ãƒ¼ãƒ«å®Ÿè£…ï¼‰å´ã§ç¢ºå®Ÿã«å®Ÿæ–½ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

# BigQueryãƒ„ãƒ¼ãƒ«ã®è¦ä»¶

BigQueryã«å¯¾ã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’è€ƒãˆã‚‹ã¨ãã€ã€Œã‚¯ã‚¨ãƒªã‚’ç™ºè¡Œã—ã¦ãã®çµæœã‚’LLMã«è¿”ã™ã ã‘ã€ã¨ã„ã†ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ ã‚’æƒ³å®šã—ãŒã¡ã§ã™ã€‚ç¢ºã‹ã«å°è¦æ¨¡ãªãƒ‡ãƒ¼ã‚¿ã‹ã¤ã‚·ãƒ³ãƒ—ãƒ«ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¹ã‚­ãƒ¼ãƒã§ã‚ã‚Œã°ã€ã“ã®å˜ç´”ãªå®Ÿè£…ã§ã‚‚æ©Ÿèƒ½ã™ã‚‹ã‚±ãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã™ã€‚

ã—ã‹ã—ç¾å®Ÿã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ç’°å¢ƒã§ã¯ã€ãƒ­ã‚°ã¯å¤§é‡ã«å­˜åœ¨ã—ã‚¹ã‚­ãƒ¼ãƒã‚‚è¤‡é›‘ã§ã™ã€‚ã“ã®çŠ¶æ³ã«å¯¾å¿œã§ããªã„ã¨ã€ç„¡åŠ¹ãªã‚¯ã‚¨ãƒªã‚’æŠ•ã’ç¶šã‘ã‚‹ã ã‘ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã§ãã‚ãŒã£ã¦ã—ã¾ã„ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€å˜ç´”ãªã‚¯ã‚¨ãƒªå®Ÿè¡Œæ©Ÿèƒ½ã ã‘ã§ãªãã€æ§˜ã€…ãªå‰¯æ¬¡çš„ãªè¦ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## (1) ãƒ„ãƒ¼ãƒ«ã«ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’ä¸ãˆã‚‹å¿…è¦ãŒã‚ã‚‹

BigQueryã¯ä¸€èˆ¬çš„ãªSQLã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ãŸGoogleSQL[^googlesql]ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ã—ã¾ã™ã€‚SQLã§ã‚¯ã‚¨ãƒªã‚’ä½œæˆã™ã‚‹ã«ã¯ã€ã©ã®ã‚ˆã†ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ã¦ã„ã‚‹ã‹ã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`SELECT * FROM xxx` ã®ã‚ˆã†ãªå…¨ã‚«ãƒ©ãƒ å–å¾—ã‚‚ä¸å¯èƒ½ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦å®Ÿè¡Œã™ã‚‹ã¨ä¸€æ’ƒã§ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«é”ã—ã¦ã—ã¾ã„ã¾ã™ã€‚é©åˆ‡ã«æ¤œç´¢ã™ã‚‹ãŸã‚ã«ã¯ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‹ã ã‘ã§ãªãpartitionãªã©ã®ãƒ¡ã‚¿æƒ…å ±ã‚‚å¿…è¦ã§ã™ã€‚

ã—ãŸãŒã£ã¦ã€æ¤œç´¢ã®ãŸã‚ã®ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’ä½•ã‚‰ã‹ã®å½¢ã§LLMã«æä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’æ¸¡ã™æ–¹æ³•ã¯ã„ãã¤ã‹è€ƒãˆã‚‰ã‚Œã¾ã™ãŒã€éƒ½åº¦æœ€æ–°ã®ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’å–å¾—ã™ã‚‹æ–¹å¼ã‚’æ¡ç”¨ã™ã¹ãã§ã™ã€‚

ãã®ç†ç”±ã¨ã—ã¦ã€ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ãŒæ›´æ–°ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚ç‰¹ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ã§åˆ©ç”¨ã™ã‚‹å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®ãƒ­ã‚°ãƒ¬ã‚³ãƒ¼ãƒ‰ã§ã¯ã€é »ç¹ã«ã‚¹ã‚­ãƒ¼ãƒæ›´æ–°ï¼ˆç‰¹ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ ï¼‰ãŒç™ºç”Ÿã—ã¾ã™ã€‚é™çš„ã«ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’ç®¡ç†ã™ã‚‹ã¨ã€æ›´æ–°ã®åº¦ã«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå¿…è¦ã«ãªã‚Šã‚³ã‚¹ãƒˆãŒå¢—å¤§ã—ã¾ã™ã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«æœ€æ–°ã®ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ã§ã€ã“ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚

## (2) ã‚¯ã‚¨ãƒªçµæœã®å–å¾—é‡ã«åˆ¶é™ã‚’ã‹ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹

ã‚¯ã‚¨ãƒªçµæœã®å–å¾—ã‚µã‚¤ã‚ºã‚’åˆ¶é™ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»®ã«100ä¸‡ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã•ã‚Œã¦ã‚‚ã€ç”ŸæˆAIã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å†…ã§å‡¦ç†ã™ã‚‹ã“ã¨ã¯ä¸å¯èƒ½ã§ã‚ã‚Šã€ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãŒçˆ†ç™ºã—ã¦ã—ã¾ã„ã¾ã™ã€‚é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿é‡ã‚’é †æ¬¡èª­ã¿è¾¼ã¾ã›ã‚‹ã‚ˆã†ãªè¨­è¨ˆã«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®åˆ¶é™ã‚’LLMã¸ã®æŒ‡ç¤ºã§å®Ÿç¾ã—ã‚ˆã†ã¨ã—ã¦ã‚‚ã€éµå®ˆã•ã‚Œãªã„å ´åˆãŒå°‘ãªãã‚ã‚Šã¾ã›ã‚“ã€‚å‰è¿°ã®åˆ¶å¾¡ã®å•é¡Œã¨åŒæ§˜ã«ã€ç”ŸæˆAIã¯ç¢ºç‡çš„ãªæŒ¯ã‚‹èˆã„ã‚’ã™ã‚‹ãŸã‚ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚ˆã‚‹æŒ‡ç¤ºã ã‘ã§ã¯ä¸ååˆ†ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒ„ãƒ¼ãƒ«ã®å®Ÿè£…å†…ã§å¼·åˆ¶çš„ã«åˆ¶å¾¡ã‚’ã‹ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## (3) ã‚¹ã‚­ãƒ£ãƒ³ã‚µã‚¤ã‚ºã«åˆ¶é™ã‚’ã‹ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹

AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè‡ªèº«ã®æ©Ÿèƒ½è¦ä»¶ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚¹ã‚­ãƒ£ãƒ³é‡ã‚’åˆ¶å¾¡ã—ã¦ãŠãã“ã¨ãŒé‹ç”¨ä¸Šé‡è¦ã§ã™ã€‚BigQueryã¯ä¸»ã«ã‚¯ã‚¨ãƒªã®ã‚¹ã‚­ãƒ£ãƒ³é‡ã§èª²é‡‘ã•ã‚Œã‚‹ãŸã‚ã€ç„¡åˆ¶é™ãªã‚¹ã‚­ãƒ£ãƒ³ã‚’è¨±ã™ã¨ã‚³ã‚¹ãƒˆãŒçˆ†ç™ºçš„ã«å¢—å¤§ã—ã¾ã™ã€‚ä¾‹ãˆã°us-central1ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯1TBã‚ãŸã‚Š$6.25ã®èª²é‡‘ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã€ä¸é©åˆ‡ãªã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã•ã‚Œç¶šã‘ã‚‹ã¨æ·±åˆ»ãªé‡‘éŠ­çš„æå¤±ã«ã¤ãªãŒã‚Šã¾ã™ã€‚

ç”ŸæˆAIã¯æ™‚ã¨ã—ã¦äºˆæƒ³ã®æ–œã‚ä¸Šã‚’è¡Œãå‹•ä½œã‚’ã™ã‚‹ãŸã‚ã€ã‚³ã‚¹ãƒˆåˆ¶å¾¡ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã ã‘ã«ä¾å­˜ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã“ã®åˆ¶å¾¡ã«ã¤ã„ã¦ã‚‚ã€ãƒ„ãƒ¼ãƒ«ã®å®Ÿè£…å†…ã§ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã¨ã—ã¦çµ„ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## (4) åŠ¹ç‡çš„ã«SQLã‚’çµ„ã¿ç«‹ã¦ã‚‹ãŸã‚ã®ã‚µãƒãƒ¼ãƒˆãŒå¿…è¦ã§ã‚ã‚‹

ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’æä¾›ã™ã‚‹ã ã‘ã§ã¯ã€LLMãŒé©åˆ‡ãªã‚¯ã‚¨ãƒªã‚’æ›¸ã‘ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚¹ã‚­ãƒ¼ãƒã¯ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ§‹é€ ã‚’ç¤ºã—ã¾ã™ãŒã€å®Ÿéš›ã«ã©ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã‹ã¾ã§ã¯åˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚ãã®çµæœã€ä½¿ç”¨ã™ã¹ããƒ†ãƒ¼ãƒ–ãƒ«ã‚„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®é¸æŠãŒæœ€é©ã§ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ã«ã¯ã€å…·ä½“çš„ãªã‚¯ã‚¨ãƒªã®ä¾‹ç¤ºã‚’æä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ç¤ºã«ã‚ˆã£ã¦ã€ç”ŸæˆAIã¯å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã®é–¢ä¿‚ã‚’ç†è§£ã—ã€ã‚ˆã‚Šé©åˆ‡ãªSQLã‚’çµ„ã¿ç«‹ã¦ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

# è¦ä»¶ã‚’è¸ã¾ãˆãŸBigQueryãƒ„ãƒ¼ãƒ«ã®è¨­è¨ˆãƒ»å®Ÿè£…

ã“ã‚Œã‚‰ã®è¦ä»¶ã‚’æº€ãŸã™ã“ã¨ã‚’è€ƒæ…®ã—ãªãŒã‚‰ã€BigQueryã®ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚ãƒ„ãƒ¼ãƒ«ã®åŸºæœ¬çš„ãªæ§‹é€ ã‚„å®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦ã¯å‰æ—¥ã¾ã§ã«è§£èª¬ã—ã¦ãã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯è¦ç‚¹ã®ã¿ã‚’æŠœç²‹ã—ã¦è§£èª¬ã—ã¾ã™ã€‚å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã¯GitHubãƒªãƒã‚¸ãƒˆãƒªã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€è©³ç´°ã‚’ç¢ºèªã—ãŸã„å ´åˆã¯ãã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’å–å¾—ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚‚ç”¨æ„ã™ã‚‹ï¼ˆè¦ä»¶(1)ã¸ã®å¯¾å¿œï¼‰

ã¾ãšã€ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§ãªãã€ãƒ¡ã‚¿æƒ…å ±ã‚‚å–å¾—ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’ç”¨æ„ã—ã¾ã™ã€‚BigQueryã®å ´åˆã€ãƒ†ãƒ¼ãƒ–ãƒ«å˜ä½ã§ã‚¹ã‚­ãƒ¼ãƒã‚’å–å¾—ã§ãã‚‹API[^bq-metadata]ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹å½¢ã§å®Ÿè£…ã—ã¾ã™ã€‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æƒ…å ±ã ã‘ã§ãªãã€partitionã®æƒ…å ±ã‚‚åˆã‚ã›ã¦è¿”ã™ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€LLMãŒã‚ˆã‚ŠåŠ¹ç‡çš„ãªã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã“ã®ä»•çµ„ã¿ã«ã‚ˆã£ã¦ã€ãªã‚‹ã¹ããƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«è¿‘ã„ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’è¿”ã™ã“ã¨ãŒã§ãã¾ã™ã€‚ãŸã ã—ã€ã“ã®ãƒ„ãƒ¼ãƒ«ã ã‘ã‚’æä¾›ã—ã¦ã‚‚ã€ç”ŸæˆAIã¯ã©ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’èª¿ã¹ã‚Œã°ã‚ˆã„ã‹ã‚’åˆ¤æ–­ã§ãã¾ã›ã‚“ã€‚ã“ã®å•é¡Œã¸ã®å¯¾å‡¦æ–¹æ³•ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚

```go:pkg/tool/bigquery/tool.go
{
    Name:        "bigquery_schema",
    Description: "Get schema information for a BigQuery table including field names, types, and descriptions",
    Parameters: &genai.Schema{
        Type: genai.TypeObject,
        Properties: map[string]*genai.Schema{
            "project": {
                Type:        genai.TypeString,
                Description: "Google Cloud project ID",
            },
            "dataset_id": {
                Type:        genai.TypeString,
                Description: "BigQuery dataset ID",
            },
            "table": {
                Type:        genai.TypeString,
                Description: "BigQuery table name",
            },
        },
        Required: []string{"project", "dataset_id", "table"},
    },
},
```

ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæƒ…å ±ãŒè¿”ã•ã‚Œã¾ã™ã€‚

```json
{
  "project": "mztn-audit",
  "dataset_id": "google_cloud_audit",
  "table": "cloudaudit_googleapis_com_activity",
  "full_table": "mztn-audit.google_cloud_audit.cloudaudit_googleapis_com_activity",
  "field_count": 8,
  "num_rows": 1234567,
  "num_bytes": 987654321,
  "schema": "- timestamp (TIMESTAMP) [REQUIRED]\n- severity (STRING)\n- logName (STRING)\n- resource (RECORD)\n  - type (STRING)\n  - labels (RECORD)\n- protopayload_auditlog (RECORD)\n  - authenticationInfo (RECORD)\n    - principalEmail (STRING)\n  - resourceName (STRING)\n  - methodName (STRING)\n  - serviceName (STRING)",
  "time_partitioning": {
    "type": "DAY",
    "field": "timestamp"
  }
}
```

`schema` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã€å‹ã€å¿…é ˆãƒ•ãƒ©ã‚°ï¼ˆ`[REQUIRED]`ï¼‰ãŒæ”¹è¡ŒåŒºåˆ‡ã‚Šã®æ–‡å­—åˆ—å½¢å¼ã§æ ¼ç´ã•ã‚Œã¾ã™ã€‚ãƒã‚¹ãƒˆã—ãŸæ§‹é€ ã¯ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã§è¡¨ç¾ã•ã‚Œã¾ã™ã€‚ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆ`time_partitioning`ï¼‰ã‚„ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ï¼ˆ`num_rows`ï¼‰ãªã©ã‚‚å«ã¾ã‚Œã‚‹ãŸã‚ã€ç”ŸæˆAIã¯åŠ¹ç‡çš„ãªã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ååˆ†ãªæƒ…å ±ã‚’å¾—ã‚‰ã‚Œã¾ã™ã€‚

## ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’ç”¨æ„ã—ã¦LLMã«æä¾›ã™ã‚‹ï¼ˆè¦ä»¶(4)ã¸ã®å¯¾å¿œï¼‰

ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚‚é‡è¦ã§ã™ãŒã€ç”ŸæˆAIã¯å…·ä½“çš„ãªæ‰‹æœ¬ãŒã‚ã‚‹ã¨ãã‚Œã‚’ã‚ˆãè§£é‡ˆã—ã¦æ´»ç”¨ã—ã¦ãã‚Œã¾ã™ã€‚ã“ã‚Œã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã«ãŠã‘ã‚‹Few-shotãƒ—ãƒ­ãƒ³ãƒ—ãƒ†ã‚£ãƒ³ã‚°[^few-shot]ã®ä¸€ç¨®ã§ã™ã€‚ã‚ˆãèª¿ã¹ã‚‹ã‚ˆã†ãªã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’äº‹å‰ã«ç”¨æ„ã—ã¦ãŠãã“ã¨ã§ã€LLMãŒãã‚Œã‚’å‚è€ƒã«ã—ã¦é©åˆ‡ãªã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ç‰¹ã«é‡è¦ãªã®ã¯æ¡ä»¶å¼ã«ã©ã®ã‚ˆã†ãªå€¤ã‚’æŒ‡å®šã™ã‚‹ã‹ã¨ã„ã†ç‚¹ã§ã™ã€‚ç”ŸæˆAIã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’æ¨æ¸¬ã§æ±ºã‚ã¦ã—ã¾ã„ãŒã¡ã§ã™ã€‚ä¾‹ãˆã°ã€ãƒ¡ã‚½ãƒƒãƒ‰åã‚’æ¤œç´¢ã™ã‚‹éš›ã« `WHERE methodName = 'delete'` ã®ã‚ˆã†ã«æ¨æ¸¬ã—ã¦ã—ã¾ã„ã¾ã™ãŒã€å®Ÿéš›ã«ã¯ `WHERE methodName LIKE '%delete%'` ã‚„ `WHERE methodName = 'storage.buckets.delete'` ã®ã‚ˆã†ã«å®Œå…¨ä¿®é£¾åã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¯¾ã—ã¦ `WHERE timestamp > '2024-01-01'` ã®ã‚ˆã†ãªæ–‡å­—åˆ—æ¯”è¼ƒã‚’æ›¸ã„ã¦ã—ã¾ã„ã€å®Ÿéš›ã«ã¯ `TIMESTAMP_TRUNC(timestamp, DAY) >= TIMESTAMP('2024-01-01')` ã®ã‚ˆã†ãªé–¢æ•°ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚æ­£è§£ä¾‹ã‚’æ¸¡ã—ã¦ãŠãã“ã¨ã§ã€ã“ã†ã—ãŸå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚„æ¤œç´¢ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ç¿’ã—ã€æ­£ç­”ç‡ãŒé£›èºçš„ã«å‘ä¸Šã—ã¾ã™ã€‚

å…·ä½“çš„ãªä¾‹ã¨ã—ã¦ã¯ https://github.com/m-mizutani/leveret/tree/day11-db-query-tool/examples/bigquery/runbooks ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ãŸã ã—ã“ã‚Œã¯ã‚ãã¾ã§ä¾‹ã§ã‚ã‚Šã€å®Ÿéš›ã«ã¯å„çµ„ç¹”ãŒæŒã¤ãƒ‡ãƒ¼ã‚¿ã®ç‰¹æ€§ã«å¿œã˜ã¦ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹ã®ãŒæœ›ã¾ã—ã„ã§ã™ã€‚

ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®ä»•çµ„ã¿ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã€IDã‚’æŒ‡å®šã™ã‚‹ã¨å¯¾è±¡ã®SQLã‚’è¿”ã™ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚ã“ã®è¨­è¨ˆã«ã—ã¦ãŠãã“ã¨ã§ã€ãƒ©ãƒ³ãƒ–ãƒƒã‚¯è‡ªä½“ãŒå¢—ãˆã¦ã‚‚ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ç„¡é§„ã«æ¶ˆè²»ã—ãªã„ã‚ˆã†ã«ã§ãã¾ã™ã€‚ã§ã¯ç”ŸæˆAIã¯ã©ã†ã‚„ã£ã¦IDã‚’çŸ¥ã‚‹ã®ã‹ã¨ã„ã†ç‚¹ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚

```go:pkg/tool/bigquery/tool.go
if len(t.runBooks) > 0 {
    declarations = append(declarations, &genai.FunctionDeclaration{
        Name:        "bigquery_runbook",
        Description: "Get SQL query from runBook by ID",
        Parameters: &genai.Schema{
            Type: genai.TypeObject,
            Properties: map[string]*genai.Schema{
                "runbook_id": {
                    Type:        genai.TypeString,
                    Description: "RunBook ID to retrieve",
                },
            },
            Required: []string{"runbook_id"},
        },
    })
}
```

ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã¯SQLãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ç”¨æ„ã—ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã«ã—ã¦ãŠãã¨ã€ã‚¨ãƒ‡ã‚£ã‚¿ã®SQL linteræ©Ÿèƒ½ãªã©ã‚’æ´»ç”¨ã§ãã¦ä¾¿åˆ©ã§ã™ã€‚ä»Šå›ã®å®Ÿè£…ã§ã¯ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚‚SQLãƒ•ã‚¡ã‚¤ãƒ«ã«åŒæ¢±ã—ã€`title` ã¨ `description` ã¨ã„ã†ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‹ã‚‰æƒ…å ±ã‚’èª­ã¿å–ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†æ–¹æ³•ã¯æ§˜ã€…ãªé¸æŠè‚¢ãŒã‚ã‚Šã¾ã™ãŒã€SQLã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã¾ã£ã¦ã„ã‚‹ã¨ç®¡ç†ã—ã‚„ã™ã„ã¨ã„ã†åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

ç”ŸæˆAIã¯ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è¦‹ã¦æ¬¡ã«ã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’ãã®ã¾ã¾å‚è€ƒã«ã™ã‚‹å ´åˆã‚‚ã‚ã‚Œã°ã€ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‹ã‚‰å­¦ã‚“ã ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ¥ã®ã‚¹ã‚­ãƒ¼ãƒã«é©ç”¨ã™ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚

```sql:examples/bigquery/runbooks/admin_activities.sql
-- title: Admin Activities
-- description: Query to track administrative activities and configuration changes

SELECT
  timestamp,
  protopayload_auditlog.authenticationInfo.principalEmail as principal,
  protopayload_auditlog.resourceName as resource,
  protopayload_auditlog.methodName as method,
  protopayload_auditlog.serviceName as service
FROM
  `mztn-audit.google_cloud_audit.cloudaudit_googleapis_com_activity`
WHERE
  TIMESTAMP_TRUNC(timestamp, DAY) >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
  AND (
    protopayload_auditlog.methodName LIKE '%create%'
    OR protopayload_auditlog.methodName LIKE '%delete%'
    OR protopayload_auditlog.methodName LIKE '%update%'
    OR protopayload_auditlog.methodName LIKE '%setIamPolicy%'
  )
ORDER BY
  timestamp DESC
LIMIT 100
```

## ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚„ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®æƒ…å ±ã‚’ã€æœ€åˆã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸ‹ã‚è¾¼ã‚€

å…ˆè¿°ã—ãŸé€šã‚Šã€ã‚¹ã‚­ãƒ¼ãƒã‚„ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®æƒ…å ±ã‚’æä¾›ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’ç”¨æ„ã—ã¦ã‚‚ã€LLMãŒãã‚‚ãã‚‚ä½•ã‚’æ¢ã—ã«è¡Œã‘ã°ã‚ˆã„ã‹åˆ†ã‹ã‚‰ãªã„ã¨ã„ã†å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ã€‚ã“ã®å•é¡Œã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ä¸€å®šç¨‹åº¦è§£æ±ºã§ãã¾ã™ã€‚è§£æ±ºæ–¹æ³•ã¯å¤§ããåˆ†ã‘ã¦2ã¤ã‚ã‚Šã¾ã™ã€‚

1ã¤ç›®ã®æ–¹æ³•ã¯ã€ã€Œãƒ„ãƒ¼ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã®ã§ãã‚Œã‚’ä½¿ã£ã¦ã¾ãšãƒ†ãƒ¼ãƒ–ãƒ«ã‚„ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’æ¢ã›ã€ã¨ã„ã†æŒ‡ç¤ºã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å…¥ã‚Œã¦ãŠãã“ã¨ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ç”ŸæˆAIã¯ã¾ãšãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ã¨ã„ã†å‹•ä½œã‚’ã—ã¦ãã‚Œã¾ã™ã€‚ã—ã‹ã—ã“ã®æ–¹æ³•ã«ã¯æ¬ ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚æŒ‡ç¤ºã‚’ç„¡è¦–ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ã™ã€‚ç‰¹ã«ã€Œæœ€çŸ­ã§ç›®çš„ã‚’é”æˆã›ã‚ˆã€ã¨ã„ã£ãŸæŒ‡ç¤ºã¨ç«¶åˆã™ã‚‹ã¨ã€ãƒªã‚¹ãƒˆå–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸå˜ç´”ã«LLMã¨ã®å¾€å¾©å›æ•°ãŒå¢—ãˆã‚‹ãŸã‚ã€å¿œç­”æ™‚é–“ãŒæ‚ªåŒ–ã—ã¾ã™ã€‚

2ã¤ç›®ã®æ–¹æ³•ã¯ã€æœ€åˆã‹ã‚‰ã©ã®ã‚ˆã†ãªãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚‹ã‹ã¨ã„ã†æ¦‚è¦æƒ…å ±ã ã‘ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸ‹ã‚è¾¼ã‚“ã§ãŠãã“ã¨ã§ã™ã€‚ã“ã®æ–¹å¼ã‚’æ¡ç”¨ã™ã‚‹ã¨ã€LLMãŒæœ€åˆã«è¡Œå‹•ã‚’èµ·ã“ã™éš›ã®é¸æŠè‚¢ã«ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ãŒå«ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸéƒ½åº¦ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã§ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒãªã„ãŸã‚ã€å¿œç­”æ™‚é–“ã®é¢ã§ã‚‚æœ‰åˆ©ã§ã™ã€‚æ‡¸å¿µç‚¹ã¨ã—ã¦äº‹å‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚„ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’æ¶ˆè²»ã—ã¦ã—ã¾ã†ã“ã¨ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ãŒã€æ•°å€‹ã‹ã‚‰æ•°åå€‹ç¨‹åº¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã§ã‚ã‚Œã°æ¶ˆè²»é‡ã¯èª¤å·®ã®ç¯„å›²ã¨ã„ãˆã¾ã™ã€‚

æœ¬å®Ÿè£…ã§ã¯ã€ã“ã‚Œã‚‰ã®æ¬ ç‚¹ã‚’é¿ã‘ã‚‹ãŸã‚ã€2ã¤ç›®ã®æ–¹æ³•ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

å…·ä½“çš„ãªå®Ÿè£…ã§ã¯ã€ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ `Prompt` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã„ã¾ã™ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèµ·å‹•å‰ã«å‘¼ã³å‡ºã•ã‚Œã€æ–‡å­—åˆ—ã‚’è¿”ã™ã¨system promptã«è¿½è¨˜ã•ã‚Œã¾ã™ã€‚ã“ã“ã«ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸€è¦§ã‚’æ›¸ã„ã¦ãŠãã¾ã™ã€‚è¨˜è¿°ã™ã‚‹ã®ã¯ã‚¿ã‚¤ãƒˆãƒ«ã‚„ç°¡å˜ãªæ¦‚è¦ã ã‘ã§ååˆ†ã§ã™ã€‚è©³ç´°ã¾ã§è¨˜è¿°ã™ã‚‹ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’éåº¦ã«æ¶ˆè²»ã—ã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã®æƒ…å ±ãŒã‚ã‚‹ã ã‘ã§ã€ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã®ç²¾åº¦ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚

```go:pkg/tool/bigquery/tool.go
// Prompt returns additional information to be added to the system prompt
func (t *Tool) Prompt(ctx context.Context) string {
	var lines []string

	// Add runBook information
	if len(t.runBooks) > 0 {
		lines = append(lines, "Available BigQuery runBooks:")
		for _, rb := range t.runBooks {
			line := fmt.Sprintf("- ID: %s", rb.ID)
			if rb.Title != "" {
				line += fmt.Sprintf(", Title: %s", rb.Title)
			}
			if rb.Description != "" {
				line += fmt.Sprintf(", Description: %s", rb.Description)
			}
			lines = append(lines, line)
		}
	}

	// Add table list information
	if len(t.tables) > 0 {
		if len(lines) > 0 {
			lines = append(lines, "")
		}
		lines = append(lines, "Available BigQuery tables:")
		for _, table := range t.tables {
			line := fmt.Sprintf("- %s", table.FullName())
			if table.Description != "" {
				line += fmt.Sprintf(": %s", table.Description)
			}
			lines = append(lines, line)
		}
	}

	if len(lines) == 0 {
		return ""
	}

	return strings.Join(lines, "\n")
}
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒsystem promptã«è¿½è¨˜ã•ã‚Œã¾ã™ã€‚ç”ŸæˆAIã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèµ·å‹•æ™‚ã«ã“ã®æƒ…å ±ã‚’å—ã‘å–ã‚‹ãŸã‚ã€æœ€åˆã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ±ºå®šæ™‚ã‹ã‚‰åˆ©ç”¨å¯èƒ½ãªãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’èªè­˜ã—ãŸçŠ¶æ…‹ã§å‹•ä½œã‚’é–‹å§‹ã§ãã¾ã™ã€‚

```markdown
Available BigQuery runBooks:
- ID: admin_activities, Title: Admin Activities, Description: Query to track administrative activities and configuration changes
- ID: failed_operations, Title: Failed Operations, Description: Query to find operations that resulted in errors or failures
- ID: recent_data_access, Title: Recent Data Access Logs, Description: Query to retrieve recent data access audit logs from the last 24 hours

Available BigQuery tables:
- mztn-audit.google_cloud_audit.cloudaudit_googleapis_com_activity: Admin activity audit logs (configuration changes, resource creation/deletion)
- mztn-audit.google_cloud_audit.cloudaudit_googleapis_com_data_access: Data access audit logs (read/write operations on data)
- mztn-audit.google_cloud_audit.cloudaudit_googleapis_com_system_event: System event audit logs (GCP-initiated operations)
```

## ã‚¹ã‚­ãƒ£ãƒ³ã‚µã‚¤ã‚ºã‚„çµæœå–å¾—æ•°ã®ã‚¬ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã‚‹ï¼ˆè¦ä»¶(2)(3)ã¸ã®å¯¾å¿œï¼‰

LLMã«ã€Œã€œã¯ç¦æ­¢ã€ã¨ã„ã†æŒ‡ç¤ºã‚’ã—ã¦ã‚‚ã€å®¹æ˜“ã«ç ´ã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã¯ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰å†…ã«å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»Šå›ã¯BigQueryã®ã‚¹ã‚­ãƒ£ãƒ³ã‚µã‚¤ã‚ºã¨çµæœå–å¾—ã™ã‚‹éš›ã®ä¸Šé™ã‚’è¨­å®šã—ã¾ã™ã€‚

ã¾ãšã‚¹ã‚­ãƒ£ãƒ³ã‚µã‚¤ã‚ºã®åˆ¶å¾¡ã‹ã‚‰è¦‹ã¦ã„ãã¾ã™ã€‚äº‹å‰ã«DryRunã‚’å®Ÿè¡Œã—ã¦ã€æŒ‡å®šã—ãŸä¸Šé™ã‚’è¶…ãˆã¦ã„ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ã®è¿”ã—æ–¹ãŒãƒã‚¤ãƒ³ãƒˆã§ã€å˜ã«ã€Œã ã‚ã§ã—ãŸã€ã§ã¯ãªãæ”¹å–„ã®æ–¹å‘ã‚’ç¤ºå”†ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

ä¾‹ãˆã°ã‚¹ã‚­ãƒ£ãƒ³ã‚µã‚¤ã‚ºãŒå¤§ãã™ããŸå ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã§ã‚«ãƒ©ãƒ ã®åˆ¶é™ã€æ—¥ä»˜ç¯„å›²ã®æŒ‡å®šã€partitioned tableã®åˆ©ç”¨ãªã©ã‚’æŒ‡ç¤ºã—ã¾ã™ã€‚ã¾ãŸå®Ÿéš›ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚µã‚¤ã‚ºã¨ä¸Šé™å€¤ã®ä¸¡æ–¹ã‚’è¿”ã™ã“ã¨ã§ã€ã©ã®ç¨‹åº¦ã‚ªãƒ¼ãƒãƒ¼ã—ã¦ã„ãŸã®ã‹ã‚’LLMãŒç†è§£ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’LLMã«æŠ•å…¥ã™ã‚‹ã“ã¨ã§ã€æ¬¡ã®å‹•ä½œã§é©åˆ‡ãªä¿®æ­£ãŒæœŸå¾…ã§ãã¾ã™ã€‚

é€†ã«ã“ã®ã‚ˆã†ãªå…·ä½“çš„ãªæŒ‡ç¤ºãŒãªã„ã¨ã€ç”ŸæˆAIã¯æ€ã„ã¤ãã§ã‚¯ã‚¨ãƒªã‚’é€£ç™ºã—ç¶šã‘ã€æ°¸é ã«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã¨ã„ã†äº‹æ…‹ã«é™¥ã‚Šã¾ã™ã€‚

```go:pkg/tool/bigquery/query.go
// Perform dry run to check scan size
bytesProcessed, err := t.bq.DryRun(ctx, in.Query)
if err != nil {
    return &genai.FunctionResponse{
        Name: fc.Name,
        Response: map[string]any{
            "error": fmt.Sprintf("Query validation failed: %v", err),
        },
    }, nil
}

// Check scan limit
scanLimitBytes := t.scanLimitMB * 1024 * 1024
bytesProcessedMB := float64(bytesProcessed) / 1024 / 1024

if bytesProcessed > scanLimitBytes {
    return &genai.FunctionResponse{
        Name: fc.Name,
        Response: map[string]any{
            "error": fmt.Sprintf(
                "Query would scan %.2f MB, which exceeds the limit of %d MB. Please refine your query to reduce data scanned (e.g., add date filters, limit columns, or use partitioned tables).",
                bytesProcessedMB,
                t.scanLimitMB,
            ),
        },
    }, nil
}

// Execute query
jobID, err := t.bq.Query(ctx, in.Query)
if err != nil {
    return &genai.FunctionResponse{
        Name: fc.Name,
        Response: map[string]any{
            "error": fmt.Sprintf("Query execution failed: %v", err),
        },
    }, nil
}
```

çµæœã®å–å¾—ã«ã¤ã„ã¦ã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ã«ä¸Šé™ã‚’è¶…ãˆã¦ã„ãŸã‚‰ä¸Šé™å€¤ã«åˆ‡ã‚Šè©°ã‚ã¦å¼·åˆ¶çš„ã«è£œæ­£ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚ãŸã ã— `limit` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¬æ˜æ–‡ã«æœ€å¤§å€¤ã‚’ãã¡ã‚“ã¨åŸ‹ã‚è¾¼ã‚“ã§ãŠãã€ç”ŸæˆAIå´ã«åˆ¶é™ã‚’ç†è§£ã•ã›ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

```go
func (t *Tool) executeGetResult(ctx context.Context, fc genai.FunctionCall) (*genai.FunctionResponse, error) {
	type input struct {
		JobID  string `json:"job_id"`
		Limit  int    `json:"limit"`
		Offset int    `json:"offset"`
	}

    // ä¸­ç•¥

	if in.Limit > int(t.resultLimitRows) {
		in.Limit = int(t.resultLimitRows)
	}
```

```go
    "limit": {
        Type:        genai.TypeInteger,
        Description: fmt.Sprintf("Maximum number of rows to return (default: 100, max: %d)", t.resultLimitRows),
    },
```

# å®Ÿè¡Œä¾‹

ã“ã“ã¾ã§ã®å®Ÿè£…ã§ã€BigQueryã«å¯¾ã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹ãƒ„ãƒ¼ãƒ«ãŒå®Œæˆã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã«å®Ÿè¡Œä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚ãªãŠã€è¨­å®šå€¤ãªã©ã®è©³ç´°ã¯çœç•¥ã—ã¦ã„ã¾ã™ã€‚

ã“ã®å®Ÿè¡Œä¾‹ã§ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã€Œã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç›´è¿‘ã§å¤‰æ›´ã•ã‚ŒãŸå½¢è·¡ã€ã¨ã„ã†æŒ‡ç¤ºã‹ã‚‰ã€ç®¡ç†ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’èª¿æŸ»ã™ã¹ãã¨åˆ¤æ–­ã—ã€`admin_activities` ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚ãã®å¾Œã€ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®SQLã‚’ãƒ™ãƒ¼ã‚¹ã«ã‚¢ãƒ©ãƒ¼ãƒˆå†…ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã‚ˆã†ã‚¯ã‚¨ãƒªã‚’èª¿æ•´ã—ã€å®Ÿéš›ã®ã‚¯ã‚¨ãƒªã‚’ç™ºè¡Œã—ã¦ã„ã¾ã™ã€‚çµæœã¨ã—ã¦ç‰¹ã«è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒå¾—ã‚‰ã‚Œãªã‹ã£ãŸãŸã‚ã€ãã®æ—¨ã‚’è¿”ã—ã¦èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚

```shell
$ go run . chat -i 655c6341-43d4-4ebd-b44e-ab7222523463
Enabled tools: [search_alerts query_otx bigquery_query bigquery_get_result bigquery_schema bigquery_runbook]

Chat session started. Type 'exit' to quit.

> ã“ã®ã‚¢ãƒ©ãƒ¼ãƒˆã«é–¢é€£ã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç›´è¿‘ã§å¤‰æ›´ã•ã‚ŒãŸå½¢è·¡ãŒã‚ã‚‹ã‹ã‚’èª¿æŸ»ã—ã€çµæœã‚’å ±å‘Šã›ã‚ˆ

â  processing...
ğŸ”§ Calling tool: bigquery_runbook
   Args:
{
     "runbook_id": "admin_activities"
   }
âœ… Tool result:
{
  "description": "Query to track administrative activities and configuration changes",
  "runbook_id": "admin_activities",
  "sql": "SELECT\n  timestamp,\n  protopayload_auditlog.authenticationInfo....

â ¹ processing...
ğŸ”§ Calling tool: bigquery_query
   Args:
{
     "query": "SELECT\n  timestamp,\n  protopayload_auditlog.authenticationInfo.principalEmail as principal,\n  protopayload_auditlog.resourceName as resource,\n  protopayload_auditlog.methodName as method,\n  protopayload_auditlog.serviceName as service\nFROM\n  `mztn-audit.google_cloud_audit.cloudaudit_googleapis_com_activity`\nWHERE\n  TIMESTAMP_TRUNC(timestamp, DAY) \u003e= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)\n  AND (\n    protopayload_auditlog.methodName LIKE '%create%'\n    OR protopayload_auditlog.methodName LIKE '%delete%'\n    OR protopayload_auditlog.methodName LIKE '%update%'\n    OR protopayload_auditlog.methodName LIKE '%setIamPolicy%'\n  )\n  AND protopayload_auditlog.resourceName LIKE '%projects/production-project-12345/zones/us-central1-a/instances/web-server-prod-01%'\nORDER BY\n  timestamp DESC\nLIMIT 100"
   }
â ¸ processing...âœ… Tool result:
{
  "job_id": "ZxHKSXCspe5safA58SyxR3PdT87",
  "rows_returned": 0
}

ã‚¢ãƒ©ãƒ¼ãƒˆã«é–¢é€£ã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€Œweb-server-prod-01ã€ã«ã¤ã„ã¦ã€éå»7æ—¥é–“ã«è¨­å®šå¤‰æ›´ã‚„ç®¡ç†ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ï¼ˆä½œæˆã€å‰Šé™¤ã€æ›´æ–°ã€IAMãƒãƒªã‚·ãƒ¼è¨­å®šãªã©ï¼‰ã¯ç¢ºèªã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚
```

# ã¾ã¨ã‚

æœ¬æ—¥ã¯BigQueryãƒ­ã‚°æ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’é¡Œæã¨ã—ã¦ã€ã‚ˆã‚Šå®Ÿè·µçš„ãªãƒ„ãƒ¼ãƒ«å®Ÿè£…ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã—ãŸã€‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã¯ã€ç”ŸæˆAIã®ç‰¹æ€§ã‚’ç†è§£ã—ãŸä¸Šã§è¨­è¨ˆã™ã‚‹ã“ã¨ã§ã™ã€‚LLMã«ã¯ã€ŒçŸ¥ã‚‰ãªã„ã‚‚ã®ã¯æ¢ã•ãªã„ã€ã€Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®é™ç•ŒãŒã‚ã‚‹ã€ã€Œãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æŒ‡ç¤ºã‚’å¿…ãšå®ˆã‚‹ã¨ã¯é™ã‚‰ãªã„ã€ã¨ã„ã†ç‰¹æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã‚’è¸ã¾ãˆã‚‹ã¨ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§åˆ¶å¾¡ã™ã¹ãã“ã¨ã¨ã€ã‚³ãƒ¼ãƒ‰ã§å¼·åˆ¶ã™ã¹ãã“ã¨ã®åŒºåˆ¥ãŒé‡è¦ã«ãªã‚Šã¾ã™ã€‚

ä»Šå›å®Ÿè£…ã—ãŸä»¥ä¸‹ã®ä»•çµ„ã¿ã¯ã€ä»–ã®ãƒ„ãƒ¼ãƒ«ã§ã‚‚å¿œç”¨å¯èƒ½ã§ã™ã€‚

- ã‚¹ã‚­ãƒ£ãƒ³ã‚µã‚¤ã‚ºã‚„çµæœå–å¾—é‡ã®åˆ¶é™ã¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã¯ãªãã‚³ãƒ¼ãƒ‰ã§å¼·åˆ¶ã™ã‚‹
- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®ä¸€è¦§ã¯ã€äº‹å‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸ‹ã‚è¾¼ã‚“ã§LLMã«ä¼ãˆã‚‹
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯æ”¹å–„ã®æ–¹å‘æ€§ã‚’å«ã‚ã€ç”ŸæˆAIã®æ¬¡ã®è¡Œå‹•ã‚’èª˜å°ã™ã‚‹

ç‰¹ã«ã€Œäº‹å‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¸ã®æƒ…å ±åŸ‹ã‚è¾¼ã¿ã€ã¯æ±ç”¨çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ãƒ„ãƒ¼ãƒ«ã‚’ç”¨æ„ã™ã‚‹ã ã‘ã§ãªãã€ä½•ãŒåˆ©ç”¨å¯èƒ½ã‹ã‚’æœ€åˆã‹ã‚‰ä¼ãˆã‚‹ã“ã¨ã§ã€ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã®ç²¾åº¦ãŒå‘ä¸Šã—ã€å¾€å¾©å›æ•°ã‚‚å‰Šæ¸›ã§ãã¾ã™ã€‚ã“ã®è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€BigQueryã«é™ã‚‰ãšã€APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ“ä½œãªã©ã€æ§˜ã€…ãªãƒ„ãƒ¼ãƒ«å®Ÿè£…ã«é©ç”¨ã§ãã¾ã™ã€‚æ¬¡å›ä»¥é™ã¯ã€ã‚ˆã‚Šé«˜åº¦ãªãƒ„ãƒ¼ãƒ«ã®çµ„ã¿åˆã‚ã›ã«ã¤ã„ã¦è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

[^googlesql]: https://cloud.google.com/bigquery/docs/introduction-sql?hl=ja
[^bq-metadata]: BigQuery Metadata API https://cloud.google.com/bigquery/docs/information-schema-tables
[^few-shot]: Few-shot prompting https://www.promptingguide.ai/techniques/fewshot
[^lost-in-middle]: "Lost in the Middle: How Language Models Use Long Contexts" https://arxiv.org/abs/2307.03172
