---
title: "RegoのコーディングガイドラインをRegoで検査する"
emoji: "🔁"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["opa", "rego"]
published: false
---

この記事は[OPA/Regoアドベントカレンダー](https://adventar.org/calendars/6601)の20日目です。

本アドベントカレンダーの[OPAコマンドの利用](https://zenn.dev/mizutani/articles/f00d3ca12e4102) でも紹介しましたが、 `opa` コマンドは様々な機能を有しており、その中にコードのチェックに関するサブコマンドも含まれています。`check` はポリシーやデータに不整合がないかを事前チェックし、`fmt` は改行やインデントなどのフォーマットを修正してくれます。

しかし、それ以外のコーディングに関する規約のチェックをするようなツールは（ざっと調べた限りだと）現状ないようです。OPAのルールを複数人で管理するとなると、例えば以下のような項目を強制して管理しているリポジトリの治安を維持したいと考えるようになるかと思います。

- 保存時にはデバッグ用の `print` を残さないようにする（ `trace` は許可）
- 1つのパッケージを1つのディレクトリに集約し、複数ディレクトリに散らばらないようにする
- パッケージにごとに必ずテストを1つ以上記載する
- 変数名や関数名をsneak case、もしくはcamel caseのどちらかで統一する（おそらく一般的にはsneak case）
- 非推奨の `=` [^equality]を使わず、`:=` と `==` のみを使う
- イテレーションに用いる変数は必ず `some` キーワードで宣言する
- 特定のポリシー間で参照を禁止する

これに加えて組織ごとに管理の方針があると、

[^equality]: `=`, `:=`, `==` の違いについては[FAQ](https://www.openpolicyagent.org/docs/latest/faq/#which-equality-operator-should-i-use)をご参照ください
