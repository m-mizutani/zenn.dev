---
title: "実践セキュリティ監視基盤構築(19): アラート検知の実装要点"
emoji: "🔎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["security", "monitoring"]
published: false
---

この記事はアドベントカレンダー[実践セキュリティ監視基盤構築](https://adventar.org/calendars/9986)の18日目です。

今回はアラートの検知の実装について解説します。本アドベントカレンダーではBigQueryに定期的にクエリを発行してアラートを検知する、いわゆるバッチ型のアラート検知を前提としていますが、他にもストリーム型のアラート検知もあります。今回はそれぞれの実装をする場合のポイントについて解説します。

# アラート検知の処理系

アラート検知のための処理系は大きく分けて、発生したログデータを逐次的に受け付けて検知するストリーム型と、定期的にクエリを発行して検知するバッチ型があります。今回は自分で実装することを前提にしていますが、既存のSIEMなどもいずれかの方法で実装されている場合がほとんどなので。それぞれの特徴を説明します。

## ストリーム型

発生したログを1件ずつ検査し、あらかじめ定義されたルールにマッチするかどうかを判定します。ログはメッセージングサービス（例: Pub/Sub）を経由して送信されてきたり、syslog、logstash、fluentdやHTTPのAPIを経由して送信されてくるものなど様々ですが、基本的には到着したログを次々に処理していくことになります。

この実装方法の最大の利点は遅延が小さくなることです。ログが到着した段階で検知を行うため、ログの取得から検知までの遅延がほとんど発生しません。そのため、緊急度の高いアラートを検知し、即座に対応する[^respond-latency]ためには適した形であると言えます。

[^respond-latency]: ただし、アラートの対応が24/365で即座にできる体制を整えられる場合にのみ効果を発揮する点に注意してください。

### 複数ログに跨ったルールの検知方法

- パターン1: 短期的な記憶領域を用意し状態を保持する
- パターン2: データウェアハウスなどから都度関連するログを取得する

![](https://storage.googleapis.com/zenn-user-upload/76bf17bdcfbb-20241210.jpg)

### ストリーム型処理実装における注意点


## バッチ型

- 定期的にクエリ発行する
    - 再実行がラク
    - スケジューラでCloud Runを定期実行
    - なんならCloud WorkflowでもOK
- 検知した（クエリの結果が得られた）ログをアラート処理に送る
    - 今回はPubSub
    - ただし大量に送りつけると受け側が大変なことになるのでちゃんと考える
- コストの抑制
    - 時刻パーティションの活用
        - ただしクエリする時間間隔にも影響するので注意
    - 参照フィールドを絞る
    - LIMITは効かないので注意
- 注意点
    - 検知に対して例外のルールを足していくことになる
    - ルールの見通しが悪くなって認知不可が高くなる
    - テスト可能にしておかないと徐々に破綻していく

# どの処理系を選ぶか


# まとめ
