---
title: "Goã§ä½œã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æLLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ(20): Embeddingã«ã‚ˆã‚‹é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œç´¢"
emoji: "ğŸ”"
type: "tech"
topics: ["ai", "go", "llm", "rag"]
published: true
---

ã“ã®è¨˜äº‹ã¯ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€Œ[Goã§ä½œã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æLLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ](https://adventar.org/calendars/11354)ã€ã®20æ—¥ç›®ã§ã™ã€‚

ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯ https://github.com/m-mizutani/leveret ã® [day20-embedding](https://github.com/m-mizutani/leveret/tree/day20-embedding) ãƒ–ãƒ©ãƒ³ãƒã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã®ã§é©å®œå‚ç…§ã—ã¦ãã ã•ã„ã€‚

# Embeddingã«ã¤ã„ã¦

## Embeddingã¨ã¯ãªã«ã‹

Embeddingã¨ã¯ã€ä¸€è¨€ã§è¨€ãˆã°ã€Œè¨€è‘‰ã‚„æ–‡ç« ã®æ„å‘³ã‚’ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã™ã‚‹æŠ€è¡“ã€ã§ã™ã€‚ä¼¼ãŸæ„å‘³ã‚’æŒã¤è¨€è‘‰ã‚„æ–‡ç« åŒå£«ãŒã€ãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“ä¸Šã§è¿‘ã„ä½ç½®ã«é…ç½®ã•ã‚Œã‚‹ã‚ˆã†ã«è¨ˆç®—ã•ã‚Œã‚‹ä»•çµ„ã¿ã¨ãªã£ã¦ã„ã¾ã™ã€‚ãŸã¨ãˆã°ã€Œãƒšãƒƒãƒˆã€ã¨ã€ŒçŠ¬ã€ã¯æ„å‘³çš„ã«è¿‘ã„ãŸã‚ãƒ™ã‚¯ãƒˆãƒ«ã®è·é›¢ã‚‚è¿‘ãã€ã€ŒçŠ¬ã€ã¨ã€Œå®‡å®™ã€ã¯æ„å‘³ãŒé›¢ã‚Œã¦ã„ã‚‹ãŸã‚ãƒ™ã‚¯ãƒˆãƒ«ã®è·é›¢ã‚‚é ããªã‚Šã¾ã™ã€‚åŒæ§˜ã«ã€Œãƒšãƒƒãƒˆã€ã¨ã€Œå®‡å®™ã€ã‚‚é ã„é–¢ä¿‚ã¨ãªã‚Šã¾ã™ã€‚ã“ã†ã—ãŸå˜èªã‚„æ–‡ç« ã®ãƒ™ã‚¯ãƒˆãƒ«åŒ–æŠ€è¡“ã¯ã€ç”ŸæˆAIãŒç™»å ´ã™ã‚‹ä»¥å‰ã‹ã‚‰é•·ãç ”ç©¶ã•ã‚Œã¦ãã¾ã—ãŸã€‚åˆæœŸã®EmbeddingæŠ€è¡“ã§ã‚ã‚‹word2vecã‚„GloVeãªã©ã¯ã€å˜èªå˜ä½ã®ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã‚’ä¸­å¿ƒã¨ã—ã¦ã„ã¾ã—ãŸãŒã€æ–‡è„ˆã«ã‚ˆã£ã¦æ„å‘³ãŒå¤‰ã‚ã‚‹å¤šç¾©èªã¸ã®å¯¾å¿œãŒå¼±ãã€æ–‡å…¨ä½“ã®ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã‚‚è‹¦æ‰‹ã¨ã„ã†åˆ¶ç´„ãŒã‚ã‚Šã¾ã—ãŸã€‚ãã®å¾Œã€æ–‡ç« ã®æµã‚Œï¼ˆæ–‡è„ˆï¼‰ã‚’æ‰ãˆã‚‹ãŸã‚ã«RNNã‚„LSTMã¨ã„ã£ãŸãƒ¢ãƒ‡ãƒ«ãŒç™»å ´ã—ã€æ–‡å…¨ä½“ã®æ„å‘³ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã—ã‹ã—é•·æ–‡ã«ãªã‚‹ã¨ç²¾åº¦ãŒè½ã¡ã‚‹ã¨ã„ã†èª²é¡ŒãŒæ®‹ã£ã¦ã„ã¾ã—ãŸã€‚

ã“ã®çŠ¶æ³ã‚’å¤§ããå¤‰ãˆãŸã®ãŒTransformerã®ç™»å ´ã§ã™ã€‚Transformerã«ã‚ˆã£ã¦æ–‡ä¸­ã®æ„å‘³ã®ã¤ãªãŒã‚Šã‚’åŠ¹ç‡è‰¯ãç†è§£ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€æ–‡è„ˆã‚’è€ƒæ…®ã—ãŸé«˜ç²¾åº¦ãªEmbeddingãŒå®Ÿç¾ã•ã‚Œã¾ã—ãŸã€‚Transformerã¯BERTã‚„GPTãªã©ã®å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã«ã‚‚æ¡ç”¨ã•ã‚Œã¦ã„ã‚‹ç¾åœ¨ã®LLMã«ãŠã‘ã‚‹é‡è¦ãªåŸºç¤æŠ€è¡“ã®ä¸€ã¤ã§ã™ã€‚ã“ã®ãŸã‚ã€LLMã‚µãƒ¼ãƒ“ã‚¹ã¨ä¸€ç·’ã«Embeddingæ©Ÿèƒ½ãŒæä¾›ã•ã‚Œã‚‹ã“ã¨ãŒå¤šããªã£ã¦ã„ã¾ã™ã€‚ãŸã¨ãˆã°Geminiã‚„OpenAIã¯ãã‚Œãã‚ŒEmbeddingæ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ä¸€æ–¹ã€Claudeã¯2025å¹´ç¾åœ¨ã§ã¯Embeddingæ©Ÿèƒ½ã‚’ç›´æ¥æä¾›ã—ã¦ãŠã‚‰ãšã€[Voyage AI](https://www.voyageai.com/)ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚

è©³ã—ã„ç†è«–ã«ã¤ã„ã¦ã¯ã“ã®ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç¯„å›²ã‚’è¶…ãˆã‚‹ãŸã‚æ‰±ã„ã¾ã›ã‚“ãŒã€èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯èª¿ã¹ã¦ã¿ã¦ãã ã•ã„ã€‚

## RAGï¼ˆRetrieval Augmented Generationï¼‰ã¨ã¯ãªã«ã‹

RAG(Retrieval Augmented Generation)ã¨ã¯ã€Embeddingæ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã¦LLMã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¿…è¦ãªæƒ…å ±ã‚’æ¤œç´¢ãƒ»æ‹¡å……ã™ã‚‹æŠ€è¡“ã§ã™ã€‚æ¤œç´¢ã«ã¯Embeddingã«ã‚ˆã‚‹é¡ä¼¼åº¦æ¤œç´¢ãŒå¤šãä½¿ã‚ã‚Œã€æœ€çµ‚çš„ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ‹¡å……ã™ã‚‹ã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

LLMã«ã¯ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé™ç•Œã®å•é¡ŒãŒã‚ã‚‹ãŸã‚ã€é–¢é€£ã™ã‚‹æƒ…å ±ã‚’äº‹å‰ã«ã™ã¹ã¦å…¥åŠ›ã™ã‚‹ã®ã¯å›°é›£ã§ã™ã€‚ãã“ã§è³ªå•æ–‡ã‹ã‚‰æ„å‘³ã®è¿‘ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ã—ã¦ã€å¿…è¦ãªçŸ¥è­˜ã‚’æ‹¡å……ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ä¸Šã’ã¦å›ç­”ã•ã›ã‚‹ã€ã¨ã„ã†ä¸€é€£ã®å‡¦ç†ãŒRAGã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚

RAGã¯ä¸€æ™‚æœŸã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé™ç•Œã®å•é¡Œã‚’ä¸€æŒ™ã«è§£æ±ºã™ã‚‹æŠ€è¡“ã®ã‚ˆã†ã«ã‚‚ã¦ã¯ã‚„ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—LLMã®åˆ©ç”¨ç¯„å›²ãŒã•ã‚‰ã«æ‹¡å¤§ã—ãŸçµæœã€å®Ÿéš›ã«ã¯é©ç”¨ç¯„å›²ãŒé™ã‚‰ã‚Œã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ã¾ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶ã®è³ªå•ã«å¯¾ã—ã¦çŸ¥è­˜ã‚„äº‹å®Ÿæƒ…å ±ã‚’ç›´æ¥è¿”ã™ä¸€å•ä¸€ç­”å½¢å¼ã§ã¯æœ‰åŠ¹ã§ã™ãŒã€è¤‡é›‘ãªã‚¿ã‚¹ã‚¯å‡¦ç†ã§ã¯å¿…ãšã—ã‚‚æœ‰ç”¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã¨ãˆã°ä»Šå›ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã§ã‚‚ã€ãƒ­ã‚°ã‚„ãƒ‡ãƒ¼ã‚¿ã‚’APIçµŒç”±ã§å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ã®å…¥åŠ›ã«ã‚‚ã¨ã¥ã„ã¦çŸ¥è­˜ã‚„äº‹å®Ÿæƒ…å ±ã‚’è£œå®Œã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ä¸Šã’ã‚‹ã“ã¨ãŒæœ‰ç”¨ã§ã¯ãªã„ã‚±ãƒ¼ã‚¹ã‚‚å¤šãã‚ã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€RAGãã®ã‚‚ã®ã«ã¤ã„ã¦ã¯LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç›®çš„ã«å¿œã˜ã¦ä½¿ã£ãŸã‚Šä½¿ã‚ãªã‹ã£ãŸã‚Šã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ä»Šå›ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã§ã¯å¾“æ¥ã®RAGã¯ã‚ã¾ã‚Šããã‚ãªã„ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ã®å…¥åŠ›ã‹ã‚‰æ±²ã¿å–ã‚Œã‚‹è£œå®Œæƒ…å ±ãŒã‚ã¾ã‚Šãªã„ãŸã‚ã§ã™ã€‚ã—ã‹ã—Embeddingã®æŠ€è¡“è‡ªä½“ã¯æ´»ç”¨ã®ã—ãŒã„ãŒã‚ã‚‹ãŸã‚ã€ãã‚Œã¯æœ‰åŠ¹æ´»ç”¨ã—ã¦ã„ãã¾ã™ã€‚

```mermaid
flowchart TB
    User((ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼))

    subgraph preparation[ğŸ“š æº–å‚™ãƒ•ã‚§ãƒ¼ã‚º]
        direction TB
        Docs[ğŸ“„ ç¤¾å†…æ–‡æ›¸ãƒ»ãƒ‡ãƒ¼ã‚¿]
        Docs -->|Embedding| VectorDB[(ğŸ—„ï¸ ãƒ™ã‚¯ãƒˆãƒ«DB)]
        Note1[ğŸ’¡ äº‹å‰ã«ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã—ã¦<br/>ä¿å­˜ã—ã¦ãŠã] -.-> VectorDB
    end

    subgraph search[ğŸ” æ¤œç´¢ãƒ»å›ç­”ãƒ•ã‚§ãƒ¼ã‚º]
        direction TB
        App[ğŸ’» ã‚¢ãƒ—ãƒª/ã‚·ã‚¹ãƒ†ãƒ ]
        App -->|è³ªå•ã‚’ãƒ™ã‚¯ãƒˆãƒ«åŒ–| Search[ğŸ” é¡ä¼¼æƒ…å ±ã®æ¤œç´¢]
        Search -->|é–¢ä¿‚ã‚ã‚Šãã†ãª<br/>æƒ…å ±ã‚’å–å¾—| Prompt[ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ]
        Prompt -->|å‘½ä»¤ + æ¤œç´¢ã—ãŸæƒ…å ±| LLM[ğŸ¤– ç”ŸæˆAI]
    end

    User -->|è³ªå•| App
    LLM -->|å›ç­”| User
    VectorDB -.->|é¡ä¼¼åº¦æ¤œç´¢| Search

    style VectorDB fill:#f9f,stroke:#333,stroke-width:2px
    style LLM fill:#bbf,stroke:#333,stroke-width:2px
```

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã«ãŠã‘ã‚‹Embeddingã®åˆ©æ´»ç”¨

## ã„ã‚ã‚†ã‚‹RAGã¨ã—ã¦ã®æ´»ç”¨ã¯é›£ã—ã„

å…ˆè¿°ã—ãŸé€šã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã§ã¯ãƒ¦ãƒ¼ã‚¶å…¥åŠ›ã‚’èµ·ç‚¹ã¨ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ‹¡å……ã¨ã„ã†RAGã®å…¸å‹çš„ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¯é©ç”¨ã—ã«ãã„çŠ¶æ³ã§ã™ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æ‹¡å……ã™ã¹ãçŸ¥è­˜ãŒæ˜ç¢ºã§ãªã„ã“ã¨ã‚„ã€çµ„ç¹”å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’äº‹å‰ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã™ã‚‹ã¨ã„ã£ãŸå…¸å‹çš„ãªæ´»ç”¨æ–¹æ³•ã‚‚é©ã•ãªã„ãŸã‚ã§ã™ã€‚

çµ„ç¹”ãƒãƒªã‚·ãƒ¼ã‚„ã‚µãƒ¼ãƒ“ã‚¹ç’°å¢ƒã®æƒ…å ±ã§ã‚ã‚Œã°ã€ãã‚Œã»ã©å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã«ã¯ãªã‚‰ãšã€äº‹å‰ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å…¥ã‚Œã¦ãŠã‘ã°ååˆ†ãªç¯„å›²ã§ã™ã€‚ã‚‚ã—å¤§é‡ã®çŸ¥è­˜ãŒã‚ã£ã¦é©å®œä¸ãˆãŸã„å ´åˆã§ã‚‚ã€ãƒ¦ãƒ¼ã‚¶ã®å…¥åŠ›ã‹ã‚‰é©åˆ‡ãªæƒ…å ±ã‚’å°å‡ºã™ã‚‹ã®ã¯é›£æ˜“åº¦ãŒé«˜ãã€ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ã‚’æä¾›ã™ã‚‹æ–¹ãŒç¾å®Ÿçš„ã§ã™ã€‚ãŸã ã—ã€ã“ã‚Œã¯Embeddingãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢ã§ã‚ã‚‹å¿…è¦æ€§ã¯ç‰¹ã«ãªãã€ä¾‹ãˆã°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†SaaSã®æ¤œç´¢æ©Ÿèƒ½ã§ååˆ†ã§ã™ã€‚æ—¢å­˜ã®æ¤œç´¢æ©Ÿèƒ½ãŒä¸ååˆ†ãªå ´åˆã«ã€ä»£æ›¿ã¨ã—ã¦Embeddingã‚’æ´»ç”¨ã™ã‚‹ã®ã¯æœ‰åŠ¹ãªé¸æŠè‚¢ã¨ãªã‚Šã¾ã™ã€‚

ã¾ãŸã€IoCï¼ˆIndicator of Compromiseï¼šä¾µå®³æŒ‡æ¨™ï¼‰ã®ã‚ˆã†ã«1æ–‡å­—é•ã„ã§æ„å‘³ãŒå¤‰ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒå¤šãã€å®Œå…¨ä¸€è‡´æ¤œç´¢ã‚’è¦ã™ã‚‹æƒ…å ±ã«ã¤ã„ã¦ã¯ã€æ›–æ˜§æ¤œç´¢ã¯ä¸å‘ãã§ã™ã€‚ã“ã®ã‚ˆã†ãªæƒ…å ±ã‚’æ‰±ã†å ´åˆã¯ã€Embeddingãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢ã§ã¯ãªãã€ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦SQLã‚„APIãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ã‚’æä¾›ã™ã‚‹æ–¹ãŒç¾å®Ÿçš„ã§ã™ã€‚

ã“ã‚Œã‚‰ã®ç†ç”±ã‹ã‚‰ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã®ãŸã‚ã«ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã«Embeddingã‚’åˆ©ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¯ç­†è€…ã®çµŒé¨“ä¸Šã»ã¨ã‚“ã©ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã—æœ‰åŠ¹ãªæ´»ç”¨æ–¹æ³•ãŒã‚ã‚Œã°ãœã²æ•™ãˆã¦ãã ã•ã„ã€‚

## é¡ä¼¼æƒ…å ±ã®æ¤œç´¢æ©Ÿèƒ½ã¨ã—ã¦ã¯æœ‰ç”¨

ä¸€æ–¹ã§ã€Embeddingã‚’ä½¿ã£ãŸé¡ä¼¼æ¤œç´¢è‡ªä½“ã¯ã‹ãªã‚Šæœ‰ç”¨æ€§ã®å¹…ãŒåºƒã„ã¨è¨€ãˆã¾ã™ã€‚ä¸»ãªç”¨é€”ã¨ã—ã¦ã€éå»ã«ç™ºç”Ÿã—ãŸé¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã®æ¤œç´¢ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚ã‚¢ãƒ©ãƒ¼ãƒˆã¯æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã§ã™ãŒã€JSONã«å¤‰æ›ã—ãŸã‚‚ã®ã¯æ™®é€šã«Embeddingã§ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãŸã¨ãˆã°ã€Œæ™‚åˆ»ã‚„IPã‚¢ãƒ‰ãƒ¬ã‚¹ãªã©ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå°‘ã—ã‚ºãƒ¬ã¦ã„ã‚‹ãŒæ¦‚ã­ä¼¼ãŸã‚ˆã†ãªã‚¢ãƒ©ãƒ¼ãƒˆã€ã¨ã„ã†ã‚‚ã®ã‚’æ‰‹è»½ã«æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹1: ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦æ©Ÿèƒ½æä¾›ã—ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«æ¤œç´¢ã•ã›ã‚‹

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå¿…è¦ã«å¿œã˜ã¦é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã“ã¨ã§ã€ä¾‹ãˆã°ãã®ã‚¢ãƒ©ãƒ¼ãƒˆã®å½±éŸ¿ã‚’åˆ†æã™ã‚‹éš›ã«ã€éå»ã«ç™ºç”Ÿã—ãŸé¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã®å‡¦ç†çŠ¶æ³ã‚’å®¹æ˜“ã«ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¡ä»¶ã¨ã—ã¦æ¤œç´¢ã•ã›ã‚‹æ–¹æ³•ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ãŒã€å®Ÿè£…ã‚³ã‚¹ãƒˆãŒé«˜ããªã‚ŠãŒã¡ã§ã™ã€‚ãƒ­ã‚°æ¤œç´¢ã¨åŒæ§˜ã«ã€ã‚¹ã‚­ãƒ¼ãƒã‚„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ¡ã‚¿æƒ…å ±ã€ã‚µãƒ³ãƒ—ãƒ«å€¤ãªã©ã‚’è©³ç´°ã«ä¼ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸä¸€éƒ¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ãŒä¸€è‡´ã—ä»–ã®è¦ç´ ãŒå¤§ããç•°ãªã‚‹çµæœã‚’å–å¾—ã—ã¦ã—ã¾ã†å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚ã‚‚ã¡ã‚ã‚“æ„å›³çš„ã«ã“ã®ã‚ˆã†ãªå³å¯†ãªæ¤œç´¢ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚æœ‰ç”¨ã§ã™ã€‚

ã—ã‹ã—ã€Œé¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ¤œç´¢ã§ãã‚‹ã€ã¨ã„ã†æ©Ÿèƒ½ã‚’ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦æä¾›ã™ã‚‹ã“ã¨ã§ã€å®Ÿè£…ã®æ‰‹é–“ã«å¯¾ã—ã¦å¾—ã‚‰ã‚Œã‚‹ä¾¡å€¤ãŒå¤§ãããªã‚Šã¾ã™ã€‚æ³¨æ„ç‚¹ã¨ã—ã¦ã¯ã€éå»ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒé©åˆ‡ã«å‡¦ç†ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å‡¦ç†ãŒä¸é©åˆ‡ãªå ´åˆã€æ¤œç´¢çµæœã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹æƒ…å ±ã‚‚é™å®šçš„ã«ãªã‚Šã¾ã™ã€‚ã‚¢ãƒ©ãƒ¼ãƒˆã‚’Closeã™ã‚‹éš›ã«ç†ç”±ã‚’è¨˜è¼‰ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¨ã€ãã®æƒ…å ±ã‚’æœ‰åŠ¹æ´»ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹2: é¡ä¼¼ã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä¸€æ‹¬ã§å‡¦ç†ã™ã‚‹ã€ã‚ã‚‹ã„ã¯çµ±åˆã™ã‚‹

å®Ÿã¯ã“ã¡ã‚‰ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ã»ã†ãŒå®Ÿé‹ç”¨ã§ã¯éå¸¸ã«å¼·åŠ›ã§ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆç›£è¦–ã‚’é‹ç”¨ã—ã¦ã„ã‚‹ã¨ã€ã‚¢ãƒ©ãƒ¼ãƒˆãŒå¤§é‡ç™ºç”Ÿã™ã‚‹å ´é¢ã«é­é‡ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã‚ˆãã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã™ã€‚

- æ¤œçŸ¥è¨­å®šãŒé–“é•ã£ã¦ã„ã¦ã‚¢ãƒ©ãƒ¼ãƒˆãŒæš´ç™ºã™ã‚‹
- ãŸã¾ãŸã¾ä½•ã‚‰ã‹ã®æ”»æ’ƒã«ã•ã‚‰ã•ã‚Œã¦ã‚¢ãƒ©ãƒ¼ãƒˆãŒå¤§é‡ç™ºç”Ÿã™ã‚‹
- æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ å´ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒå¤‰æ›´ã•ã‚ŒãŸå½±éŸ¿ã§ã‚¢ãƒ©ãƒ¼ãƒˆãŒæš´ç™ºã™ã‚‹

ã“ã†ã—ãŸä½•ã‚‰ã‹ã®è¦å› ã§å¤§é‡ç™ºç”Ÿã—ãŸï¼ˆã—ã‹ã—å½±éŸ¿ãŒãªã„ã¨ç¢ºä¿¡ã§ãã‚‹ï¼‰ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å…¨ã¦å‡¦ç†ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„çŠ¶æ³ã«ãªã‚Šã¾ã™ã€‚ã²ã©ã„ã¨ãã¯æ•°åƒä»¶ã«ãªã‚‹ã“ã¨ã‚‚ã‚ã‚Šã€ã“ã‚Œã‚’1ä»¶ãšã¤ç¢ºèªã—ã¦ã‚¯ãƒ­ãƒ¼ã‚ºã™ã‚‹ã®ã¯éç¾å®Ÿçš„ã§ã™ã€‚ãã‚Œã§ã¯ä¸€æ‹¬ã§ã‚¯ãƒ­ãƒ¼ã‚ºã™ã‚Œã°ã‚ˆã„ã‹ã¨ã„ã†ã¨ã€ãã‚Œã‚‚é›£ã—ã„å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ã¾ãšã€Œã—ã‚Œã£ã¨1ä»¶å…¨ç„¶é–¢ä¿‚ãªã„ã‚¢ãƒ©ãƒ¼ãƒˆãŒæ··ã–ã£ã¦ã„ãªã„ã‹ï¼Ÿã€ã¨ã„ã†æ‡¸å¿µãŒã‚ã‚Šã¾ã™ã€‚ä¼¼ãŸã‚ˆã†ãªã‚¢ãƒ©ãƒ¼ãƒˆã§ã‚ã‚Œã°ä¸€æ‹¬å‡¦ç†ã—ã¦ã‚‚å¤§ä¸ˆå¤«ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ãŒã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã§çµã‚Šè¾¼ã‚‚ã†ã¨ã™ã‚‹ã¨ã€åŒã˜ç¨®é¡ã®ã‚¢ãƒ©ãƒ¼ãƒˆã§ã‚ã£ã¦ã‚‚ã¾ã£ãŸãç•°ãªã‚‹çŠ¶æ³ã®ã‚‚ã®ãŒæ··ã–ã£ã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ãªå‡¦ç†ã®ç…©é›‘ã•ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ã®æ»ã‚Šã«ã¤ãªãŒã‚‹ã“ã¨ã‚‚çã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆç­†è€…ã‚‚ã‚ˆãçµŒé¨“ã—ã¦ã„ã¾ã—ãŸï¼‰ã€‚

ã“ã®èª²é¡Œã‚’Embeddingã‚’ä½¿ã£ã¦è§£æ±ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ä¸€æ‹¬ã‚¯ãƒ­ãƒ¼ã‚ºå¯¾è±¡ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ãªæ‰‹é †ã§æ¤œç´¢ã—ã¾ã™ã€‚ã¾ãšé¡ä¼¼åº¦ã®é–¾å€¤ã‚’è¨­ã‘ã¦è¶³åˆ‡ã‚Šã—ã¾ã™ã€‚ä¾‹ãˆã°é–¾å€¤ã‚’0.1ä»¥ä¸‹ã«è¨­å®šã™ã‚‹ã¨ã€éå¸¸ã«é¡ä¼¼ã—ãŸã‚¢ãƒ©ãƒ¼ãƒˆã®ã¿ãŒæŠ½å‡ºã•ã‚Œã¾ã™ã€‚æ¬¡ã«ã€æŠ½å‡ºã•ã‚ŒãŸã‚¢ãƒ©ãƒ¼ãƒˆã«å¯¾ã—ã¦ã•ã‚‰ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‹ã‘ã¾ã™ã€‚ã“ã‚Œã¯ã€Œä¼¼ã¦ã¯ã„ã‚‹ãŒã€æ„å›³ã—ã¦ã„ãªã„ã‚¢ãƒ©ãƒ¼ãƒˆãŒç´›ã‚Œã¦ã„ãªã„ã‹ã€ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã§ã™ã€‚ã‚‚ã¡ã‚ã‚“ãã‚Œã§ã‚‚ç´›ã‚Œè¾¼ã‚€å¯èƒ½æ€§ã¯0ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ä½œæ¥­é‡ã‚’å¤§å¹…ã«ç·©å’Œã§ãã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«é¡ä¼¼åº¦ã®é–¾å€¤ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€æ¦‚ã­æ„å›³ã—ãŸé–¢é€£ã‚¢ãƒ©ãƒ¼ãƒˆä¸€è¦§ã‚’æŠ½å‡ºã§ãã¾ã™ã€‚ã“ã‚Œã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã™ã‚‹ãªã‚Šã€åˆ¥ã®ã‚¢ãƒ©ãƒ¼ãƒˆã«ãƒãƒ¼ã‚¸ã™ã‚‹ãªã‚Šã™ã‚Œã°ã‚·ã‚¹ãƒ†ãƒ ä¸Šã¾ã¨ã‚ã¦å‡¦ç†ã§ãã¾ã™ã€‚ã“ã®æ–¹æ³•ã¯ä½œæ¥­æ™‚é–“ã®å‰Šæ¸›ã ã‘ã§ãªãã€ç²¾ç¥çš„è² æ‹…ã®è»½æ¸›ã¨ã„ã†è¦³ç‚¹ã§ã‚‚å¤§ããªåŠ¹ç‡åŒ–ã«ãªã‚Šã¾ã™ã€‚

# Embeddingã®å®Ÿè£…

ä»Šå›ã¯ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹2ã¨ã—ã¦ã€é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ¤œç´¢ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚æ¤œç´¢å¾Œã®ã‚¯ãƒ­ãƒ¼ã‚ºã‚„ãƒãƒ¼ã‚¸ã¨ã„ã£ãŸå‡¦ç†ã¯ã€æœ¬è¨˜äº‹ã§ã¯æ‰±ã„ã¾ã›ã‚“ãŒã€åŒæ§˜ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§å®Ÿè£…ã§ãã¾ã™ã€‚ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦æ¤œç´¢æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹å ´åˆã‚‚åŸºæœ¬çš„ã«ã¯åŒã˜å®Ÿè£…ã«ãªã‚‹ãŸã‚ã€ä»Šå›ã¯èª¬æ˜ã‚’å‰²æ„›ã—ã¾ã™ã€‚

## Firestoreã®indexä½œæˆ

ã¾ãšFirestoreã§ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã‚’ä½¿ã†å ´åˆã€Indexã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚ãªãŠã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¨ãƒ™ã‚¯ãƒˆãƒ«ã®æ¬¡å…ƒæ•°ã¯ã“ã®æ™‚ç‚¹ã§æ±ºå®šã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¾ãŸé‡è¦ãªãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã€ãã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ãªã„ã€ã‚ã‚‹ã„ã¯0ãƒ™ã‚¯ãƒˆãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã¨ã€Firestoreã§ã¯æ¤œç´¢ã«å¤±æ•—ã™ã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ãã®ãŸã‚ã€Embeddingã‚’å°å…¥ã™ã‚‹éš›ã¯æ–°ã—ã„collectionã‚’ä½¿ã†ã‹ã€æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã«å¾Œã‹ã‚‰Embeddingã‚’è¿½åŠ ã™ã‚‹å‡¦ç†ãŒå¿…è¦ã§ã™ã€‚

```bash
gcloud firestore indexes composite create \
    --project=your-project \
    --database=your-database \
    --collection-group=alerts \
    --query-scope=COLLECTION \
    --field-config=vector-config='{"dimension":"768","flat": "{}"}',field-path=Embedding
```

## Embeddingã®ç”Ÿæˆ

Embeddingã®ç”Ÿæˆã¯éå¸¸ã«ç°¡å˜ã§ã™ã€‚Geminiã®å ´åˆã¯ `EmbedContent` ã‚’å‘¼ã³å‡ºã™ã ã‘ã§å®Œäº†ã—ã¾ã™ã€‚æ³¨æ„ã™ã¹ããƒã‚¤ãƒ³ãƒˆã¯æ¬¡å…ƒæ•°ã®è¨­å®šã§ã™ã€‚ã“ã‚Œã¯Firestoreå´ã§è¨­å®šã—ãŸæ¬¡å…ƒæ•°ã«åˆã‚ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ¬¡å…ƒæ•°ã‚’å¢—ã‚„ã™ã»ã©ç´°ã‹ã„æ„å‘³ã®é•ã„ã‚’è¡¨ç¾ã§ãã¾ã™ãŒã€è¨ˆç®—ã‚³ã‚¹ãƒˆã‚„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚å¢—åŠ ã—ã¾ã™ã€‚ä¸€èˆ¬çš„ã«512ã€œ768æ¬¡å…ƒã§ååˆ†ãªç²¾åº¦ãŒå¾—ã‚‰ã‚Œã‚‹ãŸã‚ã€ä»Šå›ã¯768æ¬¡å…ƒã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

```go:pkg/adapter/gemini.go
func (g *GeminiClient) Embedding(ctx context.Context, text string, dimensions int) (firestore.Vector32, error) {
	config := &genai.EmbedContentConfig{}
	if dimensions > 0 {
		d := int32(dimensions)
		config.OutputDimensionality = &d
	}

	resp, err := g.client.Models.EmbedContent(ctx, g.embeddingModel, genai.Text(text), config)
	if err != nil {
		return nil, goerr.Wrap(err, "failed to embed content")
	}

	if len(resp.Embeddings) == 0 {
		return nil, goerr.New("no embeddings returned")
	}

	return firestore.Vector32(resp.Embeddings[0].Values), nil
}
```

## Alertã¸ã®åŸ‹ã‚è¾¼ã¿

æ¬¡ã«ã€ã‚¢ãƒ©ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã«Embeddingã‚’åŸ‹ã‚è¾¼ã¿ã¾ã™ã€‚å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã€`PutAlert` ã™ã‚‹ç›´å‰ã«Embeddingã‚’ç”Ÿæˆã—ã¦æ ¼ç´ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

```go
// Generate embedding vector from original alert data
embedding, err := u.gemini.Embedding(ctx, string(jsonData), 768)
if err != nil {
    return nil, goerr.Wrap(err, "failed to generate embedding")
}
alert.Embedding = embedding

if err := u.repo.PutAlert(ctx, alert); err != nil {
    return nil, err
}
```

Goå®Ÿè£…ã«ãŠã‘ã‚‹ãƒã‚¤ãƒ³ãƒˆã¯ã€`firestore.Vector32` ã‚ã‚‹ã„ã¯ `Vector64` ã‚’ä½¿ã†ã“ã¨ã§ã™ã€‚ã“ã‚Œã‚’ä½¿ã‚ãªã„ã¨ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ç”¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦æ­£ã—ãèªè­˜ã•ã‚Œã¾ã›ã‚“ã€‚

```go
type Alert struct {
	ID          AlertID
	Title       string
	Description string
	Data        any
	Attributes  []*Attribute
	Embedding   firestore.Vector32
```

## Alertã®æ¤œç´¢

æ¬¡ã«ã€é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ¤œç´¢ã™ã‚‹å®Ÿè£…ã§ã™ã€‚Firestoreã®ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚

```go:pkg/repository/firestore.go
func (r *Firestore) SearchSimilarAlerts(ctx context.Context, embedding []float64, threshold float64) ([]*model.Alert, error) {
	client, err := r.getClient(ctx)
	if err != nil {
		return nil, err
	}

	// Convert []float64 to firestore.Vector32
	vector32 := make(firestore.Vector32, len(embedding))
	for i, v := range embedding {
		vector32[i] = float32(v)
	}

	// Build vector query with distance threshold
	query := client.Collection(alertCollection).
		FindNearest("Embedding", vector32, 1000, firestore.DistanceMeasureCosine, &firestore.FindNearestOptions{
			DistanceThreshold: &threshold,
		})

	// Execute query
	iter := query.Documents(ctx)
	defer iter.Stop()
```

ã“ã“ã§ã¯ `FindNearest` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚ç¬¬3å¼•æ•°ã®1000ã¯ã€æœ€å¤§1000ä»¶ã®é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚ãƒ™ã‚¯ãƒˆãƒ«ã®è·é›¢ã®è¨ˆç®—ã«ã¯ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢ã€ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã€ãƒ‰ãƒƒãƒˆç©ãŒé¸æŠã§ãã¾ã™ãŒã€Embeddingãƒ™ã‚¯ãƒˆãƒ«ã¯æ­£è¦åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ãŒæœ€ã‚‚é©åˆ‡ãªè·é›¢æŒ‡æ¨™ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚è©³ã—ã„ç†è«–çš„èƒŒæ™¯ã«ã¤ã„ã¦ã¯é–¢å¿ƒãŒã‚ã‚‹æ–¹ã¯èª¿ã¹ã¦ã¿ã¦ãã ã•ã„ã€‚

## CLIã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…

æ¬¡ã«ã€`similar` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè£…ã—ã¦é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚æŒ‡å®šã•ã‚ŒãŸIDã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å–å¾—ã—ã€ãã®Embeddingã®å€¤ã‚’ä½¿ã£ã¦é¡ä¼¼ã™ã‚‹ã‚‚ã®ã‚’æ¤œç´¢ã—ã¾ã™ã€‚å–å¾—ã—ãŸçµæœã‹ã‚‰ã•ã‚‰ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹ã“ã¨ã§ã€æ„å›³ã—ãªã„ã‚¢ãƒ©ãƒ¼ãƒˆãŒæ··å…¥ã™ã‚‹ã®ã‚’é˜²ãã¾ã™ã€‚

```go:pkg/cli/similar.go
// Get the source alert
sourceAlert, err := repo.GetAlert(ctx, model.AlertID(alertID))
if err != nil {
    return goerr.Wrap(err, "failed to get source alert")
}

if len(sourceAlert.Embedding) == 0 {
    return goerr.New("source alert does not have an embedding vector")
}

// Search for similar alerts with threshold
similarAlerts, err := repo.SearchSimilarAlerts(ctx, sourceAlert.Embedding, threshold)
if err != nil {
    return goerr.Wrap(err, "failed to search similar alerts")
}

// Filter alerts
var filtered []*model.Alert

for _, alert := range similarAlerts {
    // Skip the source alert itself
    if alert.ID == sourceAlert.ID {
        continue
    }

    // Apply keyword filters (AND condition) on alert data
    if len(filters) > 0 {
        // Marshal alert data to JSON for filtering
        dataJSON, err := json.Marshal(alert.Data)
        if err != nil {
            return goerr.Wrap(err, "failed to marshal alert data", goerr.Value("alert_id", alert.ID))
        }
        dataStr := string(dataJSON)

        allMatch := true
        for _, filter := range filters {
            if !strings.Contains(dataStr, filter) {
                allMatch = false
                break
            }
        }
        if !allMatch {
            continue
        }
    }

    filtered = append(filtered, alert)
}
```

## å®Ÿè¡Œä¾‹

ä»¥ä¸‹ã¯ã€ã‚ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆæš—å·é€šè²¨ãƒã‚¤ãƒ‹ãƒ³ã‚°æ¤œå‡ºï¼‰ã«å¯¾ã—ã¦é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ¤œç´¢ã—ãŸå®Ÿè¡Œä¾‹ã§ã™ã€‚

### é–¾å€¤0.1ã®å ´åˆ

```bash
$ go run . similar -i 69a6df97-b36f-49d4-87bb-3643246b4a4c -t 0.1
Found 2 similar alerts for 69a6df97-b36f-49d4-87bb-3643246b4a4c (Cryptocurrency Miner (XMRig) Detected on 'web-server-prod-01' due to CVE-2023-32784):

1. 8344452d-bdb9-4e64-9121-b1b2b0d14744 (distance: 0.0000)
   Title: Cryptominer (XMRig) Detected on Instance 'web-server-prod-01'
   Description: A cryptocurrency mining software (XMRig) has been detected running on Compute Engine instance 'web-server-prod-01'. This instance is connecting to known Monero mining pools and consuming significant CPU resources, indicating a potential compromise via CVE-2023-32784 from an attacker in Romania. Immediate investigation and remediation are required to prevent further resource abuse and potential data exposure.

2. a859cb2f-9392-4ceb-9420-c554f9b63766 (distance: 0.0120)
   Title: Cryptocurrency Mining Detected on Compute Engine Instance
   Description: Cryptocurrency mining software (XMRig) has been detected running on the 'web-server-prod-01' instance, consuming 98.5% CPU resources. The instance is connecting to a known Monero mining pool, indicating a potential compromise and resource abuse.
```

é–¾å€¤ã‚’0.1ã«è¨­å®šã—ãŸå ´åˆã€2ä»¶ã®é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚1ä»¶ç›®ï¼ˆ`examples/alert/scc.json`ï¼‰ã¯distanceãŒ0.0000ã§ã»ã¼å®Œå…¨ä¸€è‡´ã®å†…å®¹ã€2ä»¶ç›®ï¼ˆ`examples/alert/scc_mini.json`ï¼‰ã¯distanceãŒ0.0120ã§éå¸¸ã«é¡ä¼¼ã—ãŸå†…å®¹ã¨ãªã£ã¦ã„ã¾ã™ã€‚

### é–¾å€¤0.01ã®å ´åˆ

```bash
$ go run . similar -i 69a6df97-b36f-49d4-87bb-3643246b4a4c -t 0.01
Found 1 similar alerts for 69a6df97-b36f-49d4-87bb-3643246b4a4c (Cryptocurrency Miner (XMRig) Detected on 'web-server-prod-01' due to CVE-2023-32784):

1. 8344452d-bdb9-4e64-9121-b1b2b0d14744 (distance: 0.0000)
   Title: Cryptominer (XMRig) Detected on Instance 'web-server-prod-01'
   Description: A cryptocurrency mining software (XMRig) has been detected running on Compute Engine instance 'web-server-prod-01'. This instance is connecting to known Monero mining pools and consuming significant CPU resources, indicating a potential compromise via CVE-2023-32784 from an attacker in Romania. Immediate investigation and remediation are required to prevent further resource abuse and potential data exposure.
```

é–¾å€¤ã‚’0.01ã«ä¸‹ã’ã‚‹ã¨ã€ã‚ˆã‚Šå³å¯†ãªé¡ä¼¼åº¦åˆ¤å®šã¨ãªã‚Šã€ã»ã¼åŒä¸€ã®å†…å®¹ã®ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆ`examples/alert/scc.json`ï¼‰ã®ã¿ãŒæŠ½å‡ºã•ã‚Œã¾ã—ãŸã€‚å®Ÿéš›ã®é‹ç”¨ã§ã¯ã€èª¤æ¤œçŸ¥ã‚’é¿ã‘ãŸã„å ´åˆã¯0.01ã®ã‚ˆã†ãªä½ã„é–¾å€¤ã‚’ã€ã‚ˆã‚Šå¤šãã®å€™è£œã‚’è¦‹ãŸã„å ´åˆã¯0.1ç¨‹åº¦ã®é–¾å€¤ã‚’ä½¿ã†ãªã©ã€ç›®çš„ã«å¿œã˜ã¦èª¿æ•´ã—ã¾ã™ã€‚

# ã¾ã¨ã‚

Embeddingã«é–¢ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã®ä¸€ã¤ã¯ã€Embeddingã¯RAGã ã‘ã®ã‚‚ã®ã§ã¯ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚Embeddingã¯ä¸€èˆ¬çš„ã«RAGã®æ–‡è„ˆã§èªã‚‰ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ãŒã€RAGãªã—ã§ã‚‚å¼·åŠ›ã«æ´»ç”¨ã§ãã¾ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã¯ãã®ä»£è¡¨ä¾‹ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ã®å…¥åŠ›ã«å¯¾ã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ‹¡å……ã™ã¹ãçŸ¥è­˜ãŒæ˜ç¢ºã«å­˜åœ¨ã—ãªã„ãŸã‚ã€RAGã¨ã—ã¦ã¯åŠ¹æœãŒé™å®šçš„ã§ã™ãŒã€é¡ä¼¼ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œç´¢ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã€ç•°å¸¸æ¤œçŸ¥ã¨ã„ã£ãŸç”¨é€”ã§ã¯ã€Embeddingã®ä¾¡å€¤ãŒç›´æ¥ç™ºæ®ã•ã‚Œã¾ã™ã€‚ç‰¹ã«ã‚¢ãƒ©ãƒ¼ãƒˆã®ã‚ˆã†ã«ã‚¹ã‚­ãƒ¼ãƒãŒå¤šæ§˜ãªæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é¡ä¼¼äº‹ä¾‹ã‚’æ¢ã™å ´åˆã€å¾“æ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã‚„æ¡ä»¶æŒ‡å®šã§ã¯å®Ÿç¾å›°é›£ã ã£ãŸæŸ”è»Ÿãªæ¤œç´¢ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

ã‚‚ã†ä¸€ã¤é‡è¦ãªã®ã¯ã€Embeddingã«ã‚ˆã‚‹é¡ä¼¼åº¦æ¤œç´¢ã ã‘ã§ã¯ä¸ååˆ†ã§ã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«åˆã‚ã›ãŸå·¥å¤«ãŒå¿…è¦ã ã¨ã„ã†ã“ã¨ã§ã™ã€‚RAGã«ãŠã„ã¦ã‚‚rerankingãªã©ã®ä»•çµ„ã¿ãŒå­˜åœ¨ã™ã‚‹ã‚ˆã†ã«ã€å˜ç´”ãªé¡ä¼¼åº¦æ¤œç´¢ã®çµæœã‚’ãã®ã¾ã¾ä½¿ã†ã®ã§ã¯ãªãã€ç›®çš„ã«å¿œã˜ãŸå¾Œå‡¦ç†ã‚„è¿½åŠ ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’çµ„ã¿è¾¼ã‚€ã¹ãã§ã™ã€‚ä»Šå›ã®å®Ÿè£…ã§ã¯ã€é¡ä¼¼åº¦ã®é–¾å€¤ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€æ„å›³ã—ãªã„ã‚¢ãƒ©ãƒ¼ãƒˆã®æ··å…¥ã‚’é˜²ãã¤ã¤ã€æŸ”è»Ÿãªæ¤œç´¢ã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚

ã€Œæ„å‘³çš„ã«ä¼¼ãŸã‚‚ã®ã‚’è¦‹ã¤ã‘ãŸã„ã€ã¨ã„ã†ãƒ‹ãƒ¼ã‚ºã«å¯¾ã—ã¦LLMã‚µãƒ¼ãƒ“ã‚¹ãŒæä¾›ã—ã¦ã„ã‚‹Embeddingã¯å¼·åŠ›ãªæ­¦å™¨ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚ã“ã‚Œã¯æ§˜ã€…ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§æ´»ç”¨ã§ãã‚‹ã¨è€ƒãˆã‚‰ã‚Œã€ã†ã¾ãå¿œç”¨ã™ã‚‹ã“ã¨ã§å®Ÿç”¨çš„ãªã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ãŒæœŸå¾…ã§ãã¾ã™ã€‚

