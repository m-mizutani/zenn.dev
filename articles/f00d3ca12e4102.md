---
title: "OPAã‚³ãƒžãƒ³ãƒ‰ã®åˆ©ç”¨"
emoji: "ðŸ–¨ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["opa", "rego"]
published: true
---

ã“ã®è¨˜äº‹ã¯[OPA/Regoã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼](https://adventar.org/calendars/6601)ã®11æ—¥ç›®ã§ã™ã€‚

ä»Šå›žã¯ `opa` ã‚³ãƒžãƒ³ãƒ‰ã«ã¤ã„ã¦ã§ã™ã€‚`opa`ã‚³ãƒžãƒ³ãƒ‰ã¯ã„ã‚ã„ã‚ãªæ©Ÿèƒ½ã‚’ã‚µãƒ–ã‚³ãƒžãƒ³ãƒ‰ã§å‚™ãˆã¦ã„ã¾ã™ãŒã€ã‚ˆãä½¿ã†ã¨æ€ã‚ã‚Œã‚‹éƒ¨åˆ†ã«çµžã£ã¦ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ã‚³ãƒžãƒ³ãƒ‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ã¤ã„ã¦ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.openpolicyagent.org/docs/v0.11.0/get-started/#prerequisites)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚macOSã§ã‚ã‚Œã° homebrew ã‹ã‚‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚‚å¯èƒ½ã§ã™ã€‚


# run

OPAã®å®Ÿè¡Œç’°å¢ƒã‚’ä½œã‚‹ãŸã‚ã®ã‚³ãƒžãƒ³ãƒ‰ã§ã™ã€‚å¤§ããåˆ†ã‘ã¦ 1) CLIã§ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã«ã‚¯ã‚¨ãƒªã‚’æ‰“ã¡è¾¼ã‚ã‚‹ã‚·ã‚§ãƒ«ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã€2) ã‚µãƒ¼ãƒã¨ã—ã¦èµ·å‹•ã—ã¦HTTPã«ã‚ˆã£ã¦æ“ä½œã™ã‚‹2ã¤ã®ãƒ¢ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚

## ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰

ãƒãƒªã‚·ãƒ¼ã®ãƒ‡ãƒãƒƒã‚°ã‚’ã™ã‚‹ã®ã«ä¾¿åˆ©ãªãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚`./policy` ã«ãƒãƒªã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«èµ·å‹•ã—ã¾ã™ã€‚

```shell
$ opa run ./policy
OPA 0.34.2 (commit , built at )

Run 'help' to see a list of commands and check for updates.
>
```

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã™ã‚‹ã¨å†å¸°çš„ã«JSONã€YAMLã€Regoã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŽ¢ç´¢ã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã€‚ã¾ãŸã€ã“ã“ã§æŒ‡å®šã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãƒ«ãƒ¼ãƒˆã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚Regoãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã§ãƒ‘ã‚¹ãŒæ±ºå®šã™ã‚‹ã®ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¯æ°—ã«ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ã¯ã©ã“ã‚’ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãªã‚‹ã‹ã§ãƒ‘ã‚¹ãŒå¤‰ã‚ã£ã¦ã—ã¾ã†ãŸã‚ã€æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

`input` ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ãŸã„å ´åˆã€ã¡ã‚‡ã£ã¨ç‰¹æ®Šã§ã™ãŒ `mydata.json` ã‚’ä½¿ã†ã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«æŒ‡å®šã—ã¾ã™ã€‚

```
$ opa run ./policy repl.input:mydata.json
```

ã•ã‚‰ã«ãƒ‡ãƒãƒƒã‚°ç›®çš„ã®å ´åˆã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åº¦ã€…å¤‰æ›´ã™ã‚‹ã“ã¨ã«ãªã‚‹ã¨æ€ã‚ã‚Œã‚‹ã®ã§ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ `-w` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ã®ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

```
$ opa run -w ./policy repl.input:mydata.json
```

ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã¨ã‚Šã‚ãˆãš `data` ã¨æ‰“ã¤ã“ã¨ã§èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŠã‚ˆã³ãƒãƒªã‚·ãƒ¼ãŒä¸€è¦§ã§ãã¾ã™ã€‚

```
> data
{
  "example": {
    "allow": true,
    "roles": [
      "admin",
      "developer"
    ]
  },
  "repl": {
    "input": {
      "user": "blue"
    }
  }
}
```

å¿…è¦ã«å¿œã˜ã¦çµžã‚Šè¾¼ã¿ãŒã§ãã¾ã™ã€‚

```
> data.example
{
  "allow": true,
  "roles": [
    "admin",
    "developer"
  ]
}
> data.example.roles
[
  "admin",
  "developer"
]
```

çµæžœãŒ2ã¤ä»¥ä¸Šã«ãªã‚‹å ´åˆã€çµæžœã®çµ„ã¿åˆã‚ã›ã‚’è¡¨å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã‚Œã¾ã™ã€‚

```
> data.example.roles[x]
+---+-----------------------+
| x | data.example.roles[x] |
+---+-----------------------+
| 0 | "admin"               |
| 1 | "developer"           |
+---+-----------------------+
```

## ã‚µãƒ¼ãƒãƒ¢ãƒ¼ãƒ‰

ã‚µãƒ¼ãƒã¨ã—ã¦ä½¿ã†å ´åˆã¯ `-s` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸Žã—ã¾ã™ã€‚

```
$ opa run -s
{"addrs":[":8181"],"diagnostic-addrs":[],"level":"info","msg":"Initializing server.","time":"2021-12-11T17:38:10+09:00"}
```

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ `:8181` ã§HTTPã‚µãƒ¼ãƒã‚’ç«‹ã¡ä¸Šã’ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

```bash
% curl http://localhost:8181/v1/data | jq
*   Trying ::1:8181...
* Connected to localhost (::1) port 8181 (#0)
> GET /v1/data HTTP/1.1
> Host: localhost:8181
> User-Agent: curl/7.77.0
> Accept: */*
>
* Mark bundle as not supporting multiuse
< HTTP/1.1 200 OK
< Content-Type: application/json
< Date: Sat, 11 Dec 2021 08:40:58 GMT
< Content-Length: 54
<
* Connection #0 to host localhost left intact
{
  "result": {
    "example": {
      "roles": [
        "admin",
        "developer"
      ]
    }
  }
}
```

`/v1/data` ãŒ `data` ã¨åŒæ§˜ã®æ„å‘³ã‚’ã‚‚ã¡ã¾ã™ã€‚ä¾‹ãˆã° `/v1/data/example` ã¨ã™ã‚‹ã“ã¨ã§ã€ `data.example` ã¨åŒæ§˜ã®çµæžœã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
$ curl http://localhost:8181/v1/data/example | jq
{
  "result": {
    "roles": [
      "admin",
      "developer"
    ]
  }
}
```

`input` ã‚’æ¸¡ã—ãŸã„å ´åˆã¯ `POST` ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã™ã€‚

```bash
$ curl -X POST http://localhost:8181/v1/data/example -d '{"input":{"user":"blue"}}' | jq
{
  "result": {
    "allow": true,
    "roles": [
      "admin",
      "developer"
    ]
  }
}
```

åŸºæœ¬çš„ãªå‹•ä½œã¯ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰ã¨åŒã˜ã§ã™ãŒã€ã‚µãƒ¼ãƒã«`input`ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™éš›ã¯ `{"input": ... }` ã®å½¢å¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ä¸€æ–¹ã‚µãƒ¼ãƒã‹ã‚‰ã®çµæžœã¯ `{"result": ... }` ã®å½¢å¼ã«ãªã£ã¦ã„ã‚‹ã¨ã„ã†ç‚¹ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚`input`ã®ä¸­èº«ã ã‘æ¸¡ã—ã¦æœŸå¾…ã—ãŸå‹•ãã‚’ã—ãªã„ã€ã¨ã„ã†ãƒãƒžã‚Šæ–¹ãŒå¤šã„ã‚ˆã†ã§ã™ã€‚

ã“ã®ä»–ã€APIã®è©³ç´°ã«ã¤ã„ã¦ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.openpolicyagent.org/docs/latest/integration/#integrating-with-the-rest-api)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã‚µãƒ¼ãƒã®é‹ç”¨äº‹ä¾‹ã«ã¤ã„ã¦ã¯ã€å¾Œæ—¥åˆ¥ã®è¨˜äº‹ã§ç´¹ä»‹ã—ã¾ã™ã€‚

# eval

CLIã§ãƒãƒªã‚·ãƒ¼ã‚’è©•ä¾¡ã—ãŸã„ã¨ãã«åˆ©ç”¨ã™ã‚‹ã‚µãƒ–ã‚³ãƒžãƒ³ãƒ‰ã§ã™ã€‚ä¾‹ãˆã°GitHub Actionã®CIã§ãªã‚“ã‚‰ã‹ã®ã‚¹ã‚­ãƒ£ãƒ³çµæžœã‚’å‡ºåŠ›ã—ãŸå¾Œã€ãã®çµæžœã«åŸºã¥ã„ã¦CIã‚’æˆåŠŸãƒ»ã‚ã‚‹ã„ã¯å¤±æ•—ã•ã›ã‚‹ã¨ã„ã£ãŸåˆ¤å®šã‚’ã™ã‚‹ã¨ã„ã£ãŸãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒæƒ³å®š[^judge]ã•ã‚Œã¾ã™ã€‚

```bash
$ opa eval -b ./rego/example/ data
{
  "result": [
    {
      "expressions": [
        {
          "value": {
            "example": {
              "roles": [
                "admin",
                "developer"
              ]
            }
          },
          "text": "data",
          "location": {
            "row": 1,
            "col": 1
          }
        }
      ]
    }
  ]
}
```

`eval` ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å‡ºåŠ›å½¢å¼ãŒJSONã«ãªã£ã¦ãŠã‚Šã€ã‹ã¤çµæžœãŒå¼ï¼ˆ `expressions` ï¼‰ã¨å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸå¤‰æ•°ï¼ˆ `bindings` ï¼‰ã«åˆ†è£‚ã—ã¾ã™ã€‚ã‚³ãƒžãƒ³ãƒ‰ã®æœ€å¾Œã®å¼•æ•°ãŒã‚¯ã‚¨ãƒªã«ãªã£ã¦ãŠã‚Šã€å¤‰æ•°ã®å‰²å½“ã‚’ã™ã‚‹ã¨ã€`bindings`ã®æ–¹ã«å€¤ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```bash
$ opa eval -b ./rego/example/ 'x := data'
{
  "result": [
    {
      "expressions": [
        {
          "value": true,
          "text": "x := data",
          "location": {
            "row": 1,
            "col": 1
          }
        }
      ],
      "bindings": {
        "x": {
          "example": {
            "roles": [
              "admin",
              "developer"
            ]
          }
        }
      }
    }
  ]
}
```

è§£é‡ˆãŒç…©ã‚ã—ã„ã®ã§ `run` ã®ã¨ãã¨åŒã˜å½¢å¼ã§è¦‹ãŸã„ã€ã¨ã„ã†å ´åˆã¯ `-f pretty` ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

```bash
$ opa eval -f pretty -b ./rego/example/ 'x := data'
+---------------------------------------------+
|                      x                      |
+---------------------------------------------+
| {"example":{"roles":["admin","developer"]}} |
+---------------------------------------------+
```

ãã®ä»–ã€ã‚ˆãä½¿ã„ãã†ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã„ãã¤ã‹ç´¹ä»‹ã—ã¾ã™ã€‚

- `--fail`: ã‚¯ã‚¨ãƒªã®çµæžœãŒçµæžœãŒç©ºã€ã‚ã‚‹ã„ã¯æœªå®šç¾©ã ã£ãŸå ´åˆã«ãƒ—ãƒ­ã‚»ã‚¹ã‚’éžã‚¼ãƒ­å€¤ã§ç•°å¸¸çµ‚äº†ã•ã›ã¾ã™
- `--fail-defined`: `--fail` ã¨ã¯é€†ã§ã€ã‚¯ã‚¨ãƒªã®çµæžœãŒå®šç¾©æ¸ˆã¿ã ã£ãŸå ´åˆã«ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç•°å¸¸çµ‚äº†ã•ã›ã¾ã™ã€‚OPAã§ã¯ã€Œå•é¡Œã‚’ç™ºè¦‹ã—ãŸã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™ã€ã¨ã„ã†ãƒãƒªã‚·ãƒ¼ã®æ›¸ãæ–¹ãŒã‚ˆãè¦‹ã‚‰ã‚Œã€ãã®ä½¿ã„æ–¹ã ã¨ã“ã¡ã‚‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒä¾¿åˆ©ã§ã™
- `--input`: `input`ã«ä½¿ã†JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¾ã™ã€‚
- `--stdin-input`: `input`ã«ä½¿ã†ãƒ‡ãƒ¼ã‚¿ã‚’æ¨™æº–å…¥åŠ›ã‹ã‚‰å—ã‘å–ã‚Œã¾ã™ã€‚

[^judge]: ã‚‚ã¡ã‚ã‚“ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å«ã‚€ä»–ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªžã§åˆ¤å®šã®å‡¦ç†ã‚’ã™ã‚‹ã¨ã„ã†é¸æŠžè‚¢ã‚‚ã‚ã‚Šã¾ã™ã€‚