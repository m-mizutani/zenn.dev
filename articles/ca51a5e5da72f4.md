---
title: "Goè¨€èªã«ã‚ˆã‚‹Rego runtimeã®çµ„ã¿è¾¼ã¿"
emoji: "ğŸ¹"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["opa", "rego", "go"]
published: true
---

ã“ã®è¨˜äº‹ã¯[OPA/Regoã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼](https://adventar.org/calendars/6601)ã®16æ—¥ç›®ã§ã™ã€‚

ä»Šå›ã¯Goè¨€èªã‹ã‚‰Regoã®runtimeã‚’å‘¼ã³å‡ºã—ã€ãƒãƒªã‚·ãƒ¼ã®è©•ä¾¡çµæœã‚’æ±‚ã‚ã‚‹æ‰‹é †ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã¾ãšã¯Goã®é–‹ç™ºç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚ã“ã®è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®ç’°å¢ƒã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ã€‚

- go: `1.17.2 darwin/arm64`
- opa: `v0.34.2`

Goé–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ãªã©ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

- https://go.dev/doc/install

æº–å‚™ãŒã§ããŸã‚‰ä»¥ä¸‹ã®é€šã‚Šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æº–å‚™ã‚’ã—ã¾ã™ï¼ˆä¸‹è¨˜ã®è§£èª¬ã§ã¯ `regotest` ã‚’ä½œæ¥­ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ä»®å®šã—ã¾ã™ãŒã€åˆ¥ã®åå‰ã§ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼‰

```sh
$ mkdir regotest
$ cd regotest
$ go mod init regotest
$ go get github.com/open-policy-agent/opa/rego
```

# Regoãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®åˆ©ç”¨

ã¾ãšã¯ã‚·ãƒ³ãƒ—ãƒ«ãªå…·ä½“ä¾‹ã‹ã‚‰è¦‹ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ `main.go` ã¨ã—ã¦ `./regotest` ä»¥ä¸‹ã«ä¿å­˜ã—ã¾ã™ã€‚

```go:main.go
package main

import (
	"context"
	"fmt"

	"github.com/open-policy-agent/opa/rego"
)

func main() {
	input := struct {
		User string `json:"user"`
	}{
		User: "mizutani",
	}

	module := `package blue

	allow {
		input.user == "mizutani"
	}
	`

	q := rego.New(
		rego.Query(`x := data.blue.allow`),
		rego.Module("module.rego", module),
		rego.Input(input),
	)

	rs, err := q.Eval(context.Background())
	if err != nil {
		panic(err)
	}

	fmt.Println("allow =>", rs[0].Bindings["x"])
}
```

goã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœãŒå¾—ã‚‰ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

```sh
$ go run .
allow => true
```

Goã®åŸºç¤çš„ãªéƒ¨åˆ†ã«ã¤ã„ã¦ã®è©³ç´°ã¯çœãã€Regoã«é–¢ã™ã‚‹éƒ¨åˆ†ã‚’è§£èª¬ã—ã¾ã™ã€‚

## ã‚¯ã‚¨ãƒªã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€å…¥åŠ›ã®è¨­å®š

```go
	q := rego.New(
		rego.Query(`x := data.blue.allow`),
		rego.Module("module.rego", module),
		rego.Input(input),
	)
```

`rego.New` ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ç”Ÿæˆã—ã¾ã™ã€‚Functional Option Patternãªã®ã§ä»»æ„ã®æ•°ãƒ»ç¨®é¡ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ãŒã€`rego.Query` ã ã‘ã¯ã‹ãªã‚‰ãšå¿…è¦ã§ã™ã€‚ã“ã®ç”Ÿæˆæ–¹æ³•ã ã¨ã‚¯ã‚¨ãƒªã€ãŠã‚ˆã³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ–‡æ³•ãƒŸã‚¹ãŒå®Ÿè¡Œæ™‚ã¾ã§ã‚ã‹ã‚‰ãªã„ã®ã§ã€å…ˆã«æ¤œå‡ºã—ãŸã„å ´åˆã¯[Compiler](https://pkg.go.dev/github.com/open-policy-agent/opa/rego#example-Rego.Eval-Compiler)ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

ã‚¯ã‚¨ãƒªã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é–¢ä¿‚ã¯[Regoã®åŸºç¤ï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç·¨ï¼‰]()ã§è§£èª¬ã—ãŸã¨ãŠã‚Šã§ã™ã€‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«è¨˜è¿°ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ç¾¤ã‚’ã‚¯ã‚¨ãƒªã§æŒ‡å®šã—ã¦å‘¼ã³å‡ºã—ãŸçµæœã‚’è¿”ã—ã¾ã™ã€‚ä¸Šè¨˜ã®ä¾‹ã§ã¯ `x := data.blue.allow` ã¨ã„ã†ã‚¯ã‚¨ãƒªã«ã—ã¦ `x` ã« `blue` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã® `allow` ã®çµæœã‚’å‰²ã‚Šå½“ã¦ã¦ã„ã¾ã™ãŒã€ `data.blue.allow` ã¨ã ã‘ã™ã‚‹ã“ã¨ã§ã€å¼ã®è©•ä¾¡çµæœã ã‘ã‚’å–ã‚Šå‡ºã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ï¼ˆè©³ã—ãã¯å¾Œè¿°ï¼‰

å…¥åŠ›ã¯JSONå½¢å¼ã«ä¸€åº¦å¤‰æ›ã—ã¦ã‹ã‚‰Regoã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€æ§‹é€ ä½“ã‹ã‚‰æ¸¡ã™å ´åˆã«ã¯ `json` ã‚¿ã‚°ã§æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚ã¾ãŸã€ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§å—ã‘å–ã£ãŸJSONãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯ `interface{}` ã®å¤‰æ•°ã‚’ç”¨æ„ã—ã¦ä¸€åº¦unmarshalã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## è©•ä¾¡çµæœã®å–å¾—ã¨å‡¦ç†

```go
	rs, err := q.Eval(context.Background())
	if err != nil {
		panic(err)
	}
```

`Eval()` ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ãƒãƒªã‚·ãƒ¼ã®è©•ä¾¡çµæœï¼ˆãŠã‚ˆã³ã‚¨ãƒ©ãƒ¼ï¼‰ã‚’å–å¾—ã§ãã¾ã™ã€‚è©•ä¾¡çµæœã¯ `rego.ResultSet` (`rego.Result` ã®é…åˆ—) ã§è¿”ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã‚¯ã‚¨ãƒªã§ `data.allowed_users[x]` ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹ã¨ã€æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹çµæœã‚’ã™ã¹ã¦è¿”ã™ã“ã¨ã«ãªã‚‹ãŸã‚ã€è¤‡æ•°ã®è©•ä¾¡çµæœã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã¤ã„ã¦ã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å´ã«ä»»æ„ã®ãƒãƒªã‚·ãƒ¼ãŒè¨˜è¿°ã•ã‚Œã¦ã‚‚ã€ã‚¯ã‚¨ãƒªå´ã§è¿”ã•ã‚Œã‚‹çµæœã®æ•°ã‚’ã‚ã‚‹ç¨‹åº¦åˆ¶å¾¡ã§ãã¾ã™ã€‚ãŸã ã—ã€ã‚¯ã‚¨ãƒªã§æŒ‡å®šã—ãŸè©•ä¾¡çµæœã«å½ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯ä½•ã‚‚å€¤ãŒè¿”ã•ã‚Œãšã€`ResultSet` ã¯0å€‹ã«ãªã‚Šã¾ã™ã€‚

```go
	input := struct {
		User string `json:"user"`
	}{User: "x"}

	module := `package blue
	allow {
		input.user == "mizutani"
	}`

	q := rego.New(
		rego.Query(`x := data.blue.allow`),
		rego.Module("module.rego", module),
		rego.Input(input),
	)

	rs, err := q.Eval(context.Background())
	if err != nil {
		panic(err)
	}

	fmt.Println("rs =>", len(rs)) // rs => 0
```

è©•ä¾¡ã®çµæœã¯ `rego.Result` å†…ã«ã‚ã‚‹ `Expressions` ãŠã‚ˆã³ `Bindings` ã®2ã¤ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿æŒã•ã‚Œã¾ã™ã€‚

- `Expression`: ã‚¯ã‚¨ãƒªå†…ã§è©•ä¾¡ã•ã‚ŒãŸå¼ã«ã¤ã„ã¦ã®çµæœã‚’ä¿æŒã—ã¾ã™ã€‚ä¾‹ãˆã°ã‚¯ã‚¨ãƒªãŒ `data.blue` ã ã‘ãªã‚‰ `blue` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†…ã§ç™ºç”Ÿã—ãŸçµæœï¼ˆ `{"allow":true}` ï¼‰ãŒã“ã®ä¸­ã«æ ¼ç´ã•ã‚Œã¾ã™ã€‚`x := data.blue` ã®ã‚ˆã†ã«ã—ã¦ã‚‚å¼ã®è©•ä¾¡çµæœè‡ªä½“ã¯æ®‹ã‚‹ã®ã§ã™ãŒã€ã“ã¡ã‚‰ã¯ã€Œä»£å…¥ã€ã¨ã„ã†å‡¦ç†ã®çµæœã¨ã—ã¦ å€¤ãŒå…¥ã‚Œã° `true` ãŒè¨˜éŒ²ã•ã‚Œã‚‹ã®ã¿ã«ãªã‚Šã¾ã™ã€‚
- `Bindings`: ã‚¯ã‚¨ãƒªå†…ã§æ–°ãŸã«å€¤ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸå¤‰æ•°ã®

ä¾‹ãˆã°å¼ã ã‘ã‚¯ã‚¨ãƒªã«è¨˜è¿°ã™ã‚‹ã¨ã€

```go
	q := rego.New(
		rego.Query(`data.blue`),
		rego.Module("module.rego", module),
		rego.Input(input),
	)

	rs, err := q.Eval(context.Background())
	if err != nil {
		panic(err)
	}

	pp.Println(rs)
```

ã“ã®ã‚ˆã†ã«ã€ `rs[0].Expressions[0].Value["allow"]` ã«çµæœãŒæ ¼ç´ã•ã‚Œã¾ã™ã€‚

```go
rego.ResultSet{
  rego.Result{
    Expressions: []*rego.ExpressionValue{
      &rego.ExpressionValue{
        Value: map[string]interface {}{
          "allow": true,
        },
        Text:     "data.blue",
        Location: &rego.Location{
          Row: 1,
          Col: 1,
        },
      },
    },
    Bindings: rego.Vars{},
  },
}
```

ä¸€æ–¹ã§ã‚¯ã‚¨ãƒªã‚’ `x := data.blue` ã¨ã™ã‚‹ã¨ã€æ–°ãŸã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸ `x` ã«é–¢ã™ã‚‹çµæœãŒ `rs[0].Bindings["x"]` ã«æ ¼ç´ã•ã‚Œã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™ã€‚å¼ã¯å‰è¿°ã®é€šã‚Šã€`true` ã®ã¿ãŒæ ¼ç´ã•ã‚Œã¾ã™ã€‚

```go
rego.ResultSet{
  rego.Result{
    Expressions: []*rego.ExpressionValue{
      &rego.ExpressionValue{
        Value:    true,
        Text:     "x := data.blue",
        Location: &rego.Location{
          Row: 1,
          Col: 1,
        },
      },
    },
    Bindings: rego.Vars{
      "x": map[string]interface {}{
        "allow": true,
      },
    },
  },
}
```

# å‚è€ƒæ–‡çŒ®

- Integrating with the Go API https://www.openpolicyagent.org/docs/latest/integration/#integrating-with-the-go-api
- rego package: https://pkg.go.dev/github.com/open-policy-agent/opa/rego#pkg-examples
