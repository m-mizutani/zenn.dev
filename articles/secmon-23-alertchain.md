---
title: "å®Ÿè·µã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–åŸºç›¤æ§‹ç¯‰(23): ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œã®è‡ªå‹•åŒ–ã®å®Ÿè£…ä¾‹"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["security", "monitoring"]
published: false
---

ã“ã®è¨˜äº‹ã¯ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼[å®Ÿè·µã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–åŸºç›¤æ§‹ç¯‰](https://adventar.org/calendars/9986)ã®23æ—¥ç›®ã§ã™ã€‚æœ¬æ—¥ã¯ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œã®è‡ªå‹•åŒ–ã‚’ã™ã‚‹ãŸã‚ã®å®Ÿè£…ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

# ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œã®è‡ªå‹•åŒ–ã®è¦ä»¶

ã‚ã‚‰ãŸã‚ã¦ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œã®è‡ªå‹•åŒ–ã®å®Ÿè£…è¦ä»¶ã‚’æ•´ç†ã—ã¾ã™ã€‚

- âœ” **æŸ”è»Ÿãªåˆ†å²ã¨ãƒ­ã‚¸ãƒƒã‚¯ã®è¡¨ç¾**: ã‚¢ãƒ©ãƒ¼ãƒˆã®å†…å®¹ã«ã‚ˆã£ã¦å‡¦ç†å†…å®¹ã‚„å¯¾è±¡ã‚’å¤‰æ›´ã™ã‚‹ãªã©ã—ãŸã„ã“ã¨ã‹ã‚‰ã€ãƒ­ã‚¸ãƒƒã‚¯ã‚’æŸ”è»Ÿã«è¡¨ç¾ã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯åˆ†å²ã ã‘ã§ãªãã€ã‚¢ãƒ©ãƒ¼ãƒˆã«å«ã¾ã‚Œã‚‹å€¤ã‚„æ§‹é€ ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªç”±ã«åŠ å·¥ãƒ»æ¯”è¼ƒã§ãã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã§ã™ã€‚
- âœ” **ãƒ†ã‚¹ãƒˆå¯èƒ½æ€§ãƒ»è‡ªå‹•åŒ–**: ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œã®è‡ªå‹•åŒ–ã¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®å†…å®¹ã«ã‚ˆã£ã¦å‡¦ç†ãŒå¤‰ã‚ã‚‹ã“ã¨ãŒå¤šã„ãŸã‚ã€ãã®ãƒ­ã‚¸ãƒƒã‚¯ãŒæœŸå¾…é€šã‚Šã«å‹•ä½œã™ã‚‹ã‹ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ãŒå¿…è¦ã§ã™ã€‚ãã®ãŸã‚ã«ãƒ†ã‚¹ãƒˆãŒã§ãã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ç”¨æ„ã—ã¦ãŠãã“ã¨ãŒé‡è¦ã§ã™ã€‚
- âœ” **ã‚¢ãƒ©ãƒ¼ãƒˆã®é›†ç´„ãƒ»ç´ã¥ã‘**: å¤§é‡ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã™ã‚‹ã¨ã€ãã®å‡¦ç†ã«ã‚ˆã£ã¦å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãªã©ã«éè² è·ã‚’ã‹ã‘ã‚‹æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ã‚¢ãƒ©ãƒ¼ãƒˆã®æ•°ãŒå¤šã„ã¨æ‹…å½“è€…ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒŠãƒªã‚¹ãƒˆãŒæŒãæ‰‹é–“ãŒå¤§ãããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã‚’ã†ã¾ãé›†ç´„ã™ã‚‹ã“ã¨ã§å¯¾å¿œã™ã‚‹äººç‰©ã®æ‰‹é–“ã¨èªçŸ¥è² è·ã‚’è»½æ¸›ã—ã€é©åˆ‡ãªå¯¾å¿œã‚’ä¿ƒã™ã“ã¨ãŒã§ãã¾ã™ã€‚

# ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œã®è‡ªå‹•åŒ–å®Ÿè£…: AlertChain

ã“ã†ã„ã£ãŸè¦ä»¶ã‚’æº€ãŸã™ãŸã‚ã®ä¸€ã¤ã®å®Ÿè£…ä¾‹ã¨ã—ã¦ã€[AlertChain](https://github.com/secmon-lab/alertchain)ã¨ã„ã†OSSã‚’ç´¹ä»‹ã—ã¾ã™ã€‚AlertChainã¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®å—ä»˜ã‹ã‚‰å¯¾å¿œã¾ã§ã‚’[Rego](https://www.openpolicyagent.org/docs/latest/)ãƒ«ãƒ¼ãƒ«ã§è¨˜è¿°ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

https://github.com/secmon-lab/alertchain

AlertChainã¯å¤§ããåˆ†ã‘ã¦2ã¤ã®ãƒ«ãƒ¼ãƒ«ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚1ã¤ãŒã‚¢ãƒ©ãƒ¼ãƒˆã®å—ä»˜ã‚’è¡Œã† `alert` ãƒãƒªã‚·ãƒ¼ã€ã‚‚ã†1ã¤ãŒã‚¢ãƒ©ãƒ¼ãƒˆã®å¯¾å¿œã‚’ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®šã™ã‚‹ `action` ãƒãƒªã‚·ãƒ¼ã§ã™ã€‚ã“ã‚Œã‚‰ã®ãƒãƒªã‚·ãƒ¼ã¯Regoã§è¨˜è¿°ã•ã‚Œã€ã‚¢ãƒ©ãƒ¼ãƒˆã®å†…å®¹ã«å¿œã˜ã¦å‡¦ç†ã‚’åˆ†å²ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

[Rego](https://www.openpolicyagent.org/docs/latest/)ã¯å¤–éƒ¨å…¥å‡ºåŠ›ãªã©ã®æ©Ÿèƒ½ã‚’åŸå‰‡ã¨ã—ã¦ã‚‚ãŸãšã€ãã‚Œã§ã„ã¦æŸ”è»Ÿãªãƒ­ã‚¸ãƒƒã‚¯ã‚’è¨˜è¿°ã§ãã‚‹ãŸã‚ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®å†…å®¹ã«å¿œã˜ã¦å‡¦ç†ã‚’åˆ†å²ã•ã›ã‚‹ã¨ã„ã£ãŸè¦ä»¶ã«é©ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€Regoã¯ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã€è¨˜è¿°ã—ãŸãƒ«ãƒ¼ãƒ«ãŒæœŸå¾…é€šã‚Šã«å‹•ä½œã™ã‚‹ã‹ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/2cdbbd8f7d19-20241215.png)

ä¸Šè¨˜ã¯AlertChainã®å…¨ä½“çš„ãªå‡¦ç†ã®æµã‚Œã‚’è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚AlertChainã¯HTTP APIã‹ã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å—ã‘ä»˜ã‘ã€ãã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’Regoãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦å‡¦ç†ã—ã¾ã™ã€‚æœ€åˆã« `alert` ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã£ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹ã‹ã®åˆ¤æ–­ã‚’ã—ã¤ã¤ã€AlertChainå†…ã§ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦æ‰±ã†ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ã®æ­£è¦åŒ–ã‚’ã—ã¾ã™ã€‚ãã®å¾Œã€ `action` ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã£ã¦ã©ã®ã‚ˆã†ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–ã‚‹ã‹ã‚’æ±ºå®šã—ã€ãã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ä¸»ã«å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®é€šçŸ¥ã€ãƒã‚±ãƒƒãƒˆä½œæˆã€ã‚¢ãƒ©ãƒ¼ãƒˆã®åˆ†æã®ã‚ˆã†ãªå‡¦ç†ãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€å®Ÿè¡Œé †åºã‚„å®Ÿè¡Œæ™‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã©ã‚’Regoã«ã‚ˆã£ã¦æŸ”è»Ÿã«è¨˜è¿°ã§ãã‚‹ã€ã¨ã„ã†ã®ãŒå¤§ããªç‰¹å¾´ã§ã™ã€‚

# AlertChainã®ç‰¹å¾´

## ã‚¢ãƒ©ãƒ¼ãƒˆå—ä»˜ã®ãŸã‚ã®Regoãƒ«ãƒ¼ãƒ« ( `alert` ãƒãƒªã‚·ãƒ¼)

AlertChainã¯ã‚¢ãƒ©ãƒ¼ãƒˆã®å—ä»˜ã‚’è¡Œã†ãŸã‚ã® `alert` ãƒãƒªã‚·ãƒ¼ã‚’Regoã§è¨˜è¿°ã—ã¾ã™ã€‚ã“ã®ãƒãƒªã‚·ãƒ¼ã¯å—ä¿¡ã—ãŸã‚¢ãƒ©ãƒ¼ãƒˆã‚’AlertChainå†…éƒ¨ã§æµé€šã•ã›ã‚‰ã‚Œã‚‹ã‚ˆã†ã«æ­£è¦åŒ–ã™ã‚‹ã¨ã¨ã‚‚ã«ã€ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å—ã‘å…¥ã‚Œã‚‹ã‹ã€ã‚ã‚‹ã„ã¯ç„¡è¦–ã™ã‚‹ã‹ã®é¸æŠã‚’ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€å—ã‘ä»˜ã‘ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆãŒè‡ªåˆ†ãŸã¡ã§åˆ¶å¾¡å¯èƒ½ãªç›£è¦–åŸºç›¤ä¸Šã®ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œçŸ¥ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã ã‘ã§ãªãã€å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ç™ºå ±ã•ã‚Œã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆã‚‚å—ã‘ä»˜ã‘ã‚‹ãŸã‚ã§ã™ã€‚å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ãƒ»ã‚µãƒ¼ãƒ“ã‚¹å†…ã«ä¸€éƒ¨ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç„¡è¦–ã•ã›ã‚‹æ©Ÿèƒ½ã‚’æŒã¤å ´åˆã‚‚ã‚ã‚Šã¾ã™ãŒã€ãã†ã„ã£ãŸæ©Ÿèƒ½ãŒä½•ã‚‚ãªãã“ã¡ã‚‰å´ã§åˆ¶å¾¡ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã‚‚ã®ã‚‚ã‚ã‚Šã€ã“ã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’æŒã¡ã¾ã™ã€‚

ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¾ã™ã€‚

```rego
package alert.aws_guardduty

alert contains {
    "title": f.Type,
    "source": "aws",
    "description": f.Description,
    "attrs": [
        {
            "key": "instance ID",
            "value": f.Resource.InstanceDetails.InstanceId,
        },
        {
            "key": "Requested Domain",
            "value": f.Service.Action.DnsRequestAction.Domain,
        },
    ],
} if {
    f := input.Findings[_]
    startswith(f.Type, "Trojan:")
    f.Severity > 7
}
```

ã“ã®ãƒ«ãƒ¼ãƒ«ã¯Amazon GuardDutyã®Findingã‚’ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦å—ä¿¡ã—ãŸã“ã¨ã‚’æƒ³å®šã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ãŒHTTP APIã§æ¸¡ã•ã‚ŒãŸã¨æƒ³å®šã—ã¦ãã ã•ã„ã€‚

https://github.com/secmon-lab/alertchain/blob/main/examples/basic/guardduty.json

å…·ä½“çš„ãªå‹•ä½œã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã™ã€‚

```rego
f := input.Findings[_]
startswith(f.Type, "Trojan:")
f.Severity > 7
```

ã¾ãšä¸Šè¨˜ã®3è¡Œã¯å—ã‘ä»˜ã‘ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦å–ã‚Šæ‰±ã†éƒ¨åˆ†ã‚’æŠ½å‡ºã—ã€ãã‚Œã‚’å—ã‘å…¥ã‚Œã‚‹ã‹åˆ¤å®šã—ã¦ã„ã¾ã™ã€‚`.Findings` ãŒé…åˆ—ãªã®ã§1ã¤ãšã¤ã¨ã‚Šã ã— (1è¡Œç›®) ã€`.Findings[].Type` ã®PrefixãŒ `Trojan:` ã§ã‚ã‚‹ã‹ã‚’åˆ¤å®šã— (2è¡Œç›®) ã€ãã—ã¦ `Findings[].Severity` ãŒ7ã‚ˆã‚Šå¤§ãã„ã‹ã‚’åˆ¤å®šã—ã¾ã™ (3è¡Œç›®)ã€‚ã“ã‚Œã‚‰ãŒæƒã£ãŸå ´åˆ (ANDæ¡ä»¶) ã«ã®ã¿ã€ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦å—ã‘å…¥ã‚Œã‚‹ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã®æ¡ä»¶ã«åˆè‡´ã—ãªã‹ã£ãŸå ´åˆã€ã‚¢ãƒ©ãƒ¼ãƒˆã¯å—ã‘å…¥ã‚Œã‚‰ã‚Œãšå¾Œç¶šã®å‡¦ç†ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚

```rego
alert contains {
    "title": f.Type,
    "source": "aws",
    "description": f.Description,
    "attrs": [
        {
            "key": "instance ID",
            "value": f.Resource.InstanceDetails.InstanceId,
        },
        {
            "key": "Requested Domain",
            "value": f.Service.Action.DnsRequestAction.Domain,
        },
    ],
    "namespace": sprintf("aws_guardduty_trojan_alert/instance/%s", [f.Resource.InstanceDetails.InstanceId]),
}
```

æ¬¡ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦å—ã‘ã„ã‚Œã‚‹å ´åˆã®æ­£è¦åŒ–ã®å‡¦ç†ã§ã™ã€‚ã“ã®ä¾‹ã§ã¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ« `title` ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®ç™ºå ±å…ƒ `source`ã€èª¬æ˜ `description`ã€ãŠã‚ˆã³å±æ€§ã‚’æŠ½å‡ºã—ã¦ã„ã¾ã™ã€‚å±æ€§ã¯ `attrs` ã¨ã„ã†é…åˆ—ã§è¡¨ç¾ã•ã‚Œã€ãã‚Œãã‚Œã®å±æ€§ã¯ `key` ã¨ `value` ã§è¡¨ç¾ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ã‚ˆã†ã«ã—ã¦ã€ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾Œç¶šã®å‡¦ç†ã‚„è¨˜éŒ²ã«å¿…è¦ãªæƒ…å ±ã‚’æŠ½å‡ºã—ã¦ã„ã¾ã™ã€‚

è¨­å®šã•ã‚Œã‚‹å±æ€§å€¤ã¯åŸå‰‡ã¨ã—ã¦ãã®ã‚¢ãƒ©ãƒ¼ãƒˆã«ã®ã¿ç´ã¥ã‘ã•ã‚Œã¾ã™ãŒã€è¦ä»¶ã§ã‚‚èª¬æ˜ã—ãŸé€šã‚Šã‚¢ãƒ©ãƒ¼ãƒˆé–“ã§ã®ãƒ‡ãƒ¼ã‚¿é€£æºãŒå¿…è¦ãªå ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€ã“ã®ä¾‹ã§ã¯ `namespace` ã¨ã„ã†å±æ€§ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚ã“ã®å±æ€§ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã®åå‰ç©ºé–“ã‚’è¡¨ç¾ã—ã€ä»–ã®ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã®é–¢é€£ä»˜ã‘ã‚’è¡Œã†ãŸã‚ã®æƒ…å ±ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ä»Šå›ã¯ `namespace` ã«EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDã‚’åˆ©ç”¨ã—ã¦ãŠã‚Šã€ã“ã‚Œã«ã‚ˆã£ã¦åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã§ç™ºç”Ÿã—ãŸç•°ãªã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆã§åå‰ç©ºé–“ãŒå…±æœ‰ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚å¾Œè¿°ã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã“ã®åå‰ç©ºé–“ã‚’åˆ©ç”¨ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆé–“ã®ãƒ‡ãƒ¼ã‚¿é€£æºãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

## ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œã®ãŸã‚ã®Regoãƒ«ãƒ¼ãƒ« ( `action` ãƒãƒªã‚·ãƒ¼)

ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦å—ã‘å…¥ã‚Œã‚‰ã‚ŒãŸå¾Œã¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®å†…å®¹ã«å¿œã˜ã¦ã©ã®ã‚ˆã†ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã™ã‚‹ã‹ã‚’æ±ºå®šã™ã‚‹ãƒ«ãƒ¼ãƒ«ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ«ãƒ¼ãƒ«ã¯ `action` ãƒãƒªã‚·ãƒ¼ã¨ã—ã¦Regoã§è¨˜è¿°ã•ã‚Œã¾ã™ã€‚ã“ã®ãƒãƒªã‚·ãƒ¼ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã®å†…å®¹ã«å¿œã˜ã¦ã€é€šçŸ¥ã‚„ãƒã‚±ãƒƒãƒˆä½œæˆã€ã‚¢ãƒ©ãƒ¼ãƒˆã®åˆ†æãªã©ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®šã—ã¾ã™ã€‚

`action` ãƒ«ãƒ¼ãƒ«ã¯[AWS Step Functions](https://aws.amazon.com/step-functions/?nc1=h_ls)ã¨ä¼¼ãŸã‚ˆã†ãªç™ºæƒ³ã§ã€å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®ã‚ˆã†ã«é€£é–ã—ã¦ã„ãã¾ã™ã€‚AlertChainã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å—ã‘å…¥ã‚ŒãŸå¾Œã«ã€`action` ãƒãƒªã‚·ãƒ¼ã‚’è©•ä¾¡ã—ã¦ `run` ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ã«æ ¼ç´ã•ã‚ŒãŸæƒ…å ±ã«åŸºã¥ã„ã¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`run` ã«ã¯ã„ãã¤ã§ã‚‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨˜è¿°ã§ãã€æŒ‡å®šã•ã‚ŒãŸåˆ†ã ã‘é †æ¬¡å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®å®Ÿè¡ŒãŒçµ‚ã‚ã£ãŸã‚‰AlertChainã¯å†åº¦ `action` ãƒãƒªã‚·ãƒ¼ã‚’è©•ä¾¡ã—ã¦ã€`run` ãƒ«ãƒ¼ãƒ«ã§æŒ‡å®šã•ã‚ŒãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã‚’ç¹°ã‚Šè¿”ã—ã¦ã€Œ`run`ãƒ«ãƒ¼ãƒ«ã«ä½•ã‚‚æ ¼ç´ã•ã‚Œãªã„ã€ã€Œ`run`ãƒ«ãƒ¼ãƒ«ã§æŒ‡å®šã•ã‚ŒãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå…¨ã¦å®Ÿè¡Œæ¸ˆã¿ã€ã¨ã„ã†æ¡ä»¶ãŒæº€ãŸã•ã‚Œã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚

```rego
package action

# (1) ChatGPTã«ã‚ˆã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆå†…å®¹ã®åˆ†æ
run contains {
    "id": "ask-chatgpt",
    "uses": "chatgpt.query",
    "args": {
        "secret_api_key": input.env.CHATGPT_API_KEY,
        "prompt": "Analyze and summarize the given JSON-formatted security alert data",
    },
    "commit": [
        {
            "key": "ChatGPT's comment",
            "path": "choices[0].message.content",
        },
    ],
} if {
    input.seq == 0
}

# (2) ChatGPTã®çµæœã‚’æ·»ãˆã¦Slackã«é€šçŸ¥ã‚’é€ã‚‹å‡¦ç†
run contains {
    "id": "notify-slack",
    "uses": "slack.post",
    "args": {
        "secret_webhook_url": input.env.SLACK_INCOMING_WEBHOOK,
    },
} if {
    input.called[_].id == "ask-chatgpt"
}
```

ã“ã®ä¾‹ã§ã¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®å†…å®¹ã«å¿œã˜ã¦2ã¤ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡Œã„ã¾ã™ã€‚1ã¤ç›®ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ChatGPTã‚’ä½¿ã£ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã®å†…å®¹ã‚’åˆ†æã—ã€ãã®çµæœã‚’å–å¾—ã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚2ã¤ç›®ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯Slackã«é€šçŸ¥ã‚’é€ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚ã“ã®ä¾‹ã§ã¯ChatGPTã®çµæœã‚’Slackã«é€šçŸ¥ã™ã‚‹ã¨ã„ã†å‡¦ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

ã“ã®ä¾‹ã§ã¯ChatGPTã®çµæœã‚’å–å¾—ã—ãŸå¾Œã«Slackã«é€šçŸ¥ã‚’é€ã‚‹ã¨ã„ã†å‡¦ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ `action` ãƒãƒªã‚·ãƒ¼ãŒè©•ä¾¡ã•ã‚Œã‚‹éš›ã«æ¸¡ã•ã‚Œã‚‹ `input.seq` ã¨ `input.called` ã¨ã„ã†å…¥åŠ›ã«ã‚ˆã£ã¦å®Ÿè¡Œé †åºãŒåˆ¶å¾¡ã•ã‚Œã¦ã„ã¾ã™ã€‚`input.seq` ã¯ `action` ãƒãƒªã‚·ãƒ¼ãŒè©•ä¾¡ã•ã‚ŒãŸå›æ•°ã‚’è¡¨ã—ã€`input.called` ã¯ã“ã‚Œã¾ã§ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè¡ŒçµæœãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãš `seq` ãŒ0ã€ã¤ã¾ã‚Šæœ€åˆã«è©•ä¾¡ã•ã‚ŒãŸå ´åˆã«ã¯ChatGPTã‚’ä½¿ã£ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã®å†…å®¹ã‚’åˆ†æã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã€ãã®ã‚ã¨ã§ `input.called` ã¨ã„ã†é…åˆ—ã« `id` ãŒ `ask-chatgpt` ã§ã‚ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ã„ãŸå ´åˆã«ã¯Slackã«é€šçŸ¥ã‚’é€ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã€ã¨ã„ã†é †åºã®åˆ¶å¾¡ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚

## é›†ç´„ãƒ»ç´ã¥ã‘ã®ãŸã‚ã®ã‚¢ãƒ©ãƒ¼ãƒˆé–“ãƒ‡ãƒ¼ã‚¿é€£æº

AlertChainã«ãŠã‘ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆé–“ã®ãƒ‡ãƒ¼ã‚¿é€£æºã¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®å—ä»˜æ™‚ã«è¨­å®šã•ã‚Œã‚‹ `namespace` ã¨ã„ã†å±æ€§ã‚’åˆ©ç”¨ã—ã¦è¡Œã„ã¾ã™ã€‚ã“ã®å±æ€§ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã®åå‰ç©ºé–“ã‚’è¡¨ç¾ã—ã€ä»–ã®ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã®é–¢é€£ä»˜ã‘ã‚’è¡Œã†ãŸã‚ã®æƒ…å ±ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ã‚¢ãƒ©ãƒ¼ãƒˆã®å—ä»˜æ™‚ã«è¨­å®šã•ã‚ŒãŸ `namespace` ã¯ã€ãã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒå±ã™ã‚‹åå‰ç©ºé–“ã‚’è¡¨ç¾ã—ã¾ã™ã€‚

å…ˆè¿°ã—ãŸä¾‹ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãª `namespace` ã‚’è¨­å®šã—ã¦ã„ã¾ã—ãŸã€‚

```rego
    "namespace": sprintf("aws_guardduty_trojan_alert/instance/%s", [f.Resource.InstanceDetails.InstanceId]),
```

ã“ã® `namespace` ã¯åŒã˜EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã§ç™ºç”Ÿã—ãŸç•°ãªã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆã§å…±æœ‰ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ãã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã® `attrs` ã§å±æ€§å€¤ã‚’è¿½åŠ ã™ã‚‹éš›ã« `persist` ã¨ã„ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« `true` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ãã®å€¤ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆFirestoreï¼‰ã«ä¿å­˜ã•ã‚Œã€åŒã˜ `namespace` ã‚’ã‚‚ã¤ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ãŸéš›ã«ã¯ä¿å­˜ã•ã‚ŒãŸå€¤ãŒå–å¾—ã•ã‚Œã¦ `attrs` ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã‚¢ãƒ©ãƒ¼ãƒˆé–“ã§ã®ãƒ‡ãƒ¼ã‚¿é€£æºãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

ä¾‹ã¨ã—ã¦ã€æœ€åˆã®ã‚¢ãƒ©ãƒ¼ãƒˆã§GitHubã®Issueã‚’ä½œæˆã€åŒä¸€ã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã§ç™ºç”Ÿã—ãŸç•°ãªã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆãŒã‚ã£ãŸå ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã™ã‚‹ã€ã¨ã„ã† `action` ãƒãƒªã‚·ãƒ¼ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

```rego
package action

github_args := {
    "app_id": 134650,
    "install_id": 19102538,
    "owner": "m-mizutani",
    "repo": "security-alert",
    "secret_private_key": input.env.GITHUB_PRIVATE_KEY,
}

issue_num := input.alert.attrs[x].value if {
    input.alert.attrs[x].key == "github_issue_number"
}

# (1) GitHub issue number ãŒå­˜åœ¨ã—ãªã‘ã‚Œã°Issueã‚’ä½œæˆ
run contains {
    "id": "github-issue",
    "uses": "github.create_issue",
    "args": github_args,
    "commit": [
        {
            "key": "github_issue_number",
            "global": true,
            "path": "number",
        },
    ],
} if {
    not issue_num
}

# (2) GitHub issue number ãŒå­˜åœ¨ã™ã‚‹ãªã‚‰ã€ãã‚Œã‚’ã‚‚ã¨ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
run contains {
    "id": "github-comment",
    "uses": "github.create_comment",
    "args": object.union(github_args, {
        "body": "dup!",
        "issue_number": issue_num,
    }),
} if {
    issue_num
}
```

è¦ç‚¹ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```rego
github_issue_number := input.alert.attrs[x].value if {
    input.alert.attrs[x].key == "github_issue_number"
}
```

ã¾ãšã€ä¸Šè¨˜ã®ãƒ«ãƒ¼ãƒ«ã§ `attrs` ã®ä¸­ã‹ã‚‰ `github_issue_number` ã‚’å–å¾—ã—ã¦ `issue_num` ã¨ã„ã†å¤‰æ•°ã«æ ¼ç´ã—ã¦ã„ã¾ã™ã€‚ã‚‚ã— `github_issue_number` ã¨ã„ã†ã‚­ãƒ¼ã‚’æŒã¤å±æ€§ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€ `issue_num` ã¯æœªå®šç¾©ã¨ãªã‚Šã¾ã™ã€‚

```rego
    "commit": [
        {
            "key": "github_issue_number",
            "path": "number",
            "persist": true,
        },
    ],
```

`issue_num` ãŒæœªå®šç¾©ã ã£ãŸå ´åˆã€(1)ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®å‡¦ç†ã§ã¯GitHubã®Issueã‚’ä½œæˆã—ã€ãã®éš›ã®[è¿”ã‚Šå€¤](https://docs.github.com/en/rest/issues/issues?apiVersion=2022-11-28#create-an-issue)ã‚’æ‰±ã†ã“ã¨ãŒã§ãã¾ã™ã€‚ãã—ã¦ `commit` ã¨ã„ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å‡¦ç†å®Ÿè¡Œå¾Œã«ä¿å­˜ã™ã‚‹å±æ€§å€¤ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã€ä¿å­˜ã™ã‚‹å€¤ã¯ `path` ã§JSONPathã‚’æŒ‡å®šã—ã¦Issueä½œæˆAPIã®è¿”ã‚Šå€¤ã‹ã‚‰å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»Šå›ã¯Issueã®ç•ªå·ã‚’å–å¾—ãƒ»ä¿å­˜ã—ãŸã„ã®ã§ `number` ã¨ã„ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å€¤ã‚’å–å‡ºã—ã¾ã™ã€‚ã•ã‚‰ã« `persist` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€å€¤ã‚’æ°¸ç¶šåŒ–ã—ã¾ã™ã€‚

```rego
    "args": object.union(github_args, {
        "issue_number": issue_num,
    }),
```

(2)ã®å‡¦ç†ã¯ `issue_num` ãŒå®šç¾©æ¸ˆã¿ã§ã‚ã‚Œã°å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®å‡¦ç†ã§ã¯ã€GitHubã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹å‡¦ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ã“ã®å‡¦ç†ã¯å…ˆç¨‹ã®Issueä½œæˆã®ã¨ãã«æŒ‡å®šã—ãŸå¼•æ•°ä»¥å¤–ã«ã€ `issue_number` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ã©ã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã‹ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
ã“ã“ã§ `issue_num` ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã“ã¨ã§ã€åŒã˜EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã§ç™ºç”Ÿã—ãŸç•°ãªã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆãŒã‚ã£ãŸå ´åˆã€Issueç•ªå·ã‚’å–å¾—ã—ã€ãã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã¨ã„ã†å‡¦ç†ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

ã“ã®ã‚ˆã†ãªé–¢é€£ä»˜ã‘æ–¹æ³•ã¯é€æ¬¡çš„ãªã‚‚ã®ã§ã‚ã‚Šã€äº‹å‰ã«ãƒ«ãƒ¼ãƒ«ã¨ã—ã¦è¨˜è¿°ã—ã¦ãŠã‹ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¨ã„ã†ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—æ±ºå®šæ€§ã‚’æŒã¤ãŸã‚ã€ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å–ã‚Šã“ã¼ã—ãŸã‚ŠæœŸå¾…ã•ã‚Œãªã„é–¢é€£ä»˜ã‘ãŒèµ·ã“ã‚‰ãªã„ã¨ã„ã†åˆ©ç‚¹ãŒã‚ã‚Šã€ä»Šå›ã®å®Ÿè£…ã§ã¯ã“ã®åˆ©ç‚¹ã‚’é‡è¦è¦–ã—ã¾ã—ãŸã€‚

## ãƒ†ã‚¹ãƒˆ

AlertChainã¯ä¸»ã«ã‚¢ãƒ©ãƒ¼ãƒˆå—å…¥ã¨ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œã§ãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒã¡ã¾ã™ã€‚ãã‚Œãã‚Œã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆãŒå®Ÿæ–½ã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã€ç•°ãªã‚‹æ–¹æ³•ã§ãƒ†ã‚¹ãƒˆãŒå®Ÿç¾ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

### ã‚¢ãƒ©ãƒ¼ãƒˆå—å…¥å‡¦ç†ã®ãƒ†ã‚¹ãƒˆ

ã‚¢ãƒ©ãƒ¼ãƒˆå—å…¥ã®ãƒ†ã‚¹ãƒˆã¯[OPA/Regoã®ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½](https://www.openpolicyagent.org/docs/latest/policy-reference/#tests)ã‚’ãã®ã¾ã¾åˆ©ç”¨ã—ã¾ã™ã€‚Regoã®å®Ÿè¡Œãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã‚ã‚‹OPAã«ã¯ã€Regoã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®CLIãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

å…ˆç¨‹ã®ä¾‹ã§ç¤ºã—ãŸ `alert` ãƒãƒªã‚·ãƒ¼ã‚’ã‚‚ã¨ã«ç°¡ç•¥åŒ–ã—ãŸãƒ«ãƒ¼ãƒ«ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚ä»¥ä¸‹ã«èª¬æ˜ã®ãŸã‚ç°¡ç•¥åŒ–ã—ãŸãƒ«ãƒ¼ãƒ«ã‚’ç¤ºã—ã¾ã™ã€‚ `alert.rego`, `alert_test.rego`, `testdata/guardduty/data.json` ï¼ˆ[ã“ã‚Œ](https://github.com/secmon-lab/alertchain/blob/main/examples/basic/guardduty.json)ã¨åŒã˜ï¼‰ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```rego:alert.rego
package alert.aws_guardduty

alert contains {
    "title": f.Type,
    "source": "aws",
    "attrs": [
        {
            "key": "instance ID",
            "value": f.Resource.InstanceDetails.InstanceId,
        },
    ],
} if {
    f := input.Findings[_]
    startswith(f.Type, "Trojan:")
    f.Severity > 7
}
```

ãã—ã¦ãƒ†ã‚¹ãƒˆã‚’ã„ãã¤ã‹è¨˜è¿°ã—ã¦ã¿ã¾ã™ã€‚ã¾ãšã¯æ­£å¸¸ã«ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦æ¤œçŸ¥ã™ã‚‹å ´åˆã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚

```rego:alert_test.rego
test_alert if {
	resp := alert with input as data.testdata.guardduty
	count(resp) == 1
	a := resp[_]
	a.title == "Trojan:EC2/DropPoint!DNS"
	count(a.attrs) == 1
	a.attrs[x].key == "instance ID"
	a.attrs[x].value == "i-99999999"
}
```

ã“ã®ãƒ†ã‚¹ãƒˆã¯ã€ `testdata/guardduty/data.json` ã«è¨˜è¿°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ `alert` ãƒ«ãƒ¼ãƒ«ã«é©ç”¨ã—ãŸçµæœãŒæ­£ã—ã„ã‹ã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã¯æ¤œçŸ¥ãŒæœŸå¾…ã•ã‚Œã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆã®å†…å®¹ã¨ãªã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’ `alert with input as data.testdata.guardduty` ã¨ã™ã‚‹ã“ã¨ã§ `input` ã®å€¤ã‚’ä¸Šæ›¸ãã—ãŸä¸Šã§ `alert` ãƒ«ãƒ¼ãƒ«ã‚’è©•ä¾¡ã—ã¦ã€ãã®çµæœã‚’ `resp` ã«æ ¼ç´ã—ã¾ã™ã€‚ãã—ã¦ `resp` ã«å¯¾ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚„å±æ€§å€¤ã®æ¤œè¨¼ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

```rego:alert_test.rego
test_not_enough_severity if {
	resp := alert with input as json.patch(data.testdata.guardduty, [
        {
            "op": "replace",
            "path": "/Findings/0/Severity",
            "value": 7
        }
    ])

	count(resp) == 0
}
```

æ¬¡ã«ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®é‡è¦åº¦ãŒ7æœªæº€ã®å ´åˆã«ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦æ¤œçŸ¥ã•ã‚Œãªã„ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’è¨˜è¿°ã—ã¾ã™ã€‚ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€ `Severity` ã®å€¤ã‚’7æœªæº€ã«å¤‰æ›´ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ `alert` ãƒ«ãƒ¼ãƒ«ã«é©ç”¨ã—ãŸçµæœãŒç©ºã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚¹ãƒˆã®æ•°ã ã‘ç”¨æ„ã—ã¦ã‚‚è‰¯ã„ã®ã§ã™ãŒã€æ‰‹é–“ãŒã‹ã‹ã‚‹ãŸã‚ç­†è€…ã¯ `json.patch` ã¨ã„ã†é–¢æ•°ã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚

```rego:alert_test.rego
test_not_trojan if {
    resp := alert with input as json.patch(data.testdata.guardduty, [
        {
            "op": "replace",
            "path": "/Findings/0/Type",
            "value": "NotTrojan:EC2/DropPoint!DNS"
        }
    ])

    count(resp) == 0
}
```

ã•ã‚‰ã«ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒ—ãŒ `Trojan:` ã§å§‹ã¾ã‚‰ãªã„å ´åˆã«ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦æ¤œçŸ¥ã•ã‚Œãªã„ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’è¨˜è¿°ã—ã¾ã™ã€‚ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€ `Type` ã®å€¤ã‚’ `Trojan:` ã§å§‹ã¾ã‚‰ãªã„å€¤ã«å¤‰æ›´ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ `alert` ãƒ«ãƒ¼ãƒ«ã«é©ç”¨ã—ãŸçµæœãŒç©ºã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€OPAã®CLIã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

```sh
$ tree .
.
â”œâ”€â”€ alert.rego
â”œâ”€â”€ alert_test.rego
â””â”€â”€ testdata
    â””â”€â”€ guardduty
        â””â”€â”€ data.json

3 directories, 3 files

$ opa test -v .
alert_test.rego:
data.alert.aws_guardduty.test_alert: PASS (689.792Âµs)
data.alert.aws_guardduty.test_not_enough_severity: PASS (389.833Âµs)
data.alert.aws_guardduty.test_not_trojan: PASS (317.792Âµs)
--------------------------------------------------------------------------------
PASS: 3/3
```

### ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œå‡¦ç†ã®ãƒ†ã‚¹ãƒˆ



# ã¾ã¨ã‚
