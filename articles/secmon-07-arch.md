---
title: "Google Cloudで作るセキュリティ監視基盤(7): セキュリティ監視基盤のアーキテクチャ"
emoji: "🔎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["security", "monitoring"]
published: false
---

この記事はアドベントカレンダー[Google Cloudで作るセキュリティ監視基盤](https://adventar.org/calendars/9986)の7日目です。

本日からはセキュリティ監視基盤の設計の話になります。今回は本アドベントカレンダーで取り扱う全体のアーキテクチャがどのようになるのかという点から解説します。具体的なコンポーネントやサービスの選定や構成の前に、どのような要素がどういった役割を担い、どう組み合わさるのが望ましいかという概念から整理します。

# セキュリティ監視基盤のアーキテクチャ

![](https://storage.googleapis.com/zenn-user-upload/e996f87cd613-20241108.jpg)

アーキテクチャの全体像を上に示します。このアーキテクチャで見るべきポイントはログとアラートのパイプラインです。ログを収集、変換、取込をして分析可能な状態にし、そこからアラートを検知して対応する、という一連の流れが基本形となります。

まず各機能について説明します。

## ログの収集

各システムからログを収集するための機能です。システムログ、アプリケーションログ、ネットワーク機器のログ、クラウドサービスのログなど、多様なログを収集します。ログの収集方法は大きく分けてプッシュ型とプル型があります。プッシュ型はログを送信する側がアクティブにログを送信する方法で、プル型はログを収集する側がアクティブにログを取得する方法です。利用するログに応じて収集のための機能を必要なだけ設置します。

収集したログはデータレイクに保存します。データレイクはログをそのまま保存するための領域で、データウェアハウスはデータを分析しやすい形に変換して保存するための領域です。基本的には安価でスケーラブルなオブジェクトストレージを利用します。

## ログの変換・取込

データレイクに保存されたログを適切な形式・スキーマに変換してデータウェアハウスに取り込む機能です。ログの形式やスキーマは多様であり、それぞれのログがデータウェアハウスに取り込める適切な形式、スキーマに変換したり、必要な情報を補完するなどの役割があります。通常のデータ基盤におけるETL（Extract, Transform, Load）の処理のうち、TransformとLoadの部分に相当します。

セキュリティ監視に使われるログの特徴として、システムを監視したデータである・各システムが定めたスキーマを利用する、という点があります。そのため、通常のデータ基盤と比べてログの値の補正などはそれほど重要ではありません。逆にスキーマの変更や、もしやるとしたら正規化などの処理の重要性は高くなります。また、データウェアハウスとして使うプロダクトやサービスに応じて、最適化した形式でログを投入することも重要です。これによってログの扱いやすさやコストを最適化できます。

## ログの調査

ログの調査はログから異常を探し出す、アラートに関連するログをみて深刻度を決める（トリアージ）、インシデント発生時の影響範囲の調査のために実施されます。基本的に人間によって実施されることを想定し、担当者をアナリストと呼びます。

調査はデータウェアハウスを通して実施します。この段階では具体的なインターフェースは規定していませんが、データウェアハウスに直接クエリを発行する場合もあれば、なんらかのユーザーインターフェースを置く場合もありえます。マネージドSQLサービスを利用するのであれば、BIツールを利用してデータウェアハウスに接続することもできます。どのような構成にするかはアナリストであるメンバーのスキルや調査の頻度によって変わります。

## アラート検知

データウェアハウスに保存されたログからアラートを検知する機能です。定期的にデータウェアハウスに対して問い合わせをするプル型、データウェアハウスに投入された（あるいは投入されるべき）ログを順次受け取ってアラートを検知するプッシュ型などがあります。プル型は安定して検知処理を実施できたりリトライがしやすいという利点がある反面、遅延が発生しやすいという欠点があります。プッシュ型はより小さい遅延でアラートを検知できる反面、リトライが難しいだけでなく検知ロジックの表現や制御が複雑になるという欠点があります。遅延を小さくしたいという要求が高い場合を除いては、プル型を採用するをお勧めします。

## アラート対応

検知されたアラートに対して自動的に対応をする機能です。一般体にSOAR（Security Orchestration, Automation and Response）と呼ばれる機能に相当します。アラートに対して自動的に何らかの処理をすることで、アナリストの負担を軽減し、迅速な対応を可能にします。ここではデータウェアハウスから検知されたアラートだけでなく、他のシステムが独自に検知したアラートも同じパイプラインで処理します。

ここでいう対応とはアラートが発生した対象（端末、インスタンス、ネットワークなど）に対して能動的な操作をするだけでなく、通知やチケット作成、データの収集なども含みます。むしろ能動的な対応は誤検知や誤動作のリスクが高いため、後者の管理系の対応のために利用されることが多いです。どのようなアラートを誰にどのような手段で通知するか、チケット作成時に誰にアサインしてどのような情報を付与するか、どんな関連データを収集するかといった制御が必要であり、それらを管理・自動化することがアラート対応部分の目的です。

## 構成管理

セキュリティ監視のログおよびアラートのパイプラインとは別に、構成管理についての構想についても触れておきます。これはパイプライン側のアーキテクチャに直接影響を及ぼすものではありませんが、継続的なセキュリティ監視を実現するうえで必要な要素であるため、ここで触れておきます。

ここまでで取り上げたログの収集、変換・取込、調査、アラート検知、アラート対応の各機能を実現するためには、それぞれに設定やルールが必要です。例えば、ログの収集においてはどのログを収集するか、どのような形式で収集するか、どのようなスキーマで保存するか、などの設定が必要です。また、アラート検知においては検知のためのルールやロジックそのものを管理する必要があります。特にアラート検知については継続的に改善をしていく必要があり、頻繁なアップデートに対応できるようにする必要があります。

構成管理は、これらの設定やルールを管理するための仕組みです。具体的には、設定やルールのバージョン管理、設定やルールの適用状況の設定やルールの変更履歴の管理、設定やルールのテスト、設定やルールの自動適用などが含まれます。これらの機能は、設定やルールをバージョン管理システム・サービスを用いて管理し、CI/CDパイプラインを構築することで実現できます。ルールや設定の更新をした際、自動的にそれがテストされて適用されることで、アナリストの負荷を軽減しつつも迅速な対応を可能にします。

# 本アーキテクチャの特徴

図中の左から右へとログとアラートが流れていくパイプラインになります。基本としては、ログを集める、変換・取り込む、調査する、アラートを検知する、アラートに対応する、アラートを通知・管理する、という流れになります。

## 特徴(1): データレイクとデータウェアハウス

このアーキテクチャの特徴の一つは、ログの検索を実現するためのデータウェアハウス（Data Warehouse、DWH）の前にデータレイクの層を挟む、という点です。データレイクは、ログをそのまま保存するための領域で、データウェアハウスはデータを分析しやすい形に変換して保存するための領域です。収集するすべてのログを一度データレイクに保存するというのは一見効率が悪いように見えますが、いくつかの利点があります。

- **収集と変換・取込の処理を分離できる**: データレイクにはオブジェクトストレージなど、データの形式やスキーマを気にせずに保存できるストレージを利用します。この一時的な保存領域を使うことで、ログの収集と変換・取込の処理を分離でき、それぞれ異なるスケールで処理をする、異なるエラー対応戦略をとる、などが可能になります。
- **収集時にスキーマが不要**: データレイクに保存する際には、ログのスキーマを気にする必要がありません。ログの変換・取込をしてデータウェアハウスに保存する際には、データのスキーマをあらかじめ定義しておく必要がありますが、データレイクの場合はそれがなくてもまず自分たちの基盤へログを持ってくるということができます。これによって、まずはログを集めることに集中し、その後に後段の処理を構築するということも可能になります。
- **リトライの容易性**: データレイクに保存されたログは、何度でも取り込み処理をやり直すことができます。ログの収集は基盤と別システムの連携部分であり、自分たちのコントロール外であることが多いです。そのためデータ転送やリトライ処理といったことに対するコストが比較的高く、気軽に何度もログの収集ができない場合が多いです。

これらの特性によって、ログ収集、変換、取込の処理の可用性や運用の容易さを向上させることができます。セキュリティ監視に使うログの特徴として、ほぼすべてのログのスキーマが自分たちのコントロール外にある、ということがあります。そのため、スキーマの仕様が不明であったり、変更されたりすることが多いです。データレイクを使うことで、こういったトラブルに対応しやすくなるというのがおおきな利点です。

データレイクの保存域としてオブジェクトストレージを用いた場合、ストレージコストも低額かつ、オブジェクトのライフサイクル管理を導入することで一定期間経過後に自動的に削除できるため、全体的にコストも抑えられます。

## 特徴(2): 多様なログやアラートの取込

もう一つの特徴は、データレイクやDWH、そしてアラート対応の処理に直接ログ・アラートを取り込めるような構造にしている、という点です。システムやサービスによっては、ログやアラートを直接出力してくれる機能をあらかじめ有している場合があります。例えば定期的に Cloud Storage へ出力したり、BigQueryへ直接書き込んでくれるというのような機能です。

そのような場合、愚直にパイプラインの先頭から処理するのではなく、なるべくその機能を活かすようにすることで、全体的な複雑性を低減しつつ、コストも抑えることができます。特にGoogle Cloudを利用している場合であれば、Cloud Logging や Audit Logs などのサービスはログをそのまま BigQuery に取り込むことができるため、途中の処理を大幅に省くことができます。

またアラートについても、自分たちで分析などをせずともシステム内での不審な行動を検知してくれるサービスもあります。このようなアラートは直接アラート対応のプロセスに取り込むことができるため、アラートの検知から対応までの時間を短縮することができます。

# まとめ

本記事では、セキュリティ監視基盤のアーキテクチャについて解説しました。セキュリティ監視基盤は、ログの収集からアラートの対応までの一連の流れをパイプラインとして捉え、それぞれの機能がどのような役割を担い、どのように組み合わさるのが望ましいかという概念を整理しました。

具体的なサービス、コンポーネント、実装についてはこのあと詳しく解説していきますが、このアーキテクチャ自体はある程度一般化されたものであり、これから説明する内容以外で設計・実装することもできるようになっています。独自のセキュリティ監視基盤を実装する際にも、この考え方が参考になれば幸いです。

次回からは、セキュリティ監視基盤に取り入れるデータについて解説してきます。
