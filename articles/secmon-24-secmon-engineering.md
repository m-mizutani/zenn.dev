---
title: "実践セキュリティ監視基盤構築(24): セキュリティ監視エンジニアリング"
emoji: "🔎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["security", "monitoring"]
published: false
---

この記事はアドベントカレンダー[実践セキュリティ監視基盤構築](https://adventar.org/calendars/9986)の24日目です。前回までで一通りのセキュリティ監視基盤の構築・実装について解説してきました。今回と次回は少し視点を変えて、セキュリティ監視に対する新しい概念やアイディアについての話をしていきます。

情報技術に関連する様々なソフトウェア、サービス、手法が発展してく中で、それらに取り組むための概念も進化を続けています。わかりやすい例としてはDevOpsやSREがありますが、セキュリティ監視においても新しい取り組みの試みが行われています。

# 従来のセキュリティ監視業務と課題

新しい概念について話す前に、まずは従来のセキュリティ監視業務について振り返ってみましょう。これらは主に筆者が経験したり伝聞によるものなので、それなりに古く、かつ狭く偏った視点である可能性に注意してください。

- アラートの検知はSIEMやIDSなどで提供されているデフォルトのルールを使うことが多く、チューニングもルールのON/OFF程度に留まることが多い
- 検知されたアラートに対しては、SOCアナリストが手動でトリアージを行い、必要に応じて対応を行う
- ルールの更新などは手動オペレーションによって実施される
- デフォルトのルール以外の検知をすることもあるが、それらはSOCアナリストの経験や知識に依存していることが多い

このような従来のセキュリティ監視業務の方式では、いくつかの課題があります

## ❌️ (1) 高度な攻撃への対応が難しい

過去のセキュリティ監視では、主に既知の攻撃パターンに対する検知が中心でした。攻撃に利用されるマルウェアが定型的な通信をしていたり、既知の脆弱性を突いていたりする場合は、それらを検知することができます。またC&C（Command and Control）サーバーやそのドメイン名も長期間使われることも多く、IoC（Indicator of Compromise）を利用した検知も有効でした。

しかし、近年の攻撃は高度化しており、既知の攻撃パターンに対しては検知が難しくなってきています。IoCとなるような情報も短期間で変わることが多く、さらに攻撃自体も複雑化したり非定型化されており、ベンダなどによるデフォルトのルールだけでは検知が難しいことも少なくない状況となってきました。こうした高度な攻撃への対応はSOCアナリストによる脅威ハンティングなどが必要となりますが、これは人的リソースに依存するため、多くの組織にとって対応は難しくなります。また大きい組織であっても、SOCアナリスト本人の技量に左右されるとスケールが難しいなどの課題があります。

これに対応するためには、組織ごとの検知ルールを作成し運用するというアプローチが考えられます。これは**組織のポリシーからの逸脱した挙動を検知**したり、**組織内の環境やアーキテクチャにもとづく不審な挙動の検知**などが含まれます。これらはベンダなどが共通のルールとして提供するのが難しく、組織ごとにカスタマイズされたルールを作成する必要があります。

## ❌️ (2) 継続的な検知の改善が難しい

高度な攻撃への対応と共通するところがありますが、既存ルールなどに対しても誤検知を減らすためのチューニングや、新たな検知ルールの追加などの作業が必要です。検知ルールは一度作成しただけで終わりではなく、継続的に改善を行う必要があります。これは環境の変化、組織の変化、攻撃手法の変化などに対応するために必要です。従来のセキュリティ監視の業務形態やツールでは様々なブロッカーがあり、継続的な改善を含む作業が難しくなっています。

- ⚠️ **作業ミス**: 人間がルール更新の作業をすることでミスが発生する可能性があります。これは検知ルールの更新の頻度が高いほど発生する可能性が高くなり、ルールを置き換えようとするハードルとなってしまいます。
- ⚠️ **作業の遅延**: 人間が手作業で更新をするとなると、確認などの作業も同様に手動で実施する必要があり、作業の遅延が発生します。
- ⚠️ **実機によるテスト**: これはセキュリティ監視に利用するシステム側の問題であることが多いですが、ルールを更新したことによるテストが実機・実環境でないと確認できない場合があります。これはテストのための環境を用意・維持するコストがかかるため、テストの頻度が下がり、ルールの更新が遅れる原因となります。

このようなことから、独自ルールの作成に限らずとも、既存のルールのチューニングや検知の改善においても、効率化が必要になってきます。

## ❌️ (3) 対応などの作業に負荷がかかる

検知されたアラートに対しては、SOCアナリストがトリアージを行い、必要に応じて対応を行います。この作業はSOCアナリストの経験や知識に依存するため、組織によっては対応の品質や結果にばらつきが生じることがあります。また、この作業は人的リソースに依存するため、スケールが難しいという課題もあります。場合によっては同じような作業の繰り返しとなり、モチベーションの低下やミスの増加などの問題も発生します。

またルールの更新作業なども、特定の担当者に作業が集中すると負荷をかけることになってしまうということもあります。さらに別のメンバーが作業をするためのハードルが高くなり、結果としてスケールが難しくなります。

# ソフトウェアエンジニアリングを応用した検知・対応の継続的な改善

こういった課題を解決したいという意向や、より効率的にセキュリティ監視を実施したいなどの目的で、近年ではセキュリティ監視に関連した新しい考え方がいくつか提唱されています。

- [Detection Engineering](https://medium.com/anton-on-security/detection-engineering-is-painful-and-it-shouldnt-be-part-1-3641d8740458/): アラート検知に関するプロセスをソフトウェアエンジニアリングの手法を用いて改善するという考え方
- [Detection as Code](https://www.splunk.com/en_us/blog/learn/detection-as-code.html): Detection Engineeringの一環として、検知ルールをコードとして管理するという考え方
- [Monitoring as Code](https://newrelic.com/blog/best-practices/the-importance-of-monitoring-as-code-for-modern-enterprises): Detection Engineeringに近い概念が、プロダクトの安定運用を含む広義の「監視」を中心とした考え方
- [Policy as Code](https://developer.hashicorp.com/sentinel/docs/concepts/policy-as-code): セキュリティポリシーをコードとして管理し、評価などを自動化するという考え方
- [Autonomic Security Operations](https://services.google.com/fh/files/misc/googlecloud_autonomicsecurityoperations_soc10x.pdf): SOC全体の自律性を高めるための取り組み

これらの概念は全てが一致しているわけではありませんが、これらの概念に共通となるコアの考え方は**ソフトウェアエンジニアリングのベストプラクティスをセキュリティ監視に応用する**という点が挙げられます。ソフトウェア技術の本質は以前から変わっていませんが、それを取り巻く環境・利用できるサービスやソフトウェアが大きく進化したことによって、セキュリティ監視においても新しいアプローチを取り入れるための土壌が整ってきていると言えるでしょう。

ソフトウェアエンジニアリングのベストプラクティスをセキュリティ監視に応用することで、以下のようなメリットが得られると考えられます。

## ✅️ (1) 検知や対応ルールのコード化

"〜 as Code" という言葉が示しているように、ソフトウェアエンジニアリングにおける手法の強みを活かすには、ルールのような知識をコードとして表現することが重要です。ここでのコードとはテキストベースで人間が読み書きしやすく、かつ機械可読性（Machine Readability）がある形式で記述されたものを指します。このような形式でルールという「知識」を管理することで、ソフトウェア開発で利用されるツールやサービスを通じて様々な恩恵が受けられます。

- 👍️ **履歴管理**: Gitのようなバージョン管理システムを使うことで、いつ誰がどのような変更を加えたのかを追跡できるようになります。ルールを変更しようとしたとき、該当部分がどのような経緯で記述されたのかを知ることができ、改善やリファクタリングの手助けとなります。
- 👍️ **レビュー**: GitHubのようなサービスを利用することで、プルリクエストやコードレビューを通じてルールの変更に対して他のメンバーがレビューを行うことができます。これにより、ルールの変更に対して複数のメンバーが目を通すことができ、ミスの発見や知識の共有が行いやすくなります。
- 👍️ **承認管理**: ルールを変更する場合、組織のポリシーによっては責任者の承認が必要な場合があります。GitHubのようなサービスを利用することで、承認フローを定型化しつつレビューや履歴管理と連携できるようになります。
- 👍️ **機械的な検査**: ソフトウェアでルールを読み込ませることで、自動的にルールの内容をチェックできるようになります。具体的には形式を揃えるLintを実行したり、組織内・チーム内ポリシーに則っているかのチェックができるようになります。

## ✅️ (2) 検知や対応の自動化

検知や対応をコードとして管理することでルールの作成や改善が容易になり、そのうえで自動化がより活きてきます。検知や対応をルールに基づいて自動化することで以下のようなメリットが得られます。

- 👍️ **冪等性**: ルールに基づいて自動化された検知や対応は、何度実行しても同じ結果が得られるようになります。これにより、検知や対応の結果が一貫性を持つようになります。
- 👍️ **人的ミスの低減**: 人間が手動で検知や対応を行う場合、見逃しや取り違いといったミスが発生する可能性があります。自動化された検知や対応は、人間のミスを低減することができます。もちろんルールが間違っていた場合、自動化した処理も不具合をおこすことがありますが、コード自体を修正することで同じ問題は繰り返さなくなります。
- 👍️ **作業の効率化**: 人間が手動で検知や対応を行う場合、作業に時間がかかることがあります。自動化された検知や対応は、作業の効率化を実現することができます。これにより、人間がより価値のある作業に集中することができます。
- 👍️ **スケール**: 自動化された検知や対応は、人間が手動で行う場合に比べてスケールしやすいです。これにより、大規模な環境においても検知や対応を効率的に行うことができます。
- 👍️ **迅速な対応**: 自動化された検知や対応は、人間が手動で行う場合に比べて迅速に対応することができます。遅延をどこまで小さくするかは組織の方針次第ですが、調整できる余地があることは重要です。

自動化で重要な観点としては、**全てを自動化することが目的ではない**ということです。自動化における問題として、自動化のためのルール作成や管理の負荷が増えるという点があります。セキュリティ監視で対処しなければいけない事象は多岐にわたり、稀にしか起こらない事象や例外的な事象も少なくありません。そのような事象に対しても自動化を網羅しようとすると、ルールの数が膨大になり、管理が困難になることがあります。そのため、どこまでを自動化するかをよく検討しながら取り組むことが重要です。

## ✅️ (3) ルールの自動テスト

現代のソフトウェア開発において自動テストは無くてはならない存在ですが、セキュリティ監視においても同様にルールの自動テストは様々な恩恵があります。

- 👍️ **ルールの品質維持**: ルールをテスト可能にしておくことで、ルールを作成・更新した際に既存ルールに対して影響を及ぼしていないかを回帰テストできます。
- 👍️ **自動化による負荷軽減**: ルールのテストを自動化することで、テストの負荷を軽減することができます。これによりテストを気軽に実施できるようになり、ルール更新に対する心理的負荷を下げることができます。

自動テストは必ずしもコード化が必要というわけではありませんが、コード化されていることでテストのための仕組みやフレームワークを構築するのが容易になります。また、後述するCI/CDと連携しやすくなり、これによって履歴管理やレビューとも組み合わせた価値を発揮するようになります。

## ✅️ (4) CI/CDの活用

CI（Continuous Integration）/CD（Continuous Deployment）も現代のソフトウェア開発において重要な概念です。一度だけデプロイするようなものであれば特に必要ありませんが、繰り返しかつ複数人でデプロイをするような場合にはCI/CDが有効です。セキュリティ監視においてもルールの更新でCI/CDを活用することで以下のようなメリットが得られます。

- 👍️ **デプロイ前の自動テスト**: ルールを作成・更新した後、デプロイ前にテストを実施することで、本番環境での事故を防ぐことができます。
- 👍️ **デプロイ作業の自動化**: ルールの更新を自動化することで、ルールの適用を自動化することができます。これにより、ルールの適用漏れやミスを防ぐことができ、さらに適用にかかる作業に時間を浪費しなくてよくなります。また、属人化を避けて誰でもルールを適用しやすくなり、チームで作業しやすくなります。

# セキュリティ監視にソフトウェアエンジニアリングを適用するための課題

セキュリティ監視に対するソフトウェアエンジニアリングの適用は多くの恩恵がある一方で、実現するための課題はいくつか存在します。以下にその一部を挙げてみます。

## ⚠️ 対応するサービスやソフトウェアが少ない

セキュリティ監視に対するソフトウェアエンジニアリングの適用は新しい概念であるため、対応するサービスやソフトウェアが少ないという課題があります。セキュリティ監視自体は古くからの業務でありそのためのサービスやソフトウェアは多く存在しますが、セキュリティ監視を担当する人物はそれらの「サービスやソフトウェア自体を使いこなす」というのが主なスキルであることが多いです。そのため、そういった指向のサービスやソフトウェアのニーズが高まっているとは言い難い状況です。

こういった背景もあって、このアドベントカレンダーではセキュリティ監視基盤を内製で構築するための一連の流れを紹介しました。セキュリティ監視基盤を内製で構築することで、自分たちのニーズに合わせたサービスやソフトウェアを構築することができます。ただし、内製で構築することはコストやリソースの問題があり、またセキュリティ監視基盤の構築には専門的な知識が必要となるため、それらを持つ人材を確保しなければなりません。

## ⚠️ セキュリティ監視とソフトウェアエンジニアリングの両方のスキルがある人材が希少

もう一つの課題が、セキュリティ監視とソフトウェアエンジニアリングの両方のスキルを持つ人材が希少であるという点です。セキュリティ監視においては、セキュリティに関する知識や経験が必要です。一方でソフトウェアエンジニアリングにおいては、プログラミングやアーキテクチャ設計、テストなどのスキルが必要です。これらのスキルや経験を兼ね備えた人材は希少であり、チームを構成するのが難しいという課題があります。

先述した通り現状ではソフトウェアエンジニアリングを適用することを前提としたサービスやソフトウェアが限られているため、既存のサービスやソフトウェアを元に構築するとしても、一定はソフトウェアエンジニアリングのスキルが必要となるでしょう。これはサービスやソフトウェアが少ないことと連鎖した問題となっています。

# まとめ

Detection EngineeringやDetection as Code、Monitoring as Codeなど、既存のセキュリティ監視（あるいはSOC）業務にソフトウェアエンジニアリングの手法を適用するという考え方はまだまだ新しいものであり、適用できる組織も環境も限られているのが現状です。しかし、これらの考え方が今後浸透し、より効率的なセキュリティ対策を実現できるようになることを期待して、この記事を終えたいと思います。
