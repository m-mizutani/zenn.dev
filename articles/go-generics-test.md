---
title: "Genericsã‚’åˆ©ç”¨ã—ãŸGoã®ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£"
emoji: "ğŸ§ª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go", "test"]
published: true
---

# **TL; DR**

Goã®Genericsã‚’æ´»ç”¨ã—ãŸãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’è©¦é¨“çš„ã«ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

[https://github.com/m-mizutani/gt](https://github.com/m-mizutani/gt)

ã“ã‚“ãªæ„Ÿã˜ã«ãƒ†ã‚¹ãƒˆã‚’è¨˜è¿°ã§ãã¾ã™ã€‚

```go
colors := ["red", "blue"]

// NG: colors ãŒé…åˆ—ãªã®ã«ã€æ–‡å­—å‹ã¨æ¯”è¼ƒã—ã‚ˆã†ã¨ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
// gt.Array(t, colors).Equal("red")

// NG: é…åˆ—åŒå£«ã ãŒã€colorsã¯ []string ãªã®ã«å¯¾ã—ã¦ []int ã‚’æ¯”è¼ƒã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã®ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
// gt.Array(t, colors).Equal([]int{1, 2})

// â†“ã¯OKã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¯ã§ãã‚‹
gt.Array(t, colors).Equal([]string{"red", "blue"}) // <- Pass
gt.Array(t, colors).Have("orange")                 // <- Fail

```

# **ã‚„ã‚ŠãŸã„ã“ã¨**

Goã®ãƒ†ã‚¹ãƒˆã¯ã‚‚ã¨ã‚‚ã¨å…¬å¼ã‹ã‚‰ [testing](https://pkg.go.dev/testing) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆãŒè¨˜è¿°ã§ãã¾ã™ã€‚

```go
resp, err := mypkg.MyFunc()
if err != nil {
	t.Errorf("expected no error, but actual is %v", err)
}
if resp != "ok" {
	t.Errorf("expected 'ok', but actual is '%s', resp)
}

```

ã“ã®æ›¸ãæ–¹ã ã¨æ•°è¡Œã®ãƒ†ã‚¹ãƒˆã®å ´åˆã¯ç‰¹ã«å›°ã‚‰ãªã„ã®ã§ã™ãŒã€æ¤œæŸ»ã™ã‚‹é …ç›®æ•°ãŒå¤šã„ã¨è¨˜è¿°é‡ãŒå¤šããªã‚Šå…¨ä½“ã®è¦‹é€šã—ãŒæ‚ªããªã‚Šã¾ã™ã€‚ã¾ãŸã€ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã®ã‚‚å˜ç´”ã«æ‰‹é–“ãŒå¢—ãˆã¦ã—ã¾ã†ã¨ã†èª²é¡Œã‚‚ã‚ã‚Šã¾ã™ã€‚ãã“ã§è‡ªåˆ†ã¯ã€3rd partyã®ãƒ†ã‚¹ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦è¨˜è¿°é‡ã‚’æ¸›ã‚‰ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚è‘—åãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦ã¯ [testify](https://github.com/stretchr/testify) ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

```go
resp, err := mypkg.MyFunc()
require.NoError(t, err)
assert.Equal(t, "ok", resp)

```

ã“ã‚Œã«ã‚ˆã£ã¦è¨˜è¿°é‡ã¯ã ã„ã¶å°‘ãªãã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã™ãŒã€ä¸€ã¤å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚Go1.18ã§GenericsãŒç™»å ´ã™ã‚‹å‰ã¯ä»»æ„ã®å‹ã‚’é–¢æ•°ã«æ¸¡ã™ãŸã‚ã«ã¯ `interface{}` ï¼ˆç¾ä»£ã§ã¯ `any` ï¼‰ã‚’å¼•æ•°ã«æŒ‡å®šã—ã€ `reflect` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã‚ˆã£ã¦å‹ã®æ¤œæŸ»ãªã©ã‚’ã™ã‚‹ã—ã‹æ–¹æ³•ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªå¼Šå®³ãŒã‚ã‚Šã¾ã™ã€‚

- æœŸå¾…ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®å‹ã¨å®Ÿéš›ã«æ¤œæŸ»ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®å‹ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ãŒãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¾ã§ã‚ã‹ã‚‰ãªã„ã€‚ãªã‚“ãªã‚‰ãƒ†ã‚¹ãƒˆãŒé–‹å§‹ã—ãŸã‚ã¨ã‚‚å®Ÿéš›ã«æ¯”è¼ƒã•ã‚Œã‚‹ã¾ã§ã‚ã‹ã‚‰ãªã„
- å‹ãŒã‚ã‹ã‚‰ãªã„ã“ã¨ã«ã‚ˆã£ã¦ã‚¨ãƒ‡ã‚£ã‚¿ã®è£œå®Œæ©Ÿèƒ½ã®æ©æµã‚’å—ã‘ã«ãã„
- é•ã†å‹ã‚’æ¸¡ã—ãŸå ´åˆã®æŒ™å‹•ãŒæƒ³åƒã—ã«ãã„

ã‚‚ã—äº‹å‰ã«å‹ã®æ¤œæŸ»ãŒã§ãã‚‹ã®ã§ã‚ã‚Œã°ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã§é–“é•ã„ã‚’ç¢ºèªã§ãã€é–‹ç™ºä½“é¨“ã®å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚

# Genericsã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½œã‚‹

ã¨ã„ã†ã“ã¨ã§ã›ã£ã‹ãGenerics ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã‚“ã ã‹ã‚‰ã€ã¡ã‚ƒã‚“ã¨å‹ã‚’æ¤œæŸ»ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã€ã¨ã„ã†ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ç´†ä½™æ›²æŠ˜ã‚’çµŒã¦ã€Method Chainå½¢å¼ã§ãƒ†ã‚¹ãƒˆã‚’è¨˜è¿°ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```go
users := getUsers()

// é…åˆ—ã®é•·ã•ãŒ5ã§ Name ãŒ "blue" ã®è¦ç´ ã‚’å«ã‚€ã‹ã‚’æ¤œæŸ»ã™ã‚‹
gt.Array(t, users).
	Length(5).
	Have(&user{Name:"blue"})

```

Genericsã‚’ä½¿ã†ã“ã¨ã§ã€æ›¸å¼ã‚„å‹ãƒã‚§ãƒƒã‚¯ã‚’ã™ã‚‹linterã‚’å…¥ã‚Œã¦ã„ã‚Œã°ã€ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã§é•ã†å‹ã‚’æ¯”è¼ƒã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/8880985a8fb6-20230104.png)

ãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã™ã‚‹ã¨ã€å‹ã«ã‚ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã ã—ã¾ã™ã€‚ `struct` ã®å ´åˆã¯å·®åˆ†ã‚’ã ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```go
gt.Value(t, u1).Equal(&User{
	ID:   "123",
	Name: "orange",
})
```

```go
=== RUN   TestFailure
    value_test.go:235: values are not matched
        diff:
          &gt_test.User{
                ID:   "123",
        -       Name: "orange",
        +       Name: "blue",
          }
```


ä¾‹ãˆã°æ•°å€¤ã®å ´åˆã¯æ¯”è¼ƒå†…å®¹ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãªã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```go
gt.Number(t, v).Greater(12)
```


```go
=== RUN   TestFailure/number
    value_test.go:250: got 10, want grater than 12
```

## å¤‰æ•°ã®ãƒ†ã‚¹ãƒˆ

ãƒ†ã‚¹ãƒˆã¯ã„ãã¤ã‹ã®å‹ã‚’ç”¨æ„ã—ã€ãã‚Œãã‚Œã«å¯¾å¿œã—ãŸæ¤œæŸ»æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

- `Value` ã©ã®å€¤ã§ã‚‚ä½¿ãˆã‚‹ä»£ã‚ã‚Šã«åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆã®ã¿
- `Number` æ•°å€¤ã‚’å¯¾è±¡ã¨ã—ã€å¤§å°æ¯”è¼ƒãªã©ã®ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹
- `Array` slice + array ã‚’å¯¾è±¡ã¨ã—ã€é…åˆ—ã®é•·ã•ã‚„ã‚µãƒ–ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹
- `Map` mapã‚’å¯¾è±¡ã¨ã—ã€ã‚­ãƒ¼ã‚„å€¤ã«é–¢ã™ã‚‹ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹

ä¾‹ãˆã° `Map` ã®å ´åˆã¯ã‚­ãƒ¼ã®æ‰€æŒã‚„å€¤ã®æ‰€æŒã®ç¢ºèªãŒã§ãã¾ã™ãŒã€ä»–ã®å‹ã§ã¯ãã®ã‚ˆã†ãªå¿…è¦ã¯ãªã„ã®ã§ã€ `Map` ã ã‘ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

```go
colors := map[string]int{
  "white": 0,
  "red": 1,
  "blue": 5,
}

gt.Map(t, colors).
	HaveKey("white").      // ã‚­ãƒ¼ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã€‚ã“ã‚Œã¯Pass
	HaveValue(5).          // å€¤ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã€ã“ã‚Œã‚‚Pass
	HaveKeyValue("red", 2) // ã‚­ãƒ¼ã¨å€¤ã®çµ„ã¿åˆã‚ã›ãƒã‚§ãƒƒã‚¯ã€‚ã“ã‚Œã¯Failã«ãªã‚‹
```

ä»–ã«ã‚‚ã€Œå¤§å°æ¯”è¼ƒã€ã¯æ•°å€¤ã«ã—ã‹å¿…è¦ãªã„ã®ã§ã€æ•°å€¤å‹ã§ã®ã¿å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

```go
age := 29

gt.Number(t, age).Greater(20).Less(30)
```

ã“ã‚Œã«ã‚ˆã£ã¦æ¯”è¼ƒã™ã‚‹å€¤åŒå£«ã®å‹ã®ä¸€è‡´ã‚’ç¢ºèªã§ãã‚‹ã ã‘ã§ãªãã€å½¢å¼ã«å¿œã˜ãŸãƒ†ã‚¹ãƒˆï¼ˆãã—ã¦ã‚­ãƒ¼ã‚„å€¤ã®å‹ã®ãƒã‚§ãƒƒã‚¯ã‚‚ã§ãã‚‹ï¼‰ã‚’çµã‚Šã€ãƒ†ã‚¹ãƒˆã‚’è¨˜è¿°ã™ã‚‹éš›ã«å¿…è¦ãªé¸æŠè‚¢ã ã‘ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## äº‹å‰ã®å‹ãƒã‚§ãƒƒã‚¯

`Array` ã‚„ `Map` ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€ãã‚‚ãã‚‚é…åˆ—ã‚„mapå‹ã®ã¿ã‚’å—ã‘ä»˜ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```go
func Map[K comparable, V any](t testing.TB, actual map[K]V) MapTest[K, V] {
  // snip
}

func Array[T comparable](t testing.TB, actual []T) ArrayTest[T] {
  // snip
}
```

ã¾ãŸ `Number` ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€æ•°å€¤å‹ã®ã¿ã‚’å—ã‘ä»˜ã‘ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```go
type number interface {
	int | uint |
		int8 | int16 | int32 | int64 |
		uint8 | uint16 | uint32 | uint64 |
		float32 | float64
}

func Number[T number](t testing.TB, actual T) NumberTest[T] {
// ...(snip)...
```

ãƒ¦ãƒ¼ã‚¶å®šç¾©ã®ã‚«ã‚¹ã‚¿ãƒ å‹ã®å ´åˆã€reflectã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆã ã¨å€¤ãŒåŒã˜ã§ã‚‚é•ã†å‹ã¨ã—ã¦æ‰±ã‚ã‚Œã¦ãƒ†ã‚¹ãƒˆãŒFailã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ãŒã€Genericsã‚’ä½¿ã£ãŸå ´åˆã¯å‹ã¨ã—ã¦ä¸€è‡´ã—ã†ã‚‹ã‹ã‚’äº‹å‰ã«æ¨å®šã—ã¦ãã‚Œã¾ã™ã€‚

```go
type password string
var p password = "xxx"

// å€¤ã¯åŒã˜ã ãŒ "xxx" ã¯stringã¨ã¿ãªã•ã‚Œã‚‹
assert.Equal(t, "xxx", p) // Fail

// gt.Valueã§æ‰±ã†ã®ãŒ passwordå‹ã§ã‚ã‚‹ã“ã¨ãŒæ±ºã¾ã‚‹ãŸã‚ã€ "xxx" ã‚‚passwordå‹ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹
gt.Value(r, p).Equal("xxx") // Pass

```

## å‹åˆ¤å®šã®ãƒ†ã‚¹ãƒˆ

ã¾ãŸã€å¤‰å‰‡çš„ãªã‚‚ã®ã¨ã—ã¦ type assertion ã®ãƒ†ã‚¹ãƒˆã‚‚ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚å¾“æ¥ã®æ›¸ãæ–¹ã ã¨ã€

```go
v, ok := resp.(*User)
if !ok {
  t.Error("type is not matched")
}
if v == nil {
  t.Error("v should not nil")
}
```

ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸãŒã€Genericsã‚’ä½¿ã†ã“ã¨ã§ã“ã®ã‚ˆã†ãªè¨˜è¿°ã‚‚ã§ãã¾ã™ã€‚

```go
// type assertionã«å¤±æ•—ã™ã‚‹ã€ã‚ã‚‹ã„ã¯nilã ã£ãŸå ´åˆã«Fail
v := gt.Cast[*User](t, resp).NotNil()
```

## ä½™è«‡ï¼šãƒœãƒ„æ¡ˆ Functional Options Pattern

åˆ¥æ¡ˆã¨ã—ã¦[Functioanl Option Pattern](https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis)ã§å®Ÿè£…ã™ã‚‹ã¨ã„ã†æ‰‹ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã—ãŸã€‚ä¾‹ãˆã°ã“ã†ã„ã†æ„Ÿã˜ã§ã™ã€‚

```go
title := "my fair lady"
gt.Value(t, title,
	gt.Contain("my"),
)

```

ã“ã¡ã‚‰ã®ã»ã†ãŒGoã£ã½ã„ã®ã§ã„ã„ã‹ãªã¨æ€ã£ãŸã®ã§ã™ãŒã€ã“ã®æ–¹æ³•ã ã¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³å´ã§æ˜ç¤ºçš„ã«æŒ‡å®šã—ãªã„ã¨å‹æ¨è«–ãŒåƒãã¾ã›ã‚“ã€‚ä¾‹ãˆã°ä»®ã«æ–‡å­—åˆ—é•·ã•ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ `Length` ã¨ã„ã†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ãŠã†ã¨ã—ãŸå ´åˆã€

```go
title := "my fair lady"
gt.Value(t, title,
	gt.Contain("my"),
	gt.Length(12), // â† ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼
)
```

ã¨ã„ã†æ›¸ãæ–¹ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã‚Œã¯ã©ã†è¨˜è¿°ã™ã‚Œã°ã„ã„ã‹ã¨è¨€ã†ã¨ã€

```go
title := "my fair lady"
gt.Value(t, title,
	gt.Contain("my"),
	gt.Length[string](12),
)
```

ã¨ãªã‚Šã¾ã™ã€‚ `Contain` ã®æ–¹ã¯å¼•æ•°ãŒ `string` ãªã®ã§ãã‚Œã«ã‚ˆã£ã¦å‹ãŒæ±ºå®šã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã ã¨è¨˜è¿°ã™ã‚‹å´ã®ä½“é¨“ã«å½±éŸ¿ã—ãã†ã¨ã„ã†ã®ã¨ã€Method Chain å½¢å¼ã§ã‚‚ãã‚Œã»ã©è¨˜è¿°é‡ãªã©ãŒå¤‰ã‚ã‚‰ãªã„ã“ã¨ã‹ã‚‰ã€ç¾çŠ¶ã®å½¢å¼ã«ã—ã¾ã—ãŸã€‚

# ã¾ã¨ã‚

Goã¯GenericsãŒãªãã¦ã‚‚ååˆ†ãªè¨˜è¿°åŠ›ã®ã‚ã‚‹è¨€èªã¨æ€ã£ã¦ã„ã¾ã—ãŸãŒã€ã‚„ã¯ã‚ŠGenericsã‚’æ´»ç”¨ã—ã¦é©åˆ‡ã«å‹ã‚’ãƒã‚§ãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ã§ã‚ˆã‚Šã‚³ãƒ¼ãƒ‰ãŒæ›¸ãã‚„ã™ããªã£ãŸã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¾ã§ `interface{}` ã‚„ `reflect` ã«ã‚ˆã£ã¦è£æŠ€çš„ã«è§£æ±ºã—ã¦ã„ãŸã‚‚ã®ãŒã‚ˆã‚Šé©åˆ‡ã«è¨˜è¿°ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€ç”Ÿç”£æ€§ã«ã‚‚è‰¯ã„å½±éŸ¿ãŒã‚ã‚‹ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚Genericsã¯ä½¿ã„æ–¹ã«ã‚ˆã£ã¦ã¯ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã‚’ä¸‹ã’ã¦ã—ã¾ã†ãŸã‚ä¹±ç”¨ã¯é¿ã‘ãŸã„ã§ã™ãŒã€é©åˆ‡ã«é‹ç”¨ã™ã‚‹ã“ã¨ã§ã‚ˆã‚Šé–‹ç™ºä½“é¨“ã‚’é«˜ã‚ã‚‹è©¦ã¿ã¯ä»Šå¾Œã‚‚ã‚„ã£ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚