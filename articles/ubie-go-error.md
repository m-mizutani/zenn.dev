---
title: "Ubieã«ãŠã‘ã‚‹Goè¨€èªã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"
emoji: "ğŸ—³ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go"]
published: true
publication_name: "ubie_dev"
---

# èƒŒæ™¯

Ubieã§ã¯ä»¥ä¸‹ã®è¨˜äº‹ã«ã‚ã‚‹ã‚ˆã†ã«ã€ä¸€æ˜¨å¹´ã‹ã‚‰æ–°ã—ãå§‹ã‚ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯Goã¨TypeScriptã‚’ç©æ¥µçš„ã«æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚ç§ã¯æœ¬æ¥ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒä¸»ãªå°‚é–€é ˜åŸŸãªã®ã§ã™ãŒã€å…¬ç§ã¨ã‚‚ã«æ™®æ®µã‹ã‚‰Goã§ãƒ„ãƒ¼ãƒ«ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã®é–‹ç™ºã‚’ã—ã¦ã„ã‚‹ãŸã‚ã€ç¤¾å†…ã®Goè¨€èªã®æ™®åŠã‚’ã‚µãƒãƒ¼ãƒˆã—ãŸã‚Šãƒ—ãƒ­ãƒ€ã‚¯ãƒˆé–‹ç™ºã«å‚åŠ ã—ãŸã‚Šã—ã¦ã„ã¾ã™ã€‚

https://zenn.dev/ubie_dev/articles/4437cde02a672b

Goè¨€èªã§é–‹ç™ºã—ãŸã“ã¨ãŒã‚ã‚‹æ–¹ã¯ã”å­˜çŸ¥ã‹ã¨æ€ã„ã¾ã™ãŒã€Goã¯æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§æä¾›ã•ã‚Œã¦ã„ã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯æœ€ä½é™ã®æ©Ÿèƒ½ã—ã‹æä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã“ã‚Œã¯ã€CLIãƒ„ãƒ¼ãƒ«ãªã©ã§ã¯ã‚¨ãƒ©ãƒ¼ã®å†…å®¹ãŒç°¡æ½”ã«è¡¨ã›ã¦ã‚ˆã„ã®ã§ã™ãŒã€ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚ˆã†ã«ã‚¨ãƒ©ãƒ¼ã«ã¾ã¤ã‚ã‚‹æƒ…å ±ã‚’è©³ç´°ã«æ®‹ã—ã¦ã‚ã¨ã‹ã‚‰èª¿æŸ»ã«åˆ©ç”¨ã™ã‚‹ã€ã¨ã„ã†å ´é¢ã§ã¯ä¸å‘ãã§ã™ã€‚ç‰¹ã«æœ¬ç•ªç’°å¢ƒã§ã—ã‹å†ç¾ã—ãªã„ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã€ã„ã‹ã«é–¢é€£æƒ…å ±ã‚’æ®‹ã›ã¦ã„ã‚‹ã‹ãŒã€å•é¡Œã®è§£æ±ºã«å¤§ããå½±éŸ¿ã—ã¾ã™ã€‚

å…ˆæ—¥ã‚‚[è©±é¡Œ](https://methane.hatenablog.jp/entry/2024/04/02/Go%E3%81%AEerror%E3%81%8C%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9%E3%82%92%E5%90%AB%E3%81%BE%E3%81%AA%E3%81%84%E7%90%86%E7%94%B1)ã«ãªã£ã¦ã„ã¾ã—ãŸãŒã€Goã®æ¨™æº–ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ãªã£ã¦ã„ã‚‹ã®ã¯ãƒãƒªã‚·ãƒ¼ãªã©ã«ã‚ˆã‚‹ã‚‚ã®ã§ã¯ãªã„ãã†ã§ã™ã€‚ãã®ãŸã‚ã€è‡ªåˆ†ãŸã¡ãŒå¿…è¦ã¨ã—ã¦ã„ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦é‹ç”¨ã—ã¦ãã®ãŒé©åˆ‡ã§ã¯ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

# Goè¨€èªã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è¦ä»¶

ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®Goã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«ãŠã„ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¦ä»¶ãŒã‚ã‚‹ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

## (1) ã‚¨ãƒ©ãƒ¼ã®ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’æ®‹ã™

å…ˆè¿°ã—ãŸãƒ–ãƒ­ã‚°ã«ã‚‚è©±é¡Œã«ä¸ŠãŒã£ã¦ã„ãŸã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã§ã™ãŒã€ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ã¯å¿…é ˆã®æ©Ÿèƒ½ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´æ‰€ã‚’ç‰¹å®šã™ã‚‹ã ã‘ãªã‚‰ã°ä¸€æ„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã™ã‚‹ã ã‘ã§ã‚‚å¯èƒ½ã§ã™ãŒã€ã©ã®ã‚ˆã†ãªçµŒè·¯ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã®ã‹ã‚’çŸ¥ã‚‹ã“ã¨ã¯ã€ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®šã™ã‚‹ä¸Šã§éå¸¸ã«é‡è¦ã§ã™ã€‚ã¾ãŸã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã¨ç›´æ„Ÿçš„ã«ã©ã“ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã®ã‹ãŒã‚ã‹ã‚Šã«ããã€ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã®æ–¹ãŒæœ‰åŠ¹ãªå ´åˆãŒå¤šã„ã§ã™ã€‚

## (2) ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã¨é–¢é€£æƒ…å ±ã‚’åˆ†é›¢ã™ã‚‹

ä¸€èˆ¬çš„ãªGoã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã ã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚¨ãƒ©ãƒ¼ã«é–¢é€£ã™ã‚‹æƒ…å ±ã®å€¤ã‚’åŸ‹ã‚è¾¼ã‚€å½¢ã§ã‚¨ãƒ©ãƒ¼ã‚’æ‰±ã†ã¨æ€ã„ã¾ã™ã€‚

```go
fmt.Errorf("failed to open file: %s", fname)
```

ã—ã‹ã—ã“ã®æ–¹æ³•ã ã¨ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã‚’ç¤ºã™æƒ…å ±ã¨ã‚¨ãƒ©ãƒ¼ã«é–¢é€£ã™ã‚‹æƒ…å ±ãŒä¸€ã¤ã®æ–‡å­—åˆ—ã«æ··ã–ã‚Šåˆã£ã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€ä¾‹ãˆã°ã€ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã”ã¨ã«é›†è¨ˆã‚„é›†ç´„ã‚’ã—ãŸã„å ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã‚’å–ã‚Šå‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å€¤ã®åŸ‹ã‚è¾¼ã¿æ–¹ã¯ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã£ã¦æ§˜ã€…ãªã®ã§ã€ãƒ‘ãƒ¼ã‚¹ã®æ–¹æ³•ã‚‚ã‚¨ãƒ©ãƒ¼ã”ã¨ã«ç•°ãªã‚Šã€ã“ã‚ŒãŒé›†ç´„ã‚„é›†è¨ˆã‚’ã•ã‚‰ã«é›£ã—ãã—ã¦ã„ã¾ã™ã€‚

ã“ã®ã“ã¨ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã«é–¢é€£ã™ã‚‹æƒ…å ±ã¨ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã‚’ç¤ºã™æƒ…å ±ã¯åˆ†é›¢ã—ã¦æ‰±ã†ã®ãŒæœ›ã¾ã—ã„ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

## (3) æ§‹é€ åŒ–ãƒ­ã‚°ã«å¯¾å¿œã™ã‚‹

ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã«ãŠã‘ã‚‹ãƒ­ã‚®ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆä¾‹ï¼šAWSã®CloudWatch Logsã‚„Google Cloudã®Cloud Loggingãªã©ï¼‰ã§ã¯æ§‹é€ åŒ–ãƒ­ã‚°ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯JSONå½¢å¼ãªã©ã§ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã§ã€æ¤œç´¢ã‚„é›†è¨ˆã‚’å®¹æ˜“ã«ã—ã¾ã™ã€‚

ã¾ãŸåŒæ™‚ã«ã€Go 1.21 ã‹ã‚‰ã¯æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«æ§‹é€ åŒ–ãƒ­ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ `slog` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè¿½åŠ ã•ã¾ã—ãŸã€‚ã“ã®ã‚ˆã†ãªèƒŒæ™¯ã‹ã‚‰ã€ã‚¨ãƒ©ãƒ¼ã‚‚æ§‹é€ åŒ–ãƒ­ã‚°ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã“ã¨ã§ã€ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚„ã‚¨ãƒ©ãƒ¼ã®é–¢é€£æƒ…å ±ã‚’æ‰±ã„ã‚„ã™ããªã‚Šã€æ§˜ã€…ãªæ©æµã‚’ã†ã‘ã‚‰ã‚Œã¾ã™ã€‚

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«åˆ©ç”¨ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª `goerr`

https://github.com/m-mizutani/goerr

Ubieå†…ã®Goãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€è‡ªåˆ†ãŒå®Ÿè£…ã—ãŸä¸Šè¨˜ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚ã‚‚ã¨ã‚‚ã¨ã¯ã‚ˆã‚Šã‚¨ãƒ©ãƒ¼ã®æƒ…å ±ã‚’è©³ç´°ã«æ®‹ã™ãŸã‚ã«ä½œæˆã—ãŸã‚‚ã®ã§ã™ãŒã€ `github.com/pkg/errors` ãŒã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚ŒãŸã“ã¨ã‚‚ã‚ã‚Šã€ç¾çŠ¶ã§ã¯ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ´»ç”¨ã—ã¦ã„ã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã„ãã¤ã‚‚ã®ã‚µãƒ¼ãƒ“ã‚¹ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã¤ã¤ã€æœ€åˆã«å®Ÿè£…ã—ã¦ã‹ã‚‰ç´„4å¹´é–“ã»ã©è‡ªåˆ†ã§ä½¿ã„å€’ã—ã¦ããŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã®ã§ã€ã‚ã‚‹ç¨‹åº¦å®‰å®šã—ã¦ã„ã‚‹ã¨è¨€ãˆã‚‹ã‹ãªã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

æ©Ÿèƒ½ã¨ã—ã¦ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹å¾´ã‚’æŒã¡ã¾ã™ã€‚

- ã‚¨ãƒ©ãƒ¼ã®ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’æ®‹ã™
- ã‚¨ãƒ©ãƒ¼ã«é–¢é€£æƒ…å ±ã‚’ä»˜ä¸ã—ã€ã‚ã¨ã‹ã‚‰å–ã‚Šå‡ºã›ã‚‹ï¼ˆkey + valueã®å½¢ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä»˜ä¸ã§ãã‚‹ï¼‰
- `slog` ã«å¯¾å¿œã—ã¦ãŠã‚Šã€æ§‹é€ åŒ–ãƒ­ã‚°ã¨ã—ã¦å‡ºåŠ›ã§ãã‚‹

ä»¥ä¸‹ã€å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã¨ã¨ã‚‚ã«æ©Ÿèƒ½ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã®è¨˜éŒ²ã¨è¡¨ç¤º

ã¾ãšã¯ã‚¨ãƒ©ãƒ¼ã®ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è¨˜éŒ²ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚ `github.com/pkg/errors` ã¨åŒæ§˜ã« `Wrap()` é–¢æ•°ã‚’ç”¨æ„ã—ã¦ãŠã‚Šã€ã“ã‚Œã«ã‚ˆã£ã¦ç•°ãªã‚‹ã‚¨ãƒ©ãƒ¼ã‚’ãƒ©ãƒƒãƒ—ã—ã¤ã¤ã€ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è¨˜éŒ²ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```go
func someAction(fname string) error {
	if _, err := os.Open(fname); err != nil {
		return goerr.Wrap(err, "failed to open file")
	}
	return nil
}

func main() {
	if err := someAction("no_such_file.txt"); err != nil {
		log.Fatalf("%+v", err)
	}
}
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

```
2024/04/06 10:30:27 failed to open file: open no_such_file.txt: no such file or directory
main.someAction
        /Users/mizutani/.ghq/github.com/m-mizutani/goerr/examples/stacktrace_print/main.go:12
main.main
        /Users/mizutani/.ghq/github.com/m-mizutani/goerr/examples/stacktrace_print/main.go:18
runtime.main
        /usr/local/go/src/runtime/proc.go:271
runtime.goexit
        /usr/local/go/src/runtime/asm_arm64.s:1222
exit status 1
```

ã“ã® `%+v` ã®æ›¸å¼ã¯ `github.com/pkg/errors` ã¨äº’æ›æ€§ãŒã‚ã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€ Sentry ã®ã‚ˆã†ã«  `github.com/pkg/errors` ã«å¯¾å¿œã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®å ´åˆã¯ãã®ã¾ã¾åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/082973db9f7d-20240406.png)
*Sentryã§ã®ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹è¡¨ç¤ºä¾‹*

ã¾ãŸã€ `goerr.Error` ã§ã¯ `Stacks()` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨æ„ã—ã¦ãŠã‚Šã€ã“ã‚Œã‚’ä½¿ã£ã¦ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’æ§‹é€ ãƒ‡ãƒ¼ã‚¿ã®ã¾ã¾å–ã‚Šå‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚ `goerr.Error` ã®å–å¾—ã¯ `goerr.Unwrap()` ã‚’ä½¿ã†ã“ã¨ã‚‚ã§ãã¾ã™ã—ã€æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã® `errors.As()` é–¢æ•°ã‚’ä½¿ã†ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```go
if err := someAction("no_such_file.txt"); err != nil {
  var goErr *goerr.Error
  if errors.As(err, &goErr); goErr != nil {
    for i, st := range goErr.Stacks() {
      log.Printf("%d: %v\n", i, st)
    }
  }
  log.Fatal(err)
}
```

ã“ã¡ã‚‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚ä¸€èˆ¬çš„ãªé‹ç”¨ã§ã‚ã‚Œã°ã‚ã¾ã‚Šå¿…è¦ãªã„æ©Ÿèƒ½ã§ã™ãŒã€ç‰¹æ®Šãªãƒ‡ãƒãƒƒã‚°ã‚„ç‹¬è‡ªã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ©Ÿèƒ½ãªã©ã¨çµ±åˆã™ã‚‹éš›ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```
2024/04/06 15:03:54 0: &{Func:main.someAction File:/Users/mizutani/.ghq/github.com/m-mizutani/goerr/examples/stacktrace_extract/main.go Line:12}
2024/04/06 15:03:54 1: &{Func:main.main File:/Users/mizutani/.ghq/github.com/m-mizutani/goerr/examples/stacktrace_extract/main.go Line:18}
2024/04/06 15:03:54 2: &{Func:runtime.main File:/usr/local/go/src/runtime/proc.go Line:271}
2024/04/06 15:03:54 3: &{Func:runtime.goexit File:/usr/local/go/src/runtime/asm_arm64.s Line:1222}
2024/04/06 15:03:54 failed to open file: open no_such_file.txt: no such file or directory
exit status 1
```

## ã‚¨ãƒ©ãƒ¼ã«é–¢é€£æƒ…å ±ã‚’ä»˜ä¸ã™ã‚‹

`goerr` ã¯ `With(key, value)` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã‚¨ãƒ©ãƒ¼ã«é–¢é€£æƒ…å ±ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã¨é–¢é€£æƒ…å ±ã®è¦‹åˆ†ã‘ã‚„ã™ããªã£ãŸã‚Šã€é›†è¨ˆãƒ»é›†ç´„ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚å€¤ã¯ `Values()` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã§å–ã‚Šå‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```go
var errFormatMismatch = errors.New("format mismatch")

func someAction(tasks []task) error {
	for _, t := range tasks {
		if err := validateData(t.Data); err != nil {
			return goerr.Wrap(err, "failed to validate data").With("name", t.Name)
		}
	}
	// ....
	return nil
}

func validateData(data string) error {
	if !strings.HasPrefix(data, "data:") {
		return goerr.Wrap(errFormatMismatch).With("data", data)
	}
	return nil
}

type task struct {
	Name string
	Data string
}

func main() {
	tasks := []task{
		{Name: "task1", Data: "data:1"},
		{Name: "task2", Data: "invalid"},
		{Name: "task3", Data: "data:3"},
	}
	if err := someAction(tasks); err != nil {
		if goErr := goerr.Unwrap(err); goErr != nil {
			for k, v := range goErr.Values() {
				log.Printf("var: %s => %v\n", k, v)
			}
		}
		log.Fatalf("msg: %s", err)
	}
}
```

Output:
```
2024/04/06 14:40:59 var: data => invalid
2024/04/06 14:40:59 var: name => task2
2024/04/06 14:40:59 msg: failed to validate data: : format mismatch
exit status 1
```

ä¾‹ãˆã° Sentry ã«ã‚¨ãƒ©ãƒ¼ã‚’é€ä¿¡ã™ã‚‹å ´åˆã€`goErr.Values()` ã§é–¢é€£æƒ…å ±ã‚’å–ã‚Šå‡ºã—ã¦ãã‚Œã‚’ã‚¹ã‚³ãƒ¼ãƒ—ã«ã‚»ãƒƒãƒˆã™ã‚‹ã“ã¨ã§ã€é–¢é€£æƒ…å ±ã‚’ä¿ã£ãŸã¾ã¾ã‚¨ãƒ©ãƒ¼ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```go
// Sending error to Sentry
hub := sentry.CurrentHub().Clone()
hub.ConfigureScope(func(scope *sentry.Scope) {
  if goErr := goerr.Unwrap(err); goErr != nil {
    for k, v := range goErr.Values() {
      scope.SetExtra(k, v)
    }
  }
})
evID := hub.CaptureException(err)
```

![](https://storage.googleapis.com/zenn-user-upload/548f7f585e38-20240406.png)
*Sentryã§ã®é–¢é€£æƒ…å ±è¡¨ç¤ºä¾‹*

## `slog` ã«ã‚ˆã‚‹æ§‹é€ åŒ–ãƒ­ã‚®ãƒ³ã‚°

å…ˆè¿°ã—ãŸé€šã‚Šã€`Stacks()` ã¨ `Values()` ã§ã‚¨ãƒ©ãƒ¼ã®ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã¨é–¢é€£æƒ…å ±ã‚’æ§‹é€ åŒ–ã—ãŸçŠ¶æ…‹ã§å–ã‚Šå‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦æ§‹é€ åŒ–ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«ã‚¨ãƒ©ãƒ¼ã‚’æ§‹é€ åŒ–ã™ã‚‹ã®ã¯é¢å€’ã§ã™ã€‚ãã“ã§ã€`goerr` ã¯ [slog.LogValuer](https://pkg.go.dev/golang.org/x/exp/slog#LogValuer) ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æ¨™æº–ã§å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ ã“ã‚Œã«ã‚ˆã£ã¦ `goerr.Error` å‹ã‚’ãã®ã¾ã¾ãƒ­ã‚°ã®å¼•æ•°ã¨ã—ã¦æŒ‡å®šã™ã‚‹ã ã‘ã§ã€ã‚¨ãƒ©ãƒ¼ã‚’æ§‹é€ åŒ–ãƒ­ã‚°ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®å‡ºåŠ›ã§ã¯ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚„é–¢é€£æƒ…å ±ã‚‚å«ã¾ã‚Œã¾ã™ã€‚ã¾ãŸã€Wrapã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦ã‚‚å†å¸°çš„ã«å†…å®¹ã‚’å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```go
var errRuntime = errors.New("runtime error")

func someAction(input string) error {
	if err := validate(input); err != nil {
		return goerr.Wrap(err, "failed validation")
	}
	return nil
}

func validate(input string) error {
	if input != "OK" {
		return goerr.Wrap(errRuntime, "invalid input").With("input", input)
	}
	return nil
}

func main() {
	logger := slog.New(slog.NewJSONHandler(os.Stdout, nil))
	if err := someAction("ng"); err != nil {
		logger.Error("aborted myapp", slog.Any("error", err))
	}
}
```

Output:
```json
{
  "time": "2024-04-06T11:32:40.350873+09:00",
  "level": "ERROR",
  "msg": "aborted myapp",
  "error": {
    "message": "failed validation",
    "stacktrace": [
      "/Users/mizutani/.ghq/github.com/m-mizutani/goerr/examples/logging/main.go:16 main.someAction",
      "/Users/mizutani/.ghq/github.com/m-mizutani/goerr/examples/logging/main.go:30 main.main",
      "/usr/local/go/src/runtime/proc.go:271 runtime.main",
      "/usr/local/go/src/runtime/asm_arm64.s:1222 runtime.goexit"
    ],
    "cause": {
      "message": "invalid input",
      "values": {
        "input": "ng"
      },
      "stacktrace": [
        "/Users/mizutani/.ghq/github.com/m-mizutani/goerr/examples/logging/main.go:23 main.validate",
        "/Users/mizutani/.ghq/github.com/m-mizutani/goerr/examples/logging/main.go:15 main.someAction",
        "/Users/mizutani/.ghq/github.com/m-mizutani/goerr/examples/logging/main.go:30 main.main",
        "/usr/local/go/src/runtime/proc.go:271 runtime.main",
        "/usr/local/go/src/runtime/asm_arm64.s:1222 runtime.goexit"
      ],
      "cause": "runtime error"
    }
  }
}
```

# ãŠã‚ã‚Šã«

ä¸€è¨€ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ã„ã£ã¦ã‚‚ã€ãã®è¦ä»¶ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚ç‰¹ã«ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯ãƒ“ã‚¸ãƒã‚¹ã®å•é¡Œã«ç›´çµã™ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ãŸã‚ã€ãªã‚‹ã¹ãå®¹æ˜“ã«å¯¾å¿œãŒã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã®ãŒæœ›ã¾ã—ã„ã¨è€ƒãˆã¾ã™ã€‚

ã‚‚ã¡ã‚ã‚“ã€ä»–ã®çµ„ç¹”ã‚„ä¼æ¥­ã«ãŠã‘ã‚‹æ§˜ã€…ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚‚ã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã®ã§ã€ä»Šå›ã®è¨˜äº‹ãŒä¸€ä¾‹ã¨ã—ã¦å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

# å®£ä¼

Ubieã§ã¯å¼•ãç¶šãã€Goã‚’ä¸­å¿ƒã¨ã—ã¦é–‹ç™ºã™ã‚‹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’å‹Ÿé›†ã—ã¦ã„ã¾ã™ã€‚Goè¨€èªã§ã®é–‹ç™ºçµŒé¨“ãŒã‚ã‚‹æ–¹ã€ã¾ãŸã¯èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯ãœã²ãŠå£°ãŒã‘ãã ã•ã„ã€‚
https://herp.careers/v1/ubiehr/MVrTGYYMgRiy

ã¾ãŸã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã‚‚ä¸»ã«Goè¨€èªã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã¡ã‚‰ã‚‚èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
https://herp.careers/v1/ubiehr/cQ6vihXLiMLg

