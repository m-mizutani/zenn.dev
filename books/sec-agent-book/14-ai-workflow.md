---
title: "AIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ - è¨­è¨ˆã¨å®Ÿè£…"
---

# AIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ¦‚å¿µã¨è¨­è¨ˆæ€æƒ³

æœ¬ç« ã§ã¯ã€AIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä¸€èˆ¬çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³ãƒ»ç®¡ç†ãƒ„ãƒ¼ãƒ«ã«LLMæ©Ÿèƒ½ã‚’çµ„ã¿è¾¼ã‚“ã ã‚‚ã®ã¨å®šç¾©ã—ã¾ã™ã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³ã¯å‡¦ç†ã€å…¥å‡ºåŠ›ã€æ¡ä»¶åˆ†å²ãªã©ã‚’æ¥ç¶šã—ã¦ä¸€é€£ã®æ‰‹ç¶šãã‚„æ¥­å‹™ã‚’è¡¨ç¾ãƒ»å®Ÿè¡Œã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚å‡¦ç†ã‚„å…¥å‡ºåŠ›ã«ã¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é€£æºã‚‚å«ã¾ã‚Œã¾ã™ãŒã€ã‚€ã—ã‚å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºã“ããŒãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä¸»è¦ãªç”¨é€”ã¨è¨€ãˆã¾ã™ã€‚

ä»¥ä¸‹ã¯ä¸€èˆ¬çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä¾‹ã§ã™ã€‚ã“ã®ã‚ˆã†ã«å‡¦ç†ã€åˆ†å²ã€é·ç§»ãŒè¤‡é›‘ã«çµ„ã¿åˆã‚ã•ã‚Šã€è‡ªç”±ãªçŠ¶æ…‹é·ç§»ã‚’è¡¨ç¾ã§ãã¾ã™ã€‚

```mermaid
graph TD
    Start[é–‹å§‹] --> Check1{æ¡ä»¶åˆ¤å®š}
    Check1 -->|A| Process1[å‡¦ç†A]
    Check1 -->|B| Process2[å‡¦ç†B]
    Check1 -->|C| Process3[å‡¦ç†C]

    Process1 --> API1[å¤–éƒ¨API]
    API1 --> Check2{æˆåŠŸ?}
    Check2 -->|Yes| Process4[ãƒ‡ãƒ¼ã‚¿å¤‰æ›]
    Check2 -->|No| API1

    Process2 --> DB[DBæ¤œç´¢]
    DB --> Process4

    Process3 --> Log[ãƒ­ã‚°è¨˜éŒ²]
    Log --> End1[çµ‚äº†]

    Process4 --> Notify[é€šçŸ¥]
    Notify --> End2[å®Œäº†]

    style Start fill:#e1f5ff
    style End1 fill:#f0f0f0
    style End2 fill:#e8f5e9
```

AIãŒçµ„ã¿è¾¼ã¾ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€AIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ€ãƒ¼ã€LLMã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ãªã©ã€ã•ã¾ã–ã¾ãªå‘¼ã³æ–¹ã§å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚OSSã§ã¯n8nã‚„Difyãªã©ãŒä»£è¡¨ä¾‹ã¨ã—ã¦æŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ„ãƒ¼ãƒ«ã®ç‰¹å¾´ã¯ã€ç›´æ¥ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã‚ˆã‚Šã‚‚ç°¡å˜ã«å‡¦ç†ã‚’è¡¨ç¾ã§ãã‚‹ç‚¹ã«ã‚ã‚Šã¾ã™ã€‚DSLï¼ˆDomain Specific Languageï¼‰ã§è¨˜è¿°ã—ãŸã‚Šã€GUIä¸Šã§è¨­å®šã™ã‚‹ã“ã¨ã§ã€ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒã§ããªã„äººã‚„ã€ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ˆã‚Šã‚‚æ‰‹è»½ã«å‡¦ç†ã‚’çµ„ã¿ç«‹ã¦ãŸã„äººã«ã¨ã£ã¦æœ‰ç”¨ãªé¸æŠè‚¢ã¨ãªã‚Šã¾ã™ã€‚

## AIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ãŠã‘ã‚‹AIã®å½¹å‰²

AIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ãŠã„ã¦LLMãŒæ‹…ã†å½¹å‰²ã¯ã€å¤§ããåˆ†ã‘ã¦3ã¤ã‚ã‚Šã¾ã™ã€‚

**ãƒ‡ãƒ¼ã‚¿ã®åŠ å·¥**: é›‘å¤šãªè‡ªç„¶è¨€èªã‚’æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã—ãŸã‚Šã€ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ãŸã‚Šã€ãªã‚“ã‚‰ã‹ã®æ³•å‰‡ã«åŸºã¥ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã™ã‚‹å‡¦ç†ãŒè©²å½“ã—ã¾ã™ã€‚å¾“æ¥ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã¯ã€ãƒ«ãƒ¼ãƒ«è¨˜è¿°ã«ã‚ˆã£ã¦æ±ºå®šæ€§ã®ã‚ã‚‹å‡¦ç†ã‚’å®Ÿç¾ã§ãã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—æ›–æ˜§ãªãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†å ´åˆã€ãƒ«ãƒ¼ãƒ«ã‚’è¨˜è¿°ã™ã‚‹ã®ã¯å›°é›£ã«ãªã‚Šã¾ã™ã€‚ç‰¹ã«è‡ªç„¶è¨€èªã®ã‚ˆã†ãªéæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã¯ã€ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã§ã®å‡¦ç†ãŒæ¥µã‚ã¦é›£ã—ããªã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã€Œèª°ãŒã€ã€Œã©ã“ã§ã€ã€Œä½•ã‚’ã—ãŸã€ã¨ã„ã†æƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹å ´åˆã€ã‚¢ãƒ©ãƒ¼ãƒˆã®æ›¸å¼ãŒçµ±ä¸€ã•ã‚Œã¦ã„ãªã„ã¨ãƒ«ãƒ¼ãƒ«ã§ã®å¯¾å¿œã¯å›°é›£ã«ãªã‚Šã¾ã™ã€‚ç”ŸæˆAIã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ã“ã®ã‚ˆã†ãªæ›–æ˜§ãªãƒ‡ãƒ¼ã‚¿ã‚’æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã¸ã¨å¤‰æ›ã§ãã¾ã™ã€‚ã¾ãŸè‡ªç„¶è¨€èªã‹ã‚‰è‡ªç„¶è¨€èªã¸ã®å¤‰æ›ã‚‚å¯èƒ½ã§ã€é€šçŸ¥æ–‡é¢ã®ä½œæˆãªã©ã«æ´»ç”¨ã§ãã¾ã™ã€‚

**æ¡ä»¶åˆ†å²åˆ¤å®š**: å‡¦ç†ã®å†…å®¹ã¨ã—ã¦ã¯ãƒ‡ãƒ¼ã‚¿åŠ å·¥ã¨æœ¬è³ªçš„ã«ã¯åŒã˜ã§ã™ãŒã€ç›®çš„ãŒç•°ãªã‚Šã¾ã™ã€‚å¾“æ¥ã¯å€‹åˆ¥ã«ãƒ«ãƒ¼ãƒ«ã‚’è¨˜è¿°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸãŒã€ç”ŸæˆAIã‚’ä½¿ã†ã“ã¨ã§æ›–æ˜§ãªåˆ¤å®šã‚’å®Ÿç¾ã§ãã¾ã™ã€‚ã‚‚ã¡ã‚ã‚“ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªæ¥­å‹™åˆ¤æ–­ã«ã¯ä½¿ãˆã¾ã›ã‚“ãŒã€ã‚ã‚‹ç¨‹åº¦ã®æŸ”è»Ÿæ€§ãŒè¨±å®¹ã•ã‚Œã‚‹åˆ¤å®šã§ã‚ã‚Œã°æœ‰ç”¨ã«ãªã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®ç·Šæ€¥åº¦ã‚’4æ®µéšã§åˆ¤å®šã—ãŸã‚Šã€ç‰¹å®šã®æ¡ä»¶ã«è©²å½“ã™ã‚‹ã‹ã‚’æŸ”è»Ÿã«åˆ¤æ–­ã—ãŸã‚Šã™ã‚‹ç”¨é€”ã«å‘ã„ã¦ã„ã¾ã™ã€‚

**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‡¦ç†**: ä»–ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å‡¦ç†ãŒè©²å½“ã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ãƒ‡ãƒ¼ã‚¿åé›†ã‚„åé›†å¯¾è±¡ã®åˆ¤æ–­ã‚’è‡ªå¾‹çš„ã«è¡Œã†èª¿æŸ»ã‚¿ã‚¹ã‚¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆã€ãƒã‚±ãƒƒãƒˆä½œæˆã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆãªã©ã®ä½œæˆãƒ»å¤‰æ›´ã‚¿ã‚¹ã‚¯ãŒå«ã¾ã‚Œã¾ã™ã€‚

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã§åˆ©ç”¨ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã«ãŠã‘ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€SOARï¼ˆSecurity Orchestration, Automation and Responseï¼‰ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã«ç›¸å½“ã—ã¾ã™ã€‚å¾“æ¥ã®SOARã¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®ç¨®é¡ã”ã¨ã«è©³ç´°ãªãƒ«ãƒ¼ãƒ«ã‚’è¨˜è¿°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã‚¢ãƒ©ãƒ¼ãƒˆãŒå¢—ãˆã‚‹ã»ã©é‹ç”¨ã‚³ã‚¹ãƒˆãŒçˆ†ç™ºçš„ã«å¢—å¤§ã™ã‚‹ã¨ã„ã†èª²é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚ã“ã®èª²é¡Œã«ã¤ã„ã¦ã¯ä»¥å‰ã®è¨˜äº‹ã§è§£èª¬ã—ãŸé€šã‚Šã§ã™ã€‚ãã“ã§SOARã«LLMæ©Ÿèƒ½ã‚’çµ„ã¿è¾¼ã‚€ã“ã¨ã§ã€å¾“æ¥ã®èª²é¡ŒãŒã•ã¾ã–ã¾ãªå½¢ã§è»½æ¸›ã•ã‚Œã¾ã™ã€‚

ã—ã‹ã—SOARã«ç”ŸæˆAIã‚’çµ„ã¿è¾¼ã‚“ã ã ã‘ã§å…¨ã¦ãŒè§£æ±ºã™ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¾ç„¶ã¨ã—ã¦ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ãã®ã¯å¤§å¤‰ã§ã™ã€‚ãã‚‚ãã‚‚ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ã‹ãªãã¦ã‚‚ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å‘½ä»¤ã™ã‚‹ã ã‘ã§ã ã„ãŸã„ã®ã“ã¨ã¯ã‚ˆã—ãªã«ã‚„ã£ã¦ãã‚Œã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯äººé–“ã«ä¼´èµ°ã™ã‚‹å­˜åœ¨ã§ã™ã€‚ä¸€æ–¹ã§SOARã¯ãã†ã„ã£ãŸæ€§è³ªã®ãƒ„ãƒ¼ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

## ãã‚Œã§ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¿…è¦ãªç†ç”±

ãã‚Œã§ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¿…è¦ãªç†ç”±ã¯2ã¤ã‚ã‚Šã¾ã™ã€‚ç¬¬ä¸€ã¯ã€æ±ºå®šæ€§ã®ã‚ã‚‹å‡¦ç†ã¯æ±ºå®šæ€§ã‚’ã‚‚ã£ã¦å®Ÿè¡Œã—ãŸã»ã†ãŒã‚ˆã„ã¨ã„ã†ç‚¹ã§ã™ã€‚ãŸã¨ãˆã°LLMã«ç‰¹å®šæ¡ä»¶ã‚’ç„¡è¦–ã•ã›ã‚‹ã“ã¨ã‚‚æ¦‚ã­ã†ã¾ãã„ãã¾ã™ãŒã€ä¸€æŠ¹ã®ä¸å®‰ãŒæ®‹ã‚Šã¾ã™ã€‚ç¢ºå®Ÿæ€§ã‚’ã‚‚ã£ã¦å‡¦ç†ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã¯æ¬²ã—ã„ã¨ã“ã‚ã§ã™ã€‚ãƒ«ãƒ¼ãƒ«ã‚’LLMã«æ›¸ã‹ã›ã¦äººé–“ãŒãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚ãã‚Œã«ã‚ˆã£ã¦åŸºæœ¬ã®å‹•ä½œã¯ä¿è¨¼ã§ãã¾ã™ã€‚ç¬¬äºŒã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã§ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã®äº‹å‰å‡¦ç†ã‚’è¡Œã„ãŸã„ã¨ã„ã†ç‚¹ã§ã™ã€‚å…·ä½“çš„ã«ã¯åˆæœŸãƒˆãƒªã‚¢ãƒ¼ã‚¸ã®ã‚ˆã†ãªå‡¦ç†ãŒè©²å½“ã—ã¾ã™ã€‚äººé–“ãŒä»‹å…¥ã™ã‚‹å‰ã«ã€æ˜ã‚‰ã‹ã«æ£„å´ã™ã¹ãã‚¢ãƒ©ãƒ¼ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ãŸã‚Šã€é€†ã«ç·Šæ€¥åº¦ã®é«˜ã„ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å„ªå…ˆçš„ã«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ãŸã‚Šã—ã¾ã™ã€‚ã“ã®ã‚ˆã†ãªä»•çµ„ã¿ãŒã‚ã‚‹ã¨é‹ç”¨è² è·ã‚’å¤§ããè»½æ¸›ã§ãã¾ã™ã€‚

## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç‹¬ç«‹ã—ã¦å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã‹

ã“ã“ã¾ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã¤ã„ã¦è§£èª¬ã—ã¦ãã¾ã—ãŸãŒã€ãã‚‚ãã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ©Ÿèƒ½ã¨ã—ã¦ç‹¬ç«‹ã•ã›ãšã«æ™®é€šã«ã‚³ãƒ¼ãƒ‰ã§è¡¨ç¾ã™ã‚Œã°ã„ã„ã®ã§ã¯ãªã„ã‹ã¨ã„ã†ç–‘å•ã‚‚ã‚ã‚Šã¾ã™ã€‚ãã®æŒ‡æ‘˜ã¯ã‚‚ã£ã¨ã‚‚ã§ã€ã ã„ãŸã„ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚„è¦ä»¶ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã®å®Ÿè£…ã§å……è¶³ã—ã¾ã™ã€‚ã—ã‹ã—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã—ã¦åˆ†é›¢ã—ã¦ãŠã„ãŸã»ã†ãŒè‰¯ã„ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚Šã¾ã™ã€‚

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åˆ¥ã®ç³»ã§å®Ÿè£…ã—ãŸã»ã†ãŒã‚ˆã„ç†ç”±ã¯ä¸»ã«2ã¤ã‚ã‚Šã¾ã™ã€‚ç¬¬ä¸€ã¯ã€ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¹³æ˜“ã«è¡¨ç¾ã§ãã‚‹ç‚¹ã§ã™ã€‚ãŸã¨ãˆã°ã€Œç‰¹å®šã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯å¸¸ã«æ£„å´ã™ã‚‹ã€ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ã‚’ã€Goã®ã‚³ãƒ¼ãƒ‰ã§æ›¸ãã¨æ¡ä»¶åˆ†å²ã‚„ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†ãŒè¤‡é›‘ã«ãªã‚Šã¾ã™ãŒã€DSLãªã‚‰æ•°è¡Œã§è¡¨ç¾ã§ãã¾ã™ï¼ˆæ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å…·ä½“ä¾‹ã‚’ç¤ºã—ã¾ã™ï¼‰ã€‚ç¬¬äºŒã¯ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ†é›¢ã§ãã‚‹ç‚¹ã§ã™ã€‚å®Ÿè£…åˆ†é›¢ãŒæ˜ç¢ºåŒ–ã•ã‚Œã¦ã„ã‚‹ã¨ã€ã‚³ãƒ¼ãƒ‰ä¸Šã®æ•´ç†ã¨ã—ã¦ã¯è‰¯ã„çŠ¶æ…‹ã«ãªã‚Šã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãªã©ãŒã—ã‚„ã™ããªã‚Šã¾ã™ã€‚ã¾ãŸã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å®Ÿè£…è€…ã¨ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…è€…ã‚’åˆ‡ã‚Šåˆ†ã‘ã‚‰ã‚Œã‚‹ãŸã‚ã€ã‚ˆã‚Šé‹ç”¨å¯„ã‚Šã®äººãŒãƒ­ã‚¸ãƒƒã‚¯ã‚’ã„ã˜ã‚Šã‚„ã™ããªã‚Šã¾ã™ã€‚ãŸã¨ãˆã°é–‹ç™ºãƒãƒ¼ãƒ ã¯ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®æ€§èƒ½æ”¹å–„ã‚„ãƒã‚°ä¿®æ­£ã«é›†ä¸­ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒ ã¯æ¥­å‹™ãƒ­ã‚¸ãƒƒã‚¯ã®èª¿æ•´ã«é›†ä¸­ã™ã‚‹ã¨ã„ã£ãŸå½¹å‰²åˆ†æ‹…ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚å®Ÿéš›ã«ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã®å®Ÿè£…ã§ååˆ†ãªå ´åˆã‚‚ã‚ã‚Šã¾ã™ãŒã€æœ¬ç« ã§ã¯ã‚ãˆã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åˆ¥ã§å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚

# OPA/Regoã®é¸å®šç†ç”±

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã«å¯¾å¿œã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è¨­è¨ˆã®ãŸã‚ã®æ•´ç†

æ±ç”¨çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œã‚ã†ã¨ã™ã‚‹ã¨éå¸¸ã«å¤§å¤‰ã§ã€è‡ªç”±åº¦ã‚’é«˜ã‚ã‚‹ãŸã‚ã«å¤§é‡ã®æ©Ÿèƒ½ã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—ä»Šå›ã¯ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒã¯ã£ãã‚Šã—ã¦ã„ã‚‹ã®ã§ã€ãã‚Œã«å¿œã˜ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œã‚Šã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®æ•´ç†

ä»Šå›å®Ÿè£…ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å—ã‘å–ã‚‹ãŸã³ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚æœ¬æ¥ã¯ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ãŸã‚‰ãã‚Œã‚’å—ä¿¡ã—ã€å‡¦ç†ã™ã‚‹ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®Ÿè£…ã™ã‚‹ã®ãŒã‚ˆã„ã§ã—ã‚‡ã†ã€‚ä»Šå›ã¯ã‚ãã¾ã§å­¦ç¿’ã®ãŸã‚å®Ÿè£…ã—ã‚„ã™ã•ã‚’å„ªå…ˆã—ã¦CLIãƒãƒ£ãƒƒãƒˆã¨ã—ã¦å®Ÿè£…ã—ã¦ã„ã¾ã™ãŒã€å®Ÿç”¨ä¸Šã¯ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã™ã‚‹ãŸã³ã«è‡ªå‹•çš„ã«ä½•ã‹ã—ã‚‰ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ãŸã„ã¨ã„ã†ã®ãŒãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã™ã€‚

é€†ã«ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã®ã¯ã‚¢ãƒ©ãƒ¼ãƒˆåˆ°ç€æ™‚ã ã‘ã§æ§‹ã„ã¾ã›ã‚“ã€‚SOARã§ã¯äººé–“ãŒä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒˆãƒªã‚¬ã™ã‚‹ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚‚çµ„ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚ã—ã‹ã—äººé–“ãŒæŒ‡ç¤ºã™ã‚‹ãªã‚‰ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ååˆ†ã§ã¯ãªã„ã‹ã¨ã„ã†è€ƒãˆæ–¹ã‚‚ã‚ã‚Šã¾ã™ã€‚å®Ÿè£…ã™ã‚‹ã¨ã—ã¦ã‚‚ã€ã‚ã‚‰ã‹ã˜ã‚ç”¨æ„ã—ã¦ãŠã„ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ãªã‚‚ã®ã€AIã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰ã«è¿‘ã„æ¦‚å¿µã§ååˆ†ã§ã¯ãªã„ã‹ã¨è€ƒãˆã¾ã™ã€‚ã“ã‚Œã«ã¤ã„ã¦ã¯æœ¬æ›¸ã§ã¯å®Ÿè£…ã—ã¾ã›ã‚“ãŒã€å®Ÿè£…ã™ã‚‹ä¾¡å€¤ãŒã‚ã‚‹ã“ã¨ã ã‘ã¯è¨€åŠã—ã¦ãŠãã¾ã™ã€‚

ã‚‚ã¡ã‚ã‚“å®šå‹æ¥­å‹™ãŒãƒãƒãƒƒã¨æ±ºã¾ã£ã¦ã„ã‚‹ã‚ˆã†ãªå ´åˆã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè£…ã™ã‚‹ä¾¡å€¤ã¯ã‚ã‚Šã¾ã™ã€‚ãŸã ã—ãã®å ´åˆã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå†…ã«å®Ÿè£…ã™ã‚‹ã®ã§ã¯ãªãã€ãƒ•ãƒ­ãƒ¼ã‚’å¤–éƒ¨ã«ç”¨æ„ã—ã¦å©ãæ–¹æ³•ã‚‚æ¤œè¨ã—ã†ã‚‹ã§ã—ã‚‡ã†ã€‚ãªãœãªã‚‰ã€ãã†ã„ã†ã‚¿ã‚¤ãƒ—ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã ã„ãŸã„å¤–éƒ¨å¹²æ¸‰ç³»ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã ã‹ã‚‰ã§ã™ã€‚å…·ä½“ä¾‹ã¨ã—ã¦ã¯ã€ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®ãƒ«ãƒ¼ãƒ«ã‚’å¤‰æ›´ã™ã‚‹ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åœæ­¢ã™ã‚‹ã€EDRã®æ©Ÿèƒ½ã§ç«¯æœ«ã«å¹²æ¸‰ã™ã‚‹ã¨ã„ã£ãŸå‡¦ç†ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

ã“ã®ã‚ˆã†ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯å¼·ã„æ¨©é™ã‚’æŒã¤ãŸã‚ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã¯åˆ‡ã‚Šé›¢ã—ã€å®Ÿè¡Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ¨©é™ã‚’åˆ†é›¢ã—ã¦ãŠã„ãŸã»ã†ãŒã‚ˆã„ã§ã—ã‚‡ã†ã€‚ã“ã‚Œã¯å˜ç´”ã«æœ€å°æ¨©é™åŒ–ã¨ã„ã†è¦³ç‚¹ã‚‚ã‚ã‚Šã¾ã™ãŒã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã•ã¾ã–ã¾ãªãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†éš›ã«èª¤ã£ã¦å¼·ã„æ¨©é™ãŒç™ºå‹•ã•ã‚Œã‚‹ã¨å±é™ºã§ã™ã€‚ãã®ãŸã‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè¡Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯èª­è¾¼ç³»ã‚’ä¸­å¿ƒã«ã—ã¦ãŠã„ãŸã»ã†ãŒå®‰å…¨ã§ã™ã€‚ã“ã†ã„ã£ãŸæ©Ÿèƒ½ã®ç™ºç«ãƒˆãƒªã‚¬æ©Ÿèƒ½ã¯ä½œã£ã¦ã‚‚ã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã‚€ã—ã‚ä¸€ç™ºæŒ‡ä»¤ã‚’é£›ã°ã™ã ã‘ã«ã™ã‚‹ã¿ãŸã„ãªè¨­è¨ˆã®ã»ã†ãŒã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã¾ãŸã€ç ´å£Šçš„å¤‰æ›´ã‚’ä¼´ã†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«LLMæ©Ÿèƒ½ã‚’ç¹”ã‚Šäº¤ãœã‚‹ã®ã¯å±é™ºã§ã™ã€‚ã„ãšã‚Œã«ã›ã‚ˆã€ä»Šå›ã¯ãã†ã„ã†ã‚¿ã‚¤ãƒ—ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æ‰±ã„ã¾ã›ã‚“ã€‚

### å…·ä½“çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«å¿…è¦ãªæ©Ÿèƒ½

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã«ãŠã„ã¦ã€ã‚¢ãƒ©ãƒ¼ãƒˆå—ä¿¡æ™‚ã«å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¹ã‚¯ã®æ©Ÿèƒ½ã¯ä¸»ã«3ã¤è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚å®Ÿè£…ã‚’ãã‚Œã„ã«åˆ†é›¢ã§ãã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã¾ãšã¯æ©Ÿèƒ½ã¨ã—ã¦æ•´ç†ã—ã¾ã™ã€‚

#### (1) ã‚¢ãƒ©ãƒ¼ãƒˆã®è§£é‡ˆ

ç¬¬ä¸€ã®æ©Ÿèƒ½ã¯ã€å–å¾—ã—ãŸã‚¢ãƒ©ãƒ¼ãƒˆã®å†…å®¹ã‚’è§£é‡ˆã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã¯åˆ†æäº‘ã€…ã§ã¯ãªãã€ã‚¢ãƒ©ãƒ¼ãƒˆæœ¬æ–‡ãƒ‡ãƒ¼ã‚¿å†…ã«ã‚ã‚‹é …ç›®ã‚’å¤‰æ›ã—ãŸã‚Šã€å…±é€šã®é …ç›®ã¸ç½®ãæ›ãˆã‚‹æ­£è¦åŒ–ãªã©ã‚’æŒ‡ã—ã¾ã™ã€‚ã‚¢ãƒ©ãƒ¼ãƒˆã®è¦ç´„ã‚’ä½œæˆã•ã›ã‚‹ã®ã‚‚ã“ã‚Œã«ã‚ãŸã‚Šã€ã‚¿ã‚¤ãƒˆãƒ«ã‚„è¦ç´„ä½œæˆã¯ä»¥å‰ã®è¨˜äº‹ã§è§£èª¬ã—ã¾ã—ãŸã€‚ã¾ãŸã€å—ä¿¡ã—ãŸã‚‚ã®ã‚’ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦æ‰±ã†ã‹ã©ã†ã‹ï¼ˆç„¡è¦–ã—ã¦ã‚‚ã„ã„ã‹ï¼‰ã¨ã„ã†åˆ¤æ–­ã‚‚å«ã¾ã‚Œã¾ã™ã€‚ãŸã¨ãˆã°é–‹ç™ºç’°å¢ƒã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã«ã‚ˆã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆã‚„ã€æ—¢çŸ¥ã®èª¤æ¤œçŸ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã«è©²å½“ã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆã‚’äº‹å‰ã«é™¤å¤–ã™ã‚‹å‡¦ç†ã§ã™ã€‚

ã‚¢ãƒ©ãƒ¼ãƒˆã®æŠ‘åˆ¶ã«ã¤ã„ã¦ã¯ã€é€ä¿¡ã™ã‚‹å´ã§æŠ‘åˆ¶ã™ã¹ãã¨ã„ã†è€ƒãˆæ–¹ã¨ã€å—ä¿¡ã—ãŸå´ã§åˆ¶å¾¡ã™ã‚‹ã¹ãã¨ã„ã†è€ƒãˆæ–¹ãŒã‚ã‚Šã¾ã™ã€‚å€‹äººçš„ã«ã¯ãªã‚‹ã¹ãé€ä¿¡ã™ã‚‹å´ã§åˆ¶å¾¡ã—ãŸã„ã¨ã“ã‚ã§ã™ãŒã€ç¾å®Ÿå•é¡Œã¨ã—ã¦ãã‚‚ãã‚‚åˆ¶å¾¡ã§ããªã„ã‚ˆã†ãªæ¤œçŸ¥æ©Ÿæ§‹ã‚‚å¤šãå­˜åœ¨ã—ã¾ã™ã€‚ã¾ãŸãƒ«ãƒ¼ãƒ«ã‚’çµ±åˆçš„ã«ç®¡ç†ã§ãã‚‹ã¨ã„ã†æ„å‘³ã§ã¯ã€å—ä¿¡å´ã§ç®¡ç†ã—ãŸã»ã†ãŒã‚ˆã„ã¨ã„ã†è¦³ç‚¹ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ã«ã€åˆ†æã¾ã§è¡Œã‹ãšã¨ã‚‚ã‚¢ãƒ©ãƒ¼ãƒˆã®ç†è§£ã‚’ã—ã¦æ•´ç†ã‚’ã™ã‚‹ã¨ã„ã†ãƒ•ã‚§ãƒ¼ã‚ºãŒã¾ãšå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

#### (2) é–¢é€£æƒ…å ±ã®åé›†

ç¬¬äºŒã®æ©Ÿèƒ½ã¯ã€é–¢é€£æƒ…å ±ã®åé›†ã§ã™ã€‚ã“ã‚Œã¯SOARãªã©ã§ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒå¤šã„ã‚‚ã®ã§ã€enrichã¨å‘¼ã°ã‚Œã‚‹ã“ã¨ãŒå¤šã„å‡¦ç†ã§ã™ã€‚å„æ‰€ã‹ã‚‰ãã®ã‚¢ãƒ©ãƒ¼ãƒˆã«é–¢é€£ã—ãã†ãªæƒ…å ±ã‚’åé›†ã—ã¦ä»˜ä¸ã—ã¾ã™ã€‚æ¤œç´¢ã™ã‚‹å†…å®¹ã«ã¤ã„ã¦ã¯ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã®ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ãƒ»ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€ã®å›ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã“ã“ã¾ã§ã§è§£èª¬ã—ãŸã‚‚ã®ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ä¾é ¼ã—ã¦æƒ…å ±ã‚’é›†ã‚ã‚‹ã¨ã„ã†ã®ã‚’ä¸»çœ¼ã«ãŠã„ã¦ã„ã¾ã—ãŸãŒã€ã€Œã“ã®ç¨®é¡ã®ã‚¢ãƒ©ãƒ¼ãƒˆãªã‚‰å¿…ãšã“ã®èª¿æŸ»ã‚’ã™ã‚‹ã€ã¨ã„ã†ã®ãŒæ±ºã¾ã£ã¦ã„ã‚‹ãªã‚‰ã€äººé–“ãŒä»‹å…¥ã™ã‚‹å‰ã«å…ˆæ‰‹ã‚’æ‰“ã£ã¦èª¿æŸ»ã—ãŸã»ã†ãŒã‚ˆã„ã§ã—ã‚‡ã†ã€‚

ã“ã‚Œã¯å¾“æ¥å‹ã®æ±ºå®šæ€§ãƒ«ãƒ¼ãƒ«ã®SOARã®ãƒ•ãƒ­ãƒ¼ã§ã‚‚ã‚„ã‚Šã†ã‚‹ã“ã¨ã§ã™ãŒã€ç”ŸæˆAIãƒ™ãƒ¼ã‚¹ã ã¨æ¬¡ã®ã‚ˆã†ãªå¼·ã„åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚ç¬¬ä¸€ã¯ã€IoCèª¿æŸ»ãªã©ã«ä½¿ã†ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šå‡ºã—ã«é–¢ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’æ˜ç¢ºã«è¨˜è¿°ã—ãªãã¦ã‚‚ã‚ˆã„ç‚¹ã§ã™ã€‚SOARã§ã‚„ã‚‹å ´åˆã€ã©ã®ç¨®é¡ã®ã‚¢ãƒ©ãƒ¼ãƒˆã®ã©ã®ãƒ‘ã‚¹ã®ã©ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã©ã†ã„ã†å€¤ãŒå…¥ã£ã¦ã„ã‚‹ã‹ã‚’æ˜ç¢ºã«å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°AWS GuardDutyã®ã‚¢ãƒ©ãƒ¼ãƒˆãªã‚‰`finding.resource.instanceDetails.networkInterfaces[0].privateIpAddress`ã€CloudTrailã®ã‚¢ãƒ©ãƒ¼ãƒˆãªã‚‰`detail.sourceIPAddress`ã¨ã„ã£ãŸå…·åˆã«ã€ã‚¢ãƒ©ãƒ¼ãƒˆã”ã¨ã«ç•°ãªã‚‹ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã‚Œã¯ã‚¢ãƒ©ãƒ¼ãƒˆã®ç¨®é¡ãŒå¢—ãˆã‚‹ã¨æœ¬å½“ã«è¾›ã„ä½œæ¥­ã§ã€ã—ã‹ã‚‚ãŸã¾ã«æ€¥ã«ã‚¢ãƒ©ãƒ¼ãƒˆã®ã‚¹ã‚­ãƒ¼ãƒãŒå¤‰ã‚ã‚‹ã“ã¨ãŒã‚ã‚Šã€ãã®ãŸã³ã«å¯¾å¿œãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ã—ã‹ã—ç”ŸæˆAIã®å ´åˆã€å€¤ã®æŠ½å‡ºã®ãƒ‘ãƒ¼ãƒˆã§ã‚‚è§£èª¬ã—ãŸã¨ãŠã‚Šã‚ã‚‹ç¨‹åº¦ã¯ã‚ˆã—ãªã«é–¢é€£ã—ãã†ãªå€¤ã‚’æŠ½å‡ºã—ã¦ãã‚Œã¾ã™ã€‚çœŸã«é‡è¦ãªIndicatorãŒå…¥ã£ã¦ã„ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã¡ã‚ƒã‚“ã¨ãƒ«ãƒ¼ãƒ«ã§æŒ‡å®šã™ã‚Œã°ã‚ˆã„ä¸€æ–¹ã§ã€é–¢é€£æƒ…å ±ã¨ã—ã¦å…¥ã£ã¦ãã‚‹ã‚ˆã†ãªã‚‚ã®ã«ã¤ã„ã¦ã¯é›‘ã«æŠ½å‡ºã—ã€ãã‚Œã«ã¤ã„ã¦èª¿ã¹ã‚ˆã¨ã„ã†æŒ‡ç¤ºã§æ¸ˆã¿ã¾ã™ã€‚

ç¬¬äºŒã¯ã€æ‰‹é †ã‚’å³æ ¼ã«æŒ‡ç¤ºã—ãªãã¦ã‚‚ã‚ã‚‹ç¨‹åº¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçš„ã«å‡¦ç†ã—ã¦ãã‚Œã‚‹ç‚¹ã§ã™ã€‚SOARã®å ´åˆã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«é–¢ã—ã¦ã€Œã“ã†ã ã£ãŸã‚‰ã“ã†ã—ã‚ã€ã¿ãŸã„ãªåˆ†å²ã‚’å¤§é‡ã«æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°è„…å¨DB(a)ã§æƒ…å ±ãŒè¦‹ã¤ã‹ã£ãŸã‚‰è„…å¨DB(b)ã§æ·±å €ã‚Šã—ã‚ã€ã¿ãŸã„ãªæŒ‡ç¤ºã§ã™ã€‚ã—ã‹ã—ã“ã‚Œã‚‚ã‚¢ãƒ©ãƒ¼ãƒˆã®ç¨®é¡ã‚„ã‚¹ã‚­ãƒ¼ãƒãŒå¢—ãˆã‚‹ã¨ãƒ«ãƒ¼ãƒ«ãŒçˆ†ç™ºçš„ã«å¢—ãˆã¾ã™ã€‚LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æŒ‡ç¤ºã¯è‡ªç„¶è¨€èªã§ã§ãã‚‹ãŸã‚èé€šãŒããã€å¤§é‡ã®ãƒ«ãƒ¼ãƒ«ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã¡ã‚ã‚“ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªå‡¦ç†ãªã‚‰ãƒ«ãƒ¼ãƒ«ã§æ±ºå®šçš„ãªå‡¦ç†ã‚’ã™ã¹ãã§ã™ãŒã€ã¡ã‚‡ã£ã¨ã—ãŸä¾‹å¤–ã«ã‚‚å¼·ããªã‚‹ã¨ã„ã†ã®ã¯éå¸¸ã«åŠ©ã‹ã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ãªã“ã¨ã‹ã‚‰ã€ç”ŸæˆAIã‚’ä½¿ã£ãŸé–¢é€£æƒ…å ±ã®åé›†ã¯ã€LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ç›´æ¥å•ã„åˆã‚ã›ã¦ã‚‚ã‚ˆã„ã§ã™ã—ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã—ã¦äº‹å‰ã«ã‚„ã£ã¦ãŠãå ´åˆã§ã‚‚éå¸¸ã«æœ‰ç”¨ã§ã™ã€‚

#### (3) åˆå‹•å‡¦ç†

ç¬¬ä¸‰ã®æ©Ÿèƒ½ã¯ã€åˆå‹•å‡¦ç†ã§ã™ã€‚æœ€çµ‚çš„ã«ãã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’åˆå‹•ã§ã©ã†æ‰±ã†ã‹ã‚’æ±ºã‚ã¾ã™ã€‚å…·ä½“çš„ã«ã¯severityã‚’æ±ºã‚ã¦ãã‚Œã«å¿œã˜ã¦é€šçŸ¥ã‚’è¡Œã£ãŸã‚Šã€å ´åˆã«ã‚ˆã£ã¦ã¯é€šçŸ¥ã—ãªã„ã€é€šçŸ¥ã ã‘ã¯ã™ã‚‹ãŒå¯¾å¿œä¸è¦ã¨ã—ã¦ãŠãã€ã‚ã‚‹ã„ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦æ£„å´ã™ã‚‹ã¨ã„ã£ãŸåˆ¤æ–­ã‚’è¡Œã„ã¾ã™ã€‚ã¾ãŸé€šçŸ¥å…ˆã‚’æ±ºã‚ãŸã‚Šã€èª°ãŒæ‹…å½“ã™ã‚‹ã‹ã¨ã„ã£ãŸåˆ¤æ–­ã‚‚å«ã¾ã‚Œã¾ã™ã€‚SOARã§ã¯æ±ºå®šæ€§ã®ã‚ã‚‹ãƒ«ãƒ¼ãƒ«ã§ã“ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ãŒã€å†ä¸‰è¨€ã£ã¦ã„ã‚‹ã¨ãŠã‚Šã‚¢ãƒ©ãƒ¼ãƒˆã®æ•°ãŒå¢—ãˆã¦ãã‚‹ã¨éå¸¸ã«ã—ã‚“ã©ããªã‚Šã¾ã™ã€‚æœ€çµ‚çš„ã«ã ã„ãŸã„å…¨éƒ¨åŒã˜severityã«ãªã£ã¦ã—ã¾ã„ã€ã›ã„ãœã„æ£„å´ or escalationã®2æŠã«ãªã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚

ã“ã‚Œã‚‚ç”ŸæˆAIãƒ™ãƒ¼ã‚¹ã§severityåˆ¤å®šãªã©ã‚’ã—ã¦ã€ãã‚Œã«åŸºã¥ã„ã¦åˆå‹•å‡¦ç†ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãŸã ã—LLMã«ã„ããªã‚Šã€Œseverityåˆ¤å®šã—ã¦ã€ã¨æŠ•ã’ã‹ã‘ã¦ã‚‚é›£ã—ã„ãŸã‚ã€enrichã§å–å¾—ã—ãŸæƒ…å ±ã‚’åˆ©ç”¨ã—ãŸã‚Šã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã¡ã‚ƒã‚“ã¨ä¸ãˆã‚‹ã“ã¨ãŒé‡è¦ã«ãªã‚Šã¾ã™ã€‚enrichæƒ…å ±ã¯ãã®ã¾ã¾å¿…è¦ãªæƒ…å ±ã¨ã—ã¦ä½¿ãˆã¾ã™ã€‚ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã¯è‡ªçµ„ç¹”ã®ç‹¬è‡ªã®æƒ…å ±ã§ã€ã“ã‚Œã‚’ã„ã‹ã«ã†ã¾ãä¸ãˆã‚‹ã‹ã§åˆ¤å®šã®ç²¾åº¦ã¯å¤§ããç•°ãªã‚Šã¾ã™ã€‚å…·ä½“çš„ã«ã¯æ¬¡ã®ã‚ˆã†ãªæƒ…å ±ãŒè©²å½“ã—ã¾ã™ã€‚

- ä½¿ã£ã¦ã„ã‚‹ã‚¤ãƒ³ãƒ•ãƒ©ã€ã‚µãƒ¼ãƒ“ã‚¹ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®æƒ…å ±
- é–‹ç™ºã‚¹ã‚¿ã‚¤ãƒ«ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®é–‹ç™ºãƒ»ç®¡ç†ã‚¹ã‚¿ã‚¤ãƒ«
- ã‚¤ãƒ³ãƒ•ãƒ©å¤‰æ›´ã«é–¢ã™ã‚‹æ‰‹é †ã‚„ã©ã†ã„ã†æ–¹é‡ã§å¤‰æ›´ã—ã¦ã„ã‚‹ã‹
- ãã®ä»–ç‹¬è‡ªã«æ±ºã‚ã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ«
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã‚„ä½“åˆ¶ã®æƒ…å ±
- å…·ä½“çš„ãªã‚¢ãƒ©ãƒ¼ãƒˆå‡¦ç†ã®äº‹ä¾‹ï¼ˆfew-shot promptingçš„ã«ä¸ãˆã‚‹ï¼‰

ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒè¶³ã‚Šãªã„ã¨é©å½“ãªã“ã¨ã—ã‹è¨€ã„ã¾ã›ã‚“ãŒã€é€†ã«ã“ã‚ŒãŒè¶³ã‚Šã¦ã„ã‚‹ã¨ã‚ã‚‹ç¨‹åº¦è«–ç†çš„ãªå›ç­”ã‚’ã—ã¾ã™ã€‚ãŸã ã—å½“ç„¶ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã¯ä¸€å®šèµ·ã“ã‚Šã†ã‚‹ãŸã‚ã€é˜²å¾¡çš„ãªåˆ¤æ–­ã«ã—ã¤ã¤äººé–“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å…¥ã‚Œã‚‹ã“ã¨ãŒç¾æ®µéšã§ã¯é©åˆ‡ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ãŸã¨ãˆã°severityãŒä½ã„ã¨åˆ¤æ–­ã•ã‚ŒãŸã‚‚ã®ã‚‚1æ—¥1åº¦ç›®ã ã‘é€šã™ã‚ˆã†ã«ã™ã‚‹ã¨ã„ã£ãŸå¯¾ç­–ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

ä»Šå›ã¯ã€ã‚ãã¾ã§ã€Œå®šå¸¸çš„ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®åˆå‹•å¯¾å¿œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä¸€ä¾‹ã€ã¨ã„ã†è¦³ç‚¹ã§è¦‹ã¦ãã ã•ã„ã€‚ä»–ã®ã‚„ã‚Šæ–¹ã‚‚ã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯è¨­è¨ˆã‚„å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆãªã©ã‚’è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

### åŸºæœ¬æ–¹é‡

ä»Šå›ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã¯ã€å†’é ­ã§ç¤ºã—ãŸã‚ˆã†ãªè¤‡é›‘ãªåˆ†å²ã‚„ãƒ«ãƒ¼ãƒ—ã‚’æŒã¤è‡ªç”±ãªçŠ¶æ…‹é·ç§»ã‚’ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä¸è¦ã¨ã—ã¾ã™ã€‚ã‚„ã‚‹ã“ã¨ãŒã‚ã‚‹ç¨‹åº¦é™ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã€è‡ªç”±åº¦ã‚’ã‚‚ãŸã›ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

å„ã‚¿ã‚¹ã‚¯ã®è¡¨ç¾ã«ã¯[OPA](https://github.com/open-policy-agent/opa)ï¼ˆOpen Policy Agentï¼‰ã¨[Rego](https://www.openpolicyagent.org/docs/policy-language)ã‚’ä½¿ã„ã¾ã™ã€‚OPA/Regoã¯ã€ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åˆ†é›¢ã•ã‚ŒãŸåˆ¤å®šã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¨˜è¿°ã™ã‚‹ã®ã«ä¾¿åˆ©ã§ã™ã€‚Regoã¯ãƒãƒªã‚·ãƒ¼è¨˜è¿°ã«ç‰¹åŒ–ã—ãŸå®£è¨€çš„ãªè¨€èªã§ã€è¤‡é›‘ãªæ¡ä»¶åˆ¤å®šã‚’ç°¡æ½”ã«è¡¨ç¾ã§ãã¾ã™ã€‚ç‰¹ã«OPA/Regoã«æ‹˜ã‚‹ç†ç”±ã¯ãªãã€ä»–ã®å‡¦ç†ç³»ãªã©ã§ã‚‚ã‚‚ã¡ã‚ã‚“æ§‹ã„ã¾ã›ã‚“ã€‚ãŸã ã—ã€ç‹¬è‡ªã«JSONã‚„YAMLã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ©Ÿèƒ½ã‚’ä½œã‚ã†ã¨ã™ã‚‹ã®ã¯ã‚ã¾ã‚ŠãŠã™ã™ã‚ã—ã¾ã›ã‚“ã€‚åˆ¤å®šã®ãƒ­ã‚¸ãƒƒã‚¯ã§ã¡ã‚‡ã£ã¨è¤‡é›‘ãªã“ã¨ï¼ˆãŸã¨ãˆã°é…åˆ—ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚„ãƒã‚¹ãƒˆã—ãŸæ¡ä»¶åˆ¤å®šï¼‰ã‚’ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€é€”ç«¯ã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å´ã®å®Ÿè£…ãŒã‚„ã‚„ã“ã—ããªã‚‹ãŸã‚ã§ã™ã€‚æ—¢å­˜ã®ä½•ã‹ã‚’ä½¿ã†ã“ã¨ã‚’å‹§ã‚ã¾ã™ã€‚

### å…¨ä½“æ§‹æˆ

ä»Šå›å®Ÿè£…ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€`ingest`, `enrich`, `triage` ã¨ã„ã†3ã¤ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’ã‚‚ã¤æ§‹æˆã«ã—ã¾ã™ã€‚å„ãƒ•ã‚§ãƒ¼ã‚ºã®å½¹å‰²ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

**`ingest` ãƒ•ã‚§ãƒ¼ã‚º**: å—ä¿¡ã—ãŸã‚¢ãƒ©ãƒ¼ãƒˆã‚’è§£é‡ˆãƒ»æ­£è¦åŒ–ã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã‚¿ã‚¤ãƒˆãƒ«ã‚„è¦ç´„ã€æŠ½å‡ºã™ã‚‹å±æ€§å€¤ãªã©ã‚’æ±ºã‚ã¾ã™ã€‚ã¾ãŸä¸€åº¦ã®å—ä¿¡ã«è¤‡æ•°ã‚¢ãƒ©ãƒ¼ãƒˆãŒå«ã¾ã‚Œã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ï¼ˆãŸã¨ãˆã°AWS GuardDutyã®findingsã¯ã€1å›ã®APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«è¤‡æ•°ã®æ¤œçŸ¥çµæœãŒå«ã¾ã‚Œã‚‹ã‚¹ã‚­ãƒ¼ãƒã§ã™ï¼‰ã€‚ã“ã®ã‚ˆã†ãªå ´åˆã€ã‚¢ãƒ©ãƒ¼ãƒˆã‚’åˆ†è§£ã—ã¾ã™ã€‚åˆ†è§£ã•ã‚ŒãŸã‚‰ãã‚Œã¯åˆ¥ã®ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦æ‰±ã‚ã‚Œã€ä»¥é™ã¯ç•°ãªã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã«åˆ†å²ã—ã¦å‡¦ç†ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚ãªãŠã€LLMã«ã‚ˆã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã€è¦ç´„ã®ç”Ÿæˆã‚„å±æ€§å€¤æŠ½å‡ºã¯è‡ªå‹•ã§è¡Œã†ãŸã‚ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©ã§ã¯æ˜ç¤ºçš„ã«è¨˜è¿°ã—ã¾ã›ã‚“ã€‚

**`enrich` ãƒ•ã‚§ãƒ¼ã‚º**: ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’è¡Œã„ã¾ã™ã€‚ã‚ˆã‚Šæ­£ç¢ºã«ã¯ã€LLMã¸ã®å•ã„åˆã‚ã›ã‚„LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’èµ°ã‚‰ã›ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºã¨è¨€ãˆã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚¢ãƒ©ãƒ¼ãƒˆã«å«ã¾ã‚Œã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®è©•åˆ¤æƒ…å ±ã‚’å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰å–å¾—ã—ãŸã‚Šã€é–¢é€£ã™ã‚‹ãƒ­ã‚°ã‚’æ¤œç´¢ã—ãŸã‚Šã™ã‚‹å‡¦ç†ã§ã™ã€‚ç”ŸæˆAIã§ãªã‚“ã‚‰ã‹åˆ¤å®šã•ã›ãŸã‚Šã€æƒ…å ±ã‚’åé›†ã•ã›ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’èµ°ã‚‰ã›ãŸã‚Šã—ã¾ã™ã€‚ã€Œæƒ…å ±ã‚’å–å¾—ã—ãŸã†ãˆã§åˆ¤å®šã‚’ã ã™ã€ã¨ã„ã†ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚‚ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ãã†ã„ã†ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ¸¡ã›ã°å®Ÿç¾ã§ãã¾ã™ã€‚

**`triage` ãƒ•ã‚§ãƒ¼ã‚º**: æœ€çµ‚çš„ã«ã©ã†ã™ã‚‹ã®ã‹ã‚’æ±ºå®šã—ã¾ã™ã€‚ä»Šå›ã¯ã¨ã‚Šã‚ãˆãšã€ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦æ‰±ã†ã€é€šçŸ¥ã ã‘ã™ã‚‹ã€æ£„å´ã€ã®3ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ¤å®šã ã‘ã‚’è¡Œã„ã¾ã™ã€‚ã“ã®ä»–ã«ã‚‚ã€è‡ªå‹•ã‚¢ã‚µã‚¤ãƒ³ã ã£ãŸã‚Šã€`enrich` ã®çµæœã‹ã‚‰å±æ€§å€¤ã‚’è¿½åŠ ã—ãŸã‚Šã¨ã„ã£ãŸå‡¦ç†ã‚‚ã“ã“ã§è¡Œã†ã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚

ä»¥ä¸‹ã«3ãƒ•ã‚§ãƒ¼ã‚ºæ§‹æˆã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å›³ã‚’ç¤ºã—ã¾ã™ã€‚å†’é ­ã§ç¤ºã—ãŸä¸€èˆ¬çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨æ¯”ã¹ã¦ã€çŠ¶æ…‹é·ç§»ãŒå˜ç´”ã§ç›´ç·šçš„ãªæ§‹é€ ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```mermaid
graph LR
    Input[å—ä¿¡ãƒ‡ãƒ¼ã‚¿] --> Ingest[Ingest Phase]

    Ingest --> |æ­£è¦åŒ–ãƒ»è§£é‡ˆ| A1[Alert 1]
    Ingest --> |åˆ†è§£| A2[Alert 2]
    Ingest --> |åˆ†è§£| A3[Alert 3]

    A1 --> Enrich1[Enrich Phase]
    A2 --> Enrich2[Enrich Phase]
    A3 --> Enrich3[Enrich Phase]

    Enrich1 --> |æƒ…å ±åé›†ãƒ»åˆ¤å®š| Triage1[Triage Phase]
    Enrich2 --> |æƒ…å ±åé›†ãƒ»åˆ¤å®š| Triage2[Triage Phase]
    Enrich3 --> |æƒ…å ±åé›†ãƒ»åˆ¤å®š| Triage3[Triage Phase]

    Triage1 --> Decision1{åˆ¤å®š}
    Triage2 --> Decision2{åˆ¤å®š}
    Triage3 --> Decision3{åˆ¤å®š}

    Decision1 --> |ã‚¢ãƒ©ãƒ¼ãƒˆ| Notify1[é€šçŸ¥]
    Decision1 --> |é€šçŸ¥ã®ã¿| Info1[æƒ…å ±é€šçŸ¥]
    Decision1 --> |æ£„å´| Discard1[ç ´æ£„]

    Decision2 --> |ã‚¢ãƒ©ãƒ¼ãƒˆ| Notify2[é€šçŸ¥]
    Decision2 --> |é€šçŸ¥ã®ã¿| Info2[æƒ…å ±é€šçŸ¥]
    Decision2 --> |æ£„å´| Discard2[ç ´æ£„]

    Decision3 --> |ã‚¢ãƒ©ãƒ¼ãƒˆ| Notify3[é€šçŸ¥]
    Decision3 --> |é€šçŸ¥ã®ã¿| Info3[æƒ…å ±é€šçŸ¥]
    Decision3 --> |æ£„å´| Discard3[ç ´æ£„]

    style Ingest fill:#e1f5ff
    style Enrich1 fill:#fff4e1
    style Enrich2 fill:#fff4e1
    style Enrich3 fill:#fff4e1
    style Triage1 fill:#e8f5e9
    style Triage2 fill:#e8f5e9
    style Triage3 fill:#e8f5e9
```

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè£…

å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ææ¡ˆã—ãŸ `ingest` â†’ `enrich` â†’ `triage` ã®3ãƒ•ã‚§ãƒ¼ã‚ºæ§‹æˆã‚’ã€Goã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³ã¨OPA/Regoãƒãƒªã‚·ãƒ¼ã§å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚OPA/Regoã‚’é¸æŠã—ãŸç†ç”±ã¯ã€å‰è¿°ã®é€šã‚Šã€å®£è¨€çš„ãªãƒãƒªã‚·ãƒ¼è¨˜è¿°ã«ã‚ˆã£ã¦ã‚³ãƒ¼ãƒ‰ã¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ˜ç¢ºã«åˆ†é›¢ã§ãã‚‹ç‚¹ã«ã‚ã‚Šã¾ã™ã€‚æ—¢å­˜ã®ãƒ„ãƒ¼ãƒ«ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€ç‹¬è‡ªã®DSLã‚’ä½œã‚‹ã‚ˆã‚Šã‚‚ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è² æ‹…ã‚’å¤§å¹…ã«è»½æ¸›ã§ãã¾ã™ã€‚ä»Šå›ã¯ã‚ãã¾ã§å®Ÿè£…ä¾‹ã¨ã„ã†ä½ç½®ã¥ã‘ãªã®ã§ã€å¿…è¦ã«å¿œã˜ã¦ä»–ã®ãƒ«ãƒ¼ãƒ«ã‚¨ãƒ³ã‚¸ãƒ³ã€ã‚ã‚‹ã„ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚

OPA/Regoã®æ¦‚å¿µã€æ–‡æ³•ãªã©ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„æ–¹ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.openpolicyagent.org/docs/policy-language)æ„å¤–ã«ã‚‚ã€æ‹™è‘—[OPA/Regoå…¥é–€](https://zenn.dev/mizutani/books/d2f1440cfbba94)ã‚‚ã”å‚è€ƒã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

## å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ©Ÿèƒ½ã¯ `pkg/workflow/` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«å®Ÿè£…ã—ã¾ã™ã€‚UseCaseãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¯†ç€ã—ãŸå½¢ã§å®Ÿè£…ã™ã‚‹æ‰‹ã‚‚ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ã‚ã‹ã‚Šã‚„ã™ã•ã‚’é‡è¦–ã—ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦åˆ†é›¢ã—ã¾ã—ãŸã€‚å®Ÿè£…ã‚³ãƒ¼ãƒ‰å…¨ä½“ã¯é•·ã„ãŸã‚ã€æœ¬ç« ã§ã¯è¦ç‚¹ã‚’æŠ½å‡ºã—ã¦è§£èª¬ã—ã¾ã™ã€‚å…¨ä½“ã®ã‚³ãƒ¼ãƒ‰ã¯ãƒªãƒã‚¸ãƒˆãƒªã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®å›³ã¯ã€1ã¤ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚ŒãŸå ´åˆã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã‚’ç¤ºã—ãŸã‚‚ã®ã§ã™ã€‚å®Ÿéš›ã«ã¯ã€Ingestãƒ•ã‚§ãƒ¼ã‚ºã§è¤‡æ•°ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã€ãã®å ´åˆã¯å„ã‚¢ãƒ©ãƒ¼ãƒˆã«å¯¾ã—ã¦Enrichâ†’TriageãŒç‹¬ç«‹ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚å„ãƒ•ã‚§ãƒ¼ã‚ºã§Regoãƒãƒªã‚·ãƒ¼ã®è©•ä¾¡ã‚’å®Ÿæ–½ã—ã€ãã®çµæœã«å¿œã˜ã¦å¿…è¦ãªå‡¦ç†ã‚„åˆ†å²ã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚**Ingestãƒ•ã‚§ãƒ¼ã‚º**ã¯1å›ã®å…¥åŠ›ã‹ã‚‰0å€‹ä»¥ä¸Šã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ï¼ˆ0å€‹ã®å ´åˆã¯æ£„å´ï¼‰ã€**Enrichãƒ•ã‚§ãƒ¼ã‚ºã¨Triageãƒ•ã‚§ãƒ¼ã‚º**ã¯ç”Ÿæˆã•ã‚ŒãŸå„ã‚¢ãƒ©ãƒ¼ãƒˆã«å¯¾ã—ã¦å€‹åˆ¥ã«å®Ÿè¡Œã•ã‚Œã¾ã™

```mermaid
graph TB
    subgraph Input
        RawData[ç”Ÿãƒ‡ãƒ¼ã‚¿ JSON]
    end

    subgraph "Phase 1: Ingest"
        IngestRego[ingest.rego]
        IngestEval[Regoè©•ä¾¡]
        RawData --> IngestRego
        IngestRego --> IngestEval
    end

    subgraph "Phase 2: Enrich å„ã‚¢ãƒ©ãƒ¼ãƒˆæ¯"
        Alert[Alertæ§‹é€ ä½“]
        EnrichRego[enrich.rego]
        EnrichEval[Regoè©•ä¾¡]
        PromptExec[LLM + Toolså®Ÿè¡Œ]
        Alert --> EnrichRego
        EnrichRego --> EnrichEval
        EnrichEval --> PromptExec
    end

    subgraph "Phase 3: Triage"
        TriageRego[triage.rego]
        TriageEval[Regoè©•ä¾¡]
        EnrichResult[Enrichçµæœ]
        PromptExec --> EnrichResult
        Alert --> TriageRego
        EnrichResult --> TriageRego
        TriageRego --> TriageEval
    end

    subgraph Output
        Result[WorkflowResult<br/>action/severity/note]
    end

    IngestEval --> |1å€‹ä»¥ä¸Š| Alert
    IngestEval --> |0å€‹| Reject[æ£„å´]
    TriageEval --> Result

    style IngestRego fill:#e1f5ff
    style EnrichRego fill:#fff4e1
    style TriageRego fill:#e8f5e9
    style Alert fill:#f0f0f0
    style Reject fill:#ffebee
```

## Regoã®åŸºæœ¬

æœ¬æ ¼çš„ãªå®Ÿè£…ã«å…¥ã‚‹å‰ã«ã€Regoã®åŸºæœ¬æ¦‚å¿µã‚’ç°¡å˜ã«èª¬æ˜ã—ã¾ã™ã€‚

Regoã¯ãƒãƒªã‚·ãƒ¼è¨˜è¿°ã«ç‰¹åŒ–ã—ãŸå®£è¨€çš„è¨€èªã§ã€ã€Œæ¡ä»¶ã‚’æº€ãŸã™ã‚‚ã®ã‚’ã‚»ãƒƒãƒˆã«è¿½åŠ ã™ã‚‹ã€ã¨ã„ã†ã‚¹ã‚¿ã‚¤ãƒ«ã§è¨˜è¿°ã—ã¾ã™ã€‚ä»Šå›ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã¯ã€`package` ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§åå‰ç©ºé–“ã‚’å®£è¨€ã—ã€`ingest`, `enrich`, `triage` ã¨ã„ã†3ã¤ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«åˆ†ã‘ã¦ã„ã¾ã™ã€‚

åŸºæœ¬æ§‹æ–‡ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- **`if` ãƒ–ãƒ­ãƒƒã‚¯**: è¤‡æ•°ã®æ¡ä»¶ã‚’ANDæ¡ä»¶ã¨ã—ã¦è©•ä¾¡ã—ã¾ã™
- **`contains`**: æ¡ä»¶ã‚’æº€ãŸã™å ´åˆã€æŒ‡å®šã•ã‚ŒãŸå†…å®¹ã‚’ã‚»ãƒƒãƒˆå‹ã®å¤‰æ•°ã«è¿½åŠ ã—ã¾ã™
- **ã‚»ãƒƒãƒˆå‹å¤‰æ•°**: 0å€‹ä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã—ã€æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã¸æ¸¡ã—ã¾ã™

ä¾‹ãˆã° `alert contains { ... } if { æ¡ä»¶ }` ã¨ã„ã†è¨˜è¿°ã¯ã€ã€Œæ¡ä»¶ã‚’æº€ãŸã™å ´åˆã« `alert` ã‚»ãƒƒãƒˆã¸ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹ã€ã¨ã„ã†æ„å‘³ã«ãªã‚Šã¾ã™ã€‚æ¡ä»¶ã‚’æº€ãŸã•ãªã„å ´åˆã¯ä½•ã‚‚è¿½åŠ ã•ã‚Œãšã€çµæœã¨ã—ã¦0å€‹ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã™ï¼ˆæ£„å´ï¼‰ã€‚

## Ingestãƒ•ã‚§ãƒ¼ã‚ºã®å®Ÿè£…

Ingestãƒ•ã‚§ãƒ¼ã‚ºã¯ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã€ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦å‡¦ç†ã™ã¹ãã‚‚ã®ã‚’æŠ½å‡ºã™ã‚‹æœ€åˆã®ã‚²ãƒ¼ãƒˆã§ã™ã€‚ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦å‡¦ç†ã—ãªã„å ´åˆã¯æ£„å´ï¼ˆç ´æ£„ï¼‰ã•ã‚Œã¾ã™ã€‚

### å®Ÿè£…ã®è¨­è¨ˆæ–¹é‡

Ingestãƒ•ã‚§ãƒ¼ã‚ºãŒè§£æ±ºã™ã‚‹èª²é¡Œã¯ä¸»ã«3ã¤ã‚ã‚Šã¾ã™ã€‚ç¬¬ä¸€ã¯ã€ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®æ­£è¦åŒ–ã§ã™ã€‚æ§˜ã€…ãªå½¢å¼ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’çµ±ä¸€çš„ãªAlertæ§‹é€ ä½“ã«å¤‰æ›ã—ã¾ã™ã€‚ç¬¬äºŒã¯ã€è¤‡æ•°ã‚¢ãƒ©ãƒ¼ãƒˆã¸ã®åˆ†è§£ã§ã™ã€‚1ã¤ã®JSONã«è¤‡æ•°ã®æ¤œçŸ¥çµæœãŒå«ã¾ã‚Œã‚‹å ´åˆï¼ˆä¾‹ï¼šGuardDutyã®findingsé…åˆ—ï¼‰ã€ã“ã‚Œã‚‰ã‚’å€‹åˆ¥ã®ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦åˆ†é›¢ã—ã¾ã™ã€‚ç¬¬ä¸‰ã¯ã€äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§ã™ã€‚æ˜ã‚‰ã‹ã«ä¸è¦ãªã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆé–‹ç™ºç’°å¢ƒã®ãƒ†ã‚¹ãƒˆãªã©ï¼‰ã‚’æ—©æœŸã«æ£„å´ã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®å‡¦ç†ã‚’Regoãƒãƒªã‚·ãƒ¼ã§å®£è¨€çš„ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã§ã€é‹ç”¨ä¸­ã®ãƒ«ãƒ¼ãƒ«èª¿æ•´ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚

### Regoãƒãƒªã‚·ãƒ¼ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

Ingestãƒ•ã‚§ãƒ¼ã‚ºã®ãƒãƒªã‚·ãƒ¼ã¯ `ingest.rego` ã«è¨˜è¿°ã—ã¾ã™ã€‚ä»¥ä¸‹ã«3ã¤ã®å…¸å‹çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¤ºã—ã¾ã™

```rego
package ingest

# ãƒ‘ã‚¿ãƒ¼ãƒ³1: å˜ä¸€ã‚¢ãƒ©ãƒ¼ãƒˆã®ç”Ÿæˆ
alert contains {
    "title": input.title,
    "description": input.description,
    "attributes": [
        {"key": "severity", "value": input.severity, "type": "string"},
    ],
} if {
    # æœ¬ç•ªç’°å¢ƒã‹ã¤severityãŒHIGHã®å ´åˆã®ã¿ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç”Ÿæˆ
    input.environment == "production"
    input.severity == "HIGH"
}

# ãƒ‘ã‚¿ãƒ¼ãƒ³2: é…åˆ—ã‚’è¤‡æ•°ã‚¢ãƒ©ãƒ¼ãƒˆã«å±•é–‹
alert contains {
    "title": sprintf("Finding: %s", [finding.title]),
    "description": finding.description,
    "attributes": [
        {"key": "source_ip", "value": finding.resource.instanceDetails.networkInterfaces[0].publicIp, "type": "ipaddr"},
        {"key": "finding_id", "value": finding.id, "type": "string"},
    ],
} if {
    # findingsé…åˆ—ã®å„è¦ç´ ã‚’å±•é–‹
    some finding in input.findings
    finding.severity >= 4  # severity 4ä»¥ä¸Šã®ã¿
    finding.resource.instanceDetails.networkInterfaces[0].publicIp != null
}

# ãƒ‘ã‚¿ãƒ¼ãƒ³3: è¤‡åˆæ¡ä»¶ã«ã‚ˆã‚‹åˆ¤å®š
# æœ¬ç•ªç’°å¢ƒã‹ã¤ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã§ãªã„å ´åˆã®ã¿é€šã™
alert contains {
    "title": input.title,
    "description": input.description,
    "attributes": [],
} if {
    input.environment == "production"
    input.title != ""
}
```

### Goãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã®è©•ä¾¡

Regoãƒãƒªã‚·ãƒ¼ã‚’è©•ä¾¡ã™ã‚‹Goã®å®Ÿè£…ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®3ã¤ã§ã™ã€‚

1. **äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**: `PreparedEvalQuery`ã‚’ä½¿ã£ã¦åˆæœŸåŒ–æ™‚ã«ãƒãƒªã‚·ãƒ¼ã‚’äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ãŠãã“ã¨ã§ã€å®Ÿè¡Œæ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’å‰Šæ¸›ã—ã¾ã™ã€‚æ¯å›Regoãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã€è©•ä¾¡ã®ãŸã³ã«å®Ÿè¡Œã™ã¹ããƒ«ãƒ¼ãƒ«ã‚’æ¢ç´¢ã™ã‚‹å‡¦ç†ã‚‚çœç•¥ã§ãã¾ã™ã€‚
2. **å‹å¤‰æ›**: è©•ä¾¡çµæœã¯`map[string]any`å‹ã¨ã—ã¦å–å¾—ã•ã‚Œã‚‹ãŸã‚ã€å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦Goæ§‹é€ ä½“ã«å¤‰æ›ã—ã¾ã™ã€‚`json.Marshal/Unmarshal`ã§ã‚‚åŒæ§˜ã®ã“ã¨ãŒã§ãã¾ã™ãŒã€Regoã®è©•ä¾¡çµæœã¯å‹ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ã“ã¨ã§ä¸è¦ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’é¿ã‘ã¦ã„ã¾ã™ã€‚å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã®å¤±æ•—ã«å‚™ãˆã¦ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹: `alertMap, ok := a.(map[string]any)` ã§ãƒã‚§ãƒƒã‚¯ï¼‰ã€‚
3. **ç©ºçµæœã®æ‰±ã„**: `alert`ã‚»ãƒƒãƒˆãŒç©ºã®å ´åˆã¯æ£„å´ã‚’æ„å‘³ã—ã€ã“ã‚Œã¯ã‚¨ãƒ©ãƒ¼ã§ã¯ãªãæ­£å¸¸ãªå‹•ä½œã§ã™


```go
func (e *Engine) runIngest(ctx context.Context, rawData any) (*IngestResult, error) {
    // 1. Regoãƒãƒªã‚·ãƒ¼ã‚’è©•ä¾¡ï¼ˆinputã¨ã—ã¦rawDataã‚’æ¸¡ã™ï¼‰
    rs, err := e.ingestPolicy.Eval(ctx, rego.EvalInput(rawData))
    if err != nil {
        return nil, err
    }

    // 2. è©•ä¾¡çµæœã‹ã‚‰"alert"ã‚»ãƒƒãƒˆã‚’å–å¾—
    data := rs[0].Expressions[0].Value.(map[string]any)
    alertData := data["alert"]  // Regoã®alertã‚»ãƒƒãƒˆ
    alerts := alertData.([]any)

    // 3. Goæ§‹é€ ä½“ã«å¤‰æ›
    result := &IngestResult{Alert: make([]*IngestedAlert, 0, len(alerts))}
    for _, a := range alerts {
        alertMap := a.(map[string]any)
        result.Alert = append(result.Alert, &IngestedAlert{
            Title:       alertMap["title"].(string),
            Description: alertMap["description"].(string),
            Attributes:  parseAttributes(alertMap["attributes"]),
        })
    }
    return result, nil
}
```

ä¸Šè¨˜ã®å®Ÿè£…ã¯ã€å®Ÿéš›ã«ã¯åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚ºã¨å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚ºã«åˆ†ã‹ã‚Œã¾ã™ã€‚åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯`rego.New()`ã§Regoã‚¨ãƒ³ã‚¸ãƒ³ã‚’ç”Ÿæˆã—ã€`PrepareForEval()`ã§ãƒãƒªã‚·ãƒ¼ã‚’äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¾ã™ã€‚å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ã€`Eval()`ã§ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã¨ã—ã¦è©•ä¾¡ã—ã€çµæœã‚»ãƒƒãƒˆã‹ã‚‰`alert`ã‚’å–ã‚Šå‡ºã—ã¦Goæ§‹é€ ä½“ã«å¤‰æ›ã—ã¾ã™ã€‚ä»¥ä¸‹ã®å›³ã¯ã€ã“ã®ä¸€é€£ã®æµã‚Œã‚’ç¤ºã—ãŸã‚‚ã®ã§ã™ã€‚

```mermaid
sequenceDiagram
    participant G as Go Runtime
    participant R as Rego Engine
    participant P as Policy File

    G->>R: rego.New(Query, Module)
    R->>R: PrepareForEval()
    Note over R: ãƒãƒªã‚·ãƒ¼ã‚’äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

    G->>R: Eval(input=rawData)
    R->>P: ãƒãƒªã‚·ãƒ¼è©•ä¾¡
    P-->>R: data.ingest.alert = [...]
    R-->>G: ResultSet

    G->>G: data["alert"]ã‚’å–å¾—
    G->>G: Goæ§‹é€ ä½“ã«å¤‰æ›
```


## Enrichãƒ•ã‚§ãƒ¼ã‚ºã®å®Ÿè£…

Enrichãƒ•ã‚§ãƒ¼ã‚ºã¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆã«å¯¾ã™ã‚‹è¿½åŠ èª¿æŸ»ã‚’LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å®Ÿè¡Œã•ã›ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºã§ã™ã€‚Enrichãƒ•ã‚§ãƒ¼ã‚ºã®ç‰¹å¾´ã¯ã€**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å®šç¾©**ã¨**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å®Ÿè¡Œ**ã‚’åˆ†é›¢ã—ã¦ã„ã‚‹ç‚¹ã§ã™ã€‚Regoã¯ãƒãƒªã‚·ãƒ¼è©•ä¾¡ã«ç‰¹åŒ–ã—ã¦ã„ã‚‹ãŸã‚ã€LLMã¨ã®ã‚„ã‚Šå–ã‚Šã¯Goãƒ©ãƒ³ã‚¿ã‚¤ãƒ å´ã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```mermaid
graph LR
    A[Alert] --> B[enrich.rego]
    B --> C[Promptå®šç¾©é…åˆ—]
    C --> D[executePrompt]
    D --> E[LLM + Tools]
    E --> F[å®Ÿè¡Œçµæœ]

    style B fill:#fff4e1
    style D fill:#e8f5e9
```

ã“ã®åˆ†é›¢ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®å½¹å‰²åˆ†æ‹…ãŒå®Ÿç¾ã•ã‚Œã¾ã™ã€‚

- **Regoãƒãƒªã‚·ãƒ¼**ï¼šã€Œä½•ã‚’èª¿æŸ»ã™ã‚‹ã‹ã€ã‚’å®£è¨€çš„ã«è¨˜è¿°
- **Goãƒ©ãƒ³ã‚¿ã‚¤ãƒ **ï¼šã€Œã©ã†å®Ÿè¡Œã™ã‚‹ã‹ã€ã‚’æ‰‹ç¶šãçš„ã«å‡¦ç†

### Regoãƒãƒªã‚·ãƒ¼ã§ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®šç¾©

`enrich.rego` ã§ã¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆã®å†…å®¹ã«å¿œã˜ã¦å®Ÿè¡Œã™ã¹ããƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‹•çš„ã«ç”Ÿæˆã—ã¾ã™ã€‚`prompt` ã‚»ãƒƒãƒˆã«æ ¼ç´ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãã‚Œãã‚Œ1ã¤ã®ã‚¿ã‚¹ã‚¯ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚

å„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ä»¥ä¸‹ã®3ã¤ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚

- **`id`**: èª¿æŸ»ã‚¿ã‚¹ã‚¯ã®è­˜åˆ¥å­ã€‚ä¾‹ãˆã°ã€Triageãƒ•ã‚§ãƒ¼ã‚ºã§ `result.id == "check_ip_reputation"` ã®ã‚ˆã†ã«ç‰¹å®šã®èª¿æŸ»çµæœã‚’å‚ç…§ã™ã‚‹éš›ã«ä½¿ç”¨ã—ã¾ã™ã€‚
- **`content`**: LLMã«ç™ºè¡Œã™ã‚‹å…·ä½“çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ã€‚å…ƒã‚¢ãƒ©ãƒ¼ãƒˆã®æƒ…å ±ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã¾ã‚Œã‚‹ãŸã‚ã€è¿½åŠ ã§å¿…è¦ãªèª¿æŸ»å†…å®¹ã‚„è¦³ç‚¹ã‚’æŒ‡ç¤ºã—ã¾ã™ã€‚
- **`format`**: å¿œç­”å½¢å¼ï¼ˆ`text` ã¾ãŸã¯ `json`ï¼‰ã€‚`json`ã‚’æŒ‡å®šã™ã‚‹ã¨æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å–å¾—ã§ãã€å¾Œç¶šã®Triageãƒ•ã‚§ãƒ¼ã‚ºã§ã®è§£æãŒå®¹æ˜“ã«ãªã‚Šã¾ã™

```rego
package enrich

# ãƒ‘ã‚¿ãƒ¼ãƒ³1: å±æ€§å€¤ã«åŸºã¥ãèª¿æŸ»
prompt contains {
    "id": "check_ip_reputation",
    "content": "Check the reputation of IP addresses found in the alert using threat intelligence tools. Summarize any malicious indicators.",
    "format": "text",
} if {
    # IPã‚¢ãƒ‰ãƒ¬ã‚¹å±æ€§ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿
    some attr in input.attributes
    attr.type == "ipaddr"
}

# ãƒ‘ã‚¿ãƒ¼ãƒ³2: JSONå½¢å¼ã§ã®æ§‹é€ åŒ–å¿œç­”
prompt contains {
    "id": "domain_analysis",
    "content": "Analyze the domain using threat intelligence. Return JSON with keys: domain, threat_score (0-10), categories (array).",
    "format": "json",
} if {
    some attr in input.attributes
    attr.type == "domain"
}

# ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã‚¢ãƒ©ãƒ¼ãƒˆå†…å®¹ã«å¿œã˜ãŸèª¿æŸ»
prompt contains {
    "id": "assess_urgency",
    "content": "Assess the urgency of this unauthorized access. Consider: 1) Time of day, 2) Affected resource, 3) Access pattern.",
    "format": "text",
} if {
    contains(input.title, "unauthorized")
    not contains(input.title, "test")  # ãƒ†ã‚¹ãƒˆã‚¢ãƒ©ãƒ¼ãƒˆã¯é™¤å¤–
}
```

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å®Ÿè¡Œ

Regoã§å®šç¾©ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’LLMã§å®Ÿè¡Œã—ã¾ã™ã€‚Function Callingã®è©³ç´°ã¯åˆ¥ã®å›ã§è§£èª¬æ¸ˆã¿ãªã®ã§ã€ã“ã“ã§ã¯Enrichãƒ•ã‚§ãƒ¼ã‚ºã§ã®åˆ©ç”¨æ–¹æ³•ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚

```go
func (e *Engine) executePrompt(ctx context.Context, prompt AgentPrompt, alert *model.Alert) (string, error) {
    // 1. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã‚·ã‚¹ãƒ†ãƒ æŒ‡ç¤ºã‚’æ§‹ç¯‰
    systemInstruction := buildInstructionFromTemplate(prompt, alert)

    // 2. ãƒ„ãƒ¼ãƒ«ä»˜ãã§LLMã‚’è¨­å®š
    config := &genai.GenerateContentConfig{
        SystemInstruction: genai.NewContentFromText(systemInstruction, ""),
        Tools:             e.registry.Specs(),
    }

    // 3. Function Callingãƒ«ãƒ¼ãƒ—ã§èª¿æŸ»ï¼ˆè©³ç´°ã¯åˆ¥å›ã§è§£èª¬æ¸ˆã¿ï¼‰
    result := runFunctionCallingLoop(ctx, config)

    // 4. format="json"ã®å ´åˆã¯ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
    if prompt.Format == "json" {
        result = cleanJSONResponse(result)
    }

    return result, nil
}
```

`cleanJSONResponse`ã¯ã€LLMãŒMarkdownã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯è¨˜æ³•ï¼ˆ```jsonï¼‰ã§å›²ã‚“ã§è¿”ã—ãŸå ´åˆã«ãã‚Œã‚’é™¤å»ã—ã€ç´”ç²‹ãªJSONæ–‡å­—åˆ—ã«æ•´å½¢ã™ã‚‹å‡¦ç†ã§ã™ã€‚

#### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ`prompt/enrich.md`ï¼‰

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯Markdownãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ç®¡ç†ã—ã€Goæ¨™æº–ã®`embed`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§åŸ‹ã‚è¾¼ã‚“ã§ `text/template` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§æ§‹ç¯‰ã™ã‚‹ã¨ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ãŒå‘ä¸Šã—ã¾ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã® `.PromptContent` ã«Regoã§å®šç¾©ã—ãŸã‚¿ã‚¹ã‚¯å†…å®¹ã‚’å·®ã—è¾¼ã¿ã€ã‚¢ãƒ©ãƒ¼ãƒˆæƒ…å ±ã‚’æ§‹é€ åŒ–ã—ã¦æä¾›ã™ã‚‹ã“ã¨ã§ã€LLMãŒå¿…è¦ãªæƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™

```markdown
You are a security analyst assistant. Execute the following task:

{{ .PromptContent }}

## Alert Information
**Title:** {{ .Alert.Title }}
**Description:** {{ .Alert.Description }}

## Attributes
{{- range .Alert.Attributes }}
- **{{ .Key }}:** {{ .Value }} (type: {{ .Type }})
{{- end }}
```

## Triageãƒ•ã‚§ãƒ¼ã‚ºã®å®Ÿè£…

Triageãƒ•ã‚§ãƒ¼ã‚ºã¯ã€Enrichã®çµæœã‚’è¸ã¾ãˆã¦æœ€çµ‚åˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚

### Regoãƒãƒªã‚·ãƒ¼ã®å®Ÿè£…

`triage.rego`ã§ã¯ã€Enrichãƒ•ã‚§ãƒ¼ã‚ºã®èª¿æŸ»çµæœï¼ˆ`input.enrich`ï¼‰ã‚’å‚ç…§ã—ãªãŒã‚‰æœ€çµ‚åˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚

ãƒãƒªã‚·ãƒ¼ã®æ›¸ãæ–¹ã®åŸºæœ¬ã¯Ingestã‚„Enrichã¨åŒã˜ã§ã™ãŒã€Ingestã‚„Enrichã¨ç•°ãªã‚Šã€Triageãƒ•ã‚§ãƒ¼ã‚ºã§æ‰±ã† `action`, `severity`, `note` ã¯ã‚»ãƒƒãƒˆå‹ã§ã¯ãªãã€å˜ä¸€ã®æ–‡å­—åˆ—å€¤ã‚’æŒã¤ç‚¹ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚Regoã§ã¯åŒã˜å¤‰æ•°ã«è¤‡æ•°ã®ç•°ãªã‚‹å€¤ã‚’ä»£å…¥ã™ã‚‹ã¨è©•ä¾¡ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ï¼ˆå¤‰æ•°ã¯ä¸€åº¦æŸç¸›ã•ã‚Œã‚‹ã¨å¤‰æ›´ã§ãã¾ã›ã‚“ï¼‰ã€‚`default` ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æŒ‡å®šã—ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ä¾‹å¤–ã§ã€ä»–ã®ãƒ«ãƒ¼ãƒ«ã§ä¸Šæ›¸ãã•ã‚Œãªã„å ´åˆã«ã®ã¿ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã‚‚ã—è¤‡æ•°ã®ãƒ«ãƒ¼ãƒ«ã§è©•ä¾¡ã—ãŸçµæœã‹ã‚‰æœ€ã‚‚é‡å¤§åº¦ã®é«˜ã„å€¤ã‚’é¸æŠã—ãŸã„å ´åˆã¯ã€ã‚»ãƒƒãƒˆå‹ã«ã—ã¦Goã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å´ã§åˆ¤å®šå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã¨ã„ã†æ‰‹ã‚‚ã‚ã‚Šã¾ã™ã€‚

Triageãƒ•ã‚§ãƒ¼ã‚ºã§ã¯2ã¤ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚`input.alert` ã«ã¯ã‚¢ãƒ©ãƒ¼ãƒˆè‡ªä½“ã®æƒ…å ±ï¼ˆtitleã€descriptionã€attributesï¼‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

`input.enrich` ã«ã¯Enrichãƒ•ã‚§ãƒ¼ã‚ºã®å®Ÿè¡ŒçµæœãŒé…åˆ—å½¢å¼ï¼ˆ`[]{ "id": "...", "result": "..." }`ï¼‰ã§æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚Enrichçµæœã®ä¸­èº«ã¯ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯JSONæ–‡å­—åˆ—ãªã®ã§ã€`contains` é–¢æ•°ã§æ–‡å­—åˆ—æ¤œç´¢ã—ãŸã‚Šã€`json.unmarshal` ã§ãƒ‘ãƒ¼ã‚¹ã—ã¦æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã£ãŸã‚Šã§ãã¾ã™

```rego
package triage

default action = "accept"
default severity = "medium"
default note = ""

# ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã‚¢ãƒ©ãƒ¼ãƒˆå†…å®¹ã«ã‚ˆã‚‹åˆ¤å®š
action = "discard" if {
    contains(input.alert.title, "maintenance")
}

# ãƒ‘ã‚¿ãƒ¼ãƒ³2: Enrichçµæœã‚’å‚ç…§ã—ãŸåˆ¤å®š
severity = "critical" if {
    some result in input.enrich
    result.id == "check_ip_reputation"
    contains(result.result, "malicious")  # Enrichã§"malicious"ãŒè¦‹ã¤ã‹ã£ãŸ
}

severity = "high" if {
    contains(input.alert.title, "unauthorized")
    not contains(input.alert.title, "test")
}
```


Goã§ã®è©•ä¾¡ã¯ã€Ingestã‚„Enrichã¨åŒæ§˜ã«`Eval()`ã§è©•ä¾¡ã—ã€çµæœã‹ã‚‰`action`/`severity`/`note`ã‚’å–å¾—ã—ã¾ã™ã€‚

## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³ã®çµ±åˆ

### ãƒãƒªã‚·ãƒ¼ã®èª­ã¿è¾¼ã¿ã¨äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³ã¯ã€èµ·å‹•æ™‚ã«3ã¤ã®ãƒ•ã‚§ãƒ¼ã‚ºã«å¯¾å¿œã™ã‚‹Regoãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¾ã™ã€‚

Regoã¯ãƒ•ã‚¡ã‚¤ãƒ«åã‚„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«ä¾å­˜ã—ãªã„è¨­è¨ˆã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€æŒ‡å®šã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã‹ã‚‰å…¨ã¦ã®Regoãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ã‚¯ã‚¨ãƒªã ã‘ã‚’äº‹å‰ã«å„ãƒ•ã‚§ãƒ¼ã‚ºã«æŒ¯ã‚Šåˆ†ã‘ã¾ã™ã€‚`PrepareForEval()` ãƒ¡ã‚½ãƒƒãƒ‰ã§äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã“ã¨ã§ã€å®Ÿè¡Œæ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚ãƒãƒªã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ `nil` ã‚’è¿”ã—ã¾ã™ãŒã€ã“ã‚Œã¯ã‚¨ãƒ©ãƒ¼ã§ã¯ãªãæ­£å¸¸ãªå‹•ä½œã§ã™ã€‚ã“ã®å ´åˆã€è©²å½“ãƒ•ã‚§ãƒ¼ã‚ºã®è©•ä¾¡ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œï¼ˆä¾‹: å…¨ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€šéã•ã›ã‚‹ï¼‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã‚¯ã‚¨ãƒªã¯ `data.<packageå>` ã¨ã„ã†å½¢å¼ã§æŒ‡å®šã—ã¾ã™ã€‚ã“ã‚Œã¯Regoã®è©•ä¾¡ãƒ¢ãƒ‡ãƒ«ã§ã€`data`åå‰ç©ºé–“ä»¥ä¸‹ã«å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è©•ä¾¡çµæœãŒæ ¼ç´ã•ã‚Œã‚‹ãŸã‚ã§ã™ï¼ˆä¾‹ï¼š`data.ingest.alert`ã€`data.enrich.prompt`ã€`data.triage.action`ï¼‰

```go
// loadPolicies loads all Rego files from policyDir and prepares queries for each phase
func loadPolicies(ctx context.Context, policyDir string) (ingest, enrich, triage *rego.PreparedEvalQuery, err error) {
	// Read all .rego files from the directory
	files, err := filepath.Glob(filepath.Join(policyDir, "*.rego"))
	if err != nil {
		return nil, nil, nil, goerr.Wrap(err, "failed to glob policy files")
	}

	if len(files) == 0 {
		// No policy files found, return nil for all phases
		return nil, nil, nil, nil
	}

	// Load all policy files as modules
	modules := make([]func(*rego.Rego), 0, len(files))
	for _, file := range files {
		data, err := os.ReadFile(file)
		if err != nil {
			return nil, nil, nil, goerr.Wrap(err, "failed to read policy file", goerr.Value("path", file))
		}
		modules = append(modules, rego.Module(file, string(data)))
	}

	// Prepare query for ingest phase
	ingest, err = prepareQuery(ctx, modules, "data.ingest")
	if err != nil {
		return nil, nil, nil, goerr.Wrap(err, "failed to prepare ingest query")
	}

	// Prepare query for enrich phase
	enrich, err = prepareQuery(ctx, modules, "data.enrich")
	if err != nil {
		return nil, nil, nil, goerr.Wrap(err, "failed to prepare enrich query")
	}

	// Prepare query for triage phase
	triage, err = prepareQuery(ctx, modules, "data.triage")
	if err != nil {
		return nil, nil, nil, goerr.Wrap(err, "failed to prepare triage query")
	}

	return ingest, enrich, triage, nil
}

// prepareQuery prepares a Rego query with all loaded modules
func prepareQuery(ctx context.Context, modules []func(*rego.Rego), query string) (*rego.PreparedEvalQuery, error) {
	// Build Rego options
	options := make([]func(*rego.Rego), 0, len(modules)+1)
	options = append(options, rego.Query(query))
	options = append(options, modules...)

	r := rego.New(options...)

	prepared, err := r.PrepareForEval(ctx)
	if err != nil {
		return nil, goerr.Wrap(err, "failed to prepare query", goerr.Value("query", query))
	}

	return &prepared, nil
}
```


### Executeé–¢æ•°ï¼š3ãƒ•ã‚§ãƒ¼ã‚ºã®å®Ÿè¡Œ

`Execute` é–¢æ•°ã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°ã§ã™ã€‚Ingestãƒ•ã‚§ãƒ¼ã‚ºã¯1å›ã ã‘å®Ÿè¡Œã—ã€0å€‹ä»¥ä¸Šã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚Enrichãƒ•ã‚§ãƒ¼ã‚ºã¨Triageãƒ•ã‚§ãƒ¼ã‚ºã¯ã€ç”Ÿæˆã•ã‚ŒãŸå„ã‚¢ãƒ©ãƒ¼ãƒˆã«å¯¾ã—ã¦ç‹¬ç«‹ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ä»Šå›ã®å®Ÿè£…ã§ã¯å„ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é †æ¬¡å‡¦ç†ã—ã¦ã„ã¾ã™ãŒã€å®Ÿé‹ç”¨ã§ã¯ `go` ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ä¸¦åˆ—å®Ÿè¡Œã—ã€å‡¦ç†é€Ÿåº¦ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚å„ãƒ•ã‚§ãƒ¼ã‚ºã®çµæœã¯æœ€çµ‚çš„ã« `WorkflowResult` æ§‹é€ ä½“ã«é›†ç´„ã•ã‚Œã¾ã™

```go
func (e *Engine) Execute(ctx context.Context, rawData any) ([]*WorkflowResult, error) {
    // Phase 1: Ingestï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ â†’ Alerté…åˆ—ï¼‰
    ingestResult, _ := e.runIngest(ctx, rawData)
    if len(ingestResult.Alert) == 0 {
        return nil, nil  // æ£„å´ã•ã‚ŒãŸ
    }

    // å„ã‚¢ãƒ©ãƒ¼ãƒˆã«å¯¾ã—ã¦Enrich + Triageã‚’å®Ÿè¡Œ
    results := []*WorkflowResult{}
    for _, alert := range ingestResult.Alert {
        // Phase 2: Enrichï¼ˆAlert â†’ èª¿æŸ»çµæœï¼‰
        enrichResult, enrichExecution, _ := e.runEnrich(ctx, alert)

        // Phase 3: Triageï¼ˆAlert + èª¿æŸ»çµæœ â†’ åˆ¤å®šï¼‰
        triageResult, _ := e.runTriage(ctx, alert, enrichExecution)

        results = append(results, &WorkflowResult{
            Alert:           alert,
            EnrichResult:    enrichResult,
            EnrichExecution: enrichExecution,
            Triage:          triageResult,
        })
    }
    return results, nil
}
```

## å®Ÿè¡Œä¾‹ã¨ã¾ã¨ã‚

### å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã®ä¾‹

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆã‚’äº‹å‰æ¤œæŸ»ã—ã€é–¢é€£ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã«Triageãƒ•ã‚§ãƒ¼ã‚ºã§ `discard` ã¨ã—ã¦æ£„å´ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚å®Ÿé‹ç”¨ã§ã¯ã“ã“ã¾ã§å³æ ¼ãªåˆ¤å®šã¯è¡Œã‚ãªã„ã‚±ãƒ¼ã‚¹ã‚‚å¤šã„ã§ã™ãŒã€å‹•ä½œç¢ºèªç”¨ã¨ã—ã¦ã“ã®ã‚ˆã†ãªãƒãƒªã‚·ãƒ¼ã‚’å®šç¾©ã—ã¦ã„ã¾ã™

```bash
$ go run . new -i examples/alert/scc.json --policy-dir examples/policy-scc

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¥ INGEST PHASE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… Generated 1 alert(s)
   1. SCC: Execution: Cryptocurrency Mining Hash Match

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ ALERT 1/1: SCC: Execution: Cryptocurrency Mining Hash Match
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ” ENRICH PHASE
   ğŸ¤– Task 1/1: bigquery_impact_analysis
      ğŸ”§ Tool: bigquery_run
  ğŸ“Š BigQuery: 0 rows, 0 MB scanned

#######ï¼ˆBigQueryã§ãƒ­ã‚°ã‚’æ¤œç´¢ã—ã€è©²å½“ãƒ­ã‚°ãŒ0ä»¶ã ã£ãŸã“ã¨ã‚’ç¢ºèªï¼‰#########

   âœ… Executed 1 enrichment task(s)
      1. bigquery_impact_analysis: {
  "result": "false_positive",
  "reasoning": "BigQuery ret...

âš–ï¸  TRIAGE PHASE
   ğŸ—‘ï¸ Action: discard
   â„¹ï¸ Severity: info
   ğŸ“ Note: False positive: BigQuery returned 0 matching logs for the specified resource and time frame (2025-11-08 04:23:47 UTC to 2025-11-08 06:23:47 UTC) containing keywords 'xmrig', 'pool.minexmr.com', or '185.220.101.42'. This strongly suggests that the activity described in the alert did not actually occur or was not logged within the specified period, leading to a false positive verdict based on the log evidence.

Alert: SCC: Execution: Cryptocurrency Mining Hash Match
  Action: discard, Severity: info
  Note: False positive: BigQuery returned 0 matching logs for the specified resource and time frame (2025-11-08 04:23:47 UTC to 2025-11-08 06:23:47 UTC) containing keywords 'xmrig', 'pool.minexmr.com', or '185.220.101.42'. This strongly suggests that the activity described in the alert did not actually occur or was not logged within the specified period, leading to a false positive verdict based on the log evidence.
  â†’ Discarded (not saving to database)
```

å„ãƒ•ã‚§ãƒ¼ã‚ºãŒé †æ¬¡å®Ÿè¡Œã•ã‚Œã€æœ€çµ‚çš„ã«ã‚¢ãƒ©ãƒ¼ãƒˆãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚

### é‹ç”¨ã®ãƒã‚¤ãƒ³ãƒˆ

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿé‹ç”¨ã§æ´»ç”¨ã™ã‚‹éš›ã«ã¯ã€ã„ãã¤ã‹ã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ã€‚

#### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®èª¿æ•´

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯æœŸå¾…é€šã‚Šã®å‹•ä½œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€ååˆ†ãªèª¿æ•´ãŒå¿…è¦ã§ã™ã€‚å®Ÿéš›ã«é‹ç”¨ã—ã¦ã¿ã‚‹ã¨ã€LLMãŒæ€ã£ãŸã¨ãŠã‚Šã«å‹•ã„ã¦ãã‚Œãªã„ã‚±ãƒ¼ã‚¹ãŒå¤šã€…ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ãƒ¢ãƒ‡ãƒ«è‡ªä½“ã®æ€§èƒ½ã®å•é¡Œã‚‚ã‚ã‚Šã¾ã™ãŒã€å¤šãã®å ´åˆã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã¾ã‚Œã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹ã“ã¨ãŒåŸå› ã§ã™ã€‚ã‚¢ãƒ©ãƒ¼ãƒˆã®èƒŒæ™¯æƒ…å ±ã‚„æœŸå¾…ã™ã‚‹èª¿æŸ»ã®è¦³ç‚¹ã‚’æ˜ç¢ºã«è¨˜è¿°ã™ã‚‹ã“ã¨ã§ã€ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚

#### Gitã§ã®ãƒãƒªã‚·ãƒ¼ç®¡ç†

Regoãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆVCSï¼‰ã§ç®¡ç†ã—ã€å¤‰æ›´å±¥æ­´ã‚’è¿½è·¡ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¹ãã§ã™ã€‚ãƒãƒªã‚·ãƒ¼ã‚’ã‚³ãƒ¼ãƒ‰ã¨åŒæ§˜ã«Gitã§ç®¡ç†ã™ã‚‹ã“ã¨ã§ã€å¤‰æ›´ã®ç†ç”±ã‚„å½±éŸ¿ç¯„å›²ã‚’è¿½è·¡ã§ãã€å•é¡ŒãŒç™ºç”Ÿã—ãŸéš›ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã‚‚ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè£…ã¨ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ†é›¢ã™ã‚‹ç†ç”±ã®ä¸€ã¤ã§ã™ã€‚

#### ãƒ­ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

ã©ã®ãƒ«ãƒ¼ãƒ«ã§ãƒãƒƒãƒã—ãŸã‹ã‚’è¨˜éŒ²ã—ã€ã©ã®ã‚ˆã†ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç”Ÿæˆã•ã‚Œã€ãã‚Œã«å¯¾ã—ã¦ã©ã®ã‚ˆã†ãªå¿œç­”ãŒã‚ã£ãŸã‹ã‚’ãƒ­ã‚°ã¨ã—ã¦æ®‹ã™ã“ã¨ãŒé‡è¦ã§ã™ã€‚ã“ã®ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã¦ã„ã‚Œã°ã€ã‚ã¨ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚„ãƒãƒªã‚·ãƒ¼ã‚’ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹éš›ã®è²´é‡ãªå‚è€ƒæƒ…å ±ã«ãªã‚Šã¾ã™ã€‚ç‰¹ã«ã€èª¤æ¤œçŸ¥ã‚„è¦‹é€ƒã—ãŒç™ºç”Ÿã—ãŸéš›ã®åŸå› åˆ†æã«å½¹ç«‹ã¡ã¾ã™ã€‚

#### ãƒãƒªã‚·ãƒ¼ã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã¸ã®ç”ŸæˆAIæ´»ç”¨

ãƒãƒªã‚·ãƒ¼ã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ä½œæ¥­è‡ªä½“ã«ã‚‚ç”ŸæˆAIã‚’æ´»ç”¨ã§ãã¾ã™ã€‚ãƒãƒªã‚·ãƒ¼ã®ã‚¹ã‚­ãƒ¼ãƒã‚„ãƒ«ãƒ¼ãƒ«ã‚’äº‹å‰ã«LLMã«å…¥åŠ›ã—ã€ã‹ã¤å…·ä½“çš„ãªäº‹ä¾‹ã‚’æç¤ºã™ã‚‹ã¨ã€é©åˆ‡ãªãƒ«ãƒ¼ãƒ«ä¿®æ­£æ¡ˆã‚’ææ¡ˆã—ã¦ãã‚Œã¾ã™ã€‚ãŸã ã—ã€Regoã¯æ¯”è¼ƒçš„ãƒã‚¤ãƒŠãƒ¼ãªè¨€èªã§ã‚ã‚‹ãŸã‚ã€å®Œå…¨ã«ç‹¬è‡ªã®DSLè¨€èªã‚’ä½¿ã†å ´åˆã«æ¯”ã¹ã‚Œã°æœ‰åˆ©ã§ã™ãŒã€ãã‚Œã§ã‚‚ç”ŸæˆAIã®å¯¾å¿œç²¾åº¦ã«ã¯é™ç•ŒãŒã‚ã‚‹ç‚¹ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

# ã¾ã¨ã‚

æœ¬ç« ã§ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆåˆ†æã®ãŸã‚ã®AIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è¨­è¨ˆã—ã€Goã¨OPA/Regoã§å®Ÿè£…ã—ã¾ã—ãŸã€‚å®Ÿè£…ã®æ ¸å¿ƒã¯ã€Ingest/Enrich/Triageã®3ãƒ•ã‚§ãƒ¼ã‚ºå‡¦ç†ã¨ã€**Regoã«ã‚ˆã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã¨Goã«ã‚ˆã‚‹å®Ÿè¡ŒåŸºç›¤ã®åˆ†é›¢**ã«ã‚ã‚Šã¾ã™ã€‚ã“ã®åˆ†é›¢ã«ã‚ˆã‚Šã€é–‹ç™ºè€…ã¯ã‚¨ãƒ³ã‚¸ãƒ³ã®æ”¹å–„ã«é›†ä¸­ã§ãã€é‹ç”¨æ‹…å½“è€…ã¯Regoãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†ã ã‘ã§ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’èª¿æ•´ã§ãã¾ã™ã€‚å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ä¸è¦ã§ãƒãƒªã‚·ãƒ¼ã‚’æ›´æ–°ã§ãã‚‹ãŸã‚ã€ã‚¢ãƒ©ãƒ¼ãƒˆåˆ†æãƒ«ãƒ¼ãƒ«ã®æ”¹å–„ã‚µã‚¤ã‚¯ãƒ«ã‚’é«˜é€ŸåŒ–ã§ãã¾ã™ã€‚

ã€Œå…¥åŠ›ã®æ­£è¦åŒ–ã€â†’ã€Œå¤–éƒ¨æƒ…å ±ã«ã‚ˆã‚‹æ‹¡å……ã€â†’ã€Œæœ€çµ‚åˆ¤å®šã€ã¨ã„ã†å‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä»¥å¤–ã®å®šå‹æ¥­å‹™ã«ã‚‚å¿œç”¨å¯èƒ½ã§ã™ã€‚ä¾‹ãˆã°ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆã§ã¯ã€Ingestã§å•ã„åˆã‚ã›ãƒã‚±ãƒƒãƒˆã‹ã‚‰è£½å“åãƒ»ã‚¨ãƒ©ãƒ¼å†…å®¹ãƒ»å¥‘ç´„ãƒ—ãƒ©ãƒ³ã‚’æŠ½å‡ºã—ã€Enrichã§ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã‹ã‚‰é¡ä¼¼äº‹ä¾‹ã‚’æ¤œç´¢ã—ãŸã‚Šã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã§éšœå®³çŠ¶æ³ã‚’ç¢ºèªã—ãŸã‚Šã—ã¦ã€Triageã§ç·Šæ€¥åº¦ãƒ»å¯¾å¿œéƒ¨ç½²ãƒ»ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¦å¦ã‚’åˆ¤å®šã™ã‚‹ã¨ã„ã£ãŸæµã‚ŒãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚LLMã«ã‚ˆã‚‹æŸ”è»Ÿãªèª¿æŸ»ãŒå¿…è¦ãªæ¥­å‹™ã§ã‚ã‚Œã°ã€ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ©æµã‚’å—ã‘ã‚‰ã‚Œã¾ã™ã€‚

å®Ÿé‹ç”¨ã§ã¯ã€æœ€åˆã‹ã‚‰å®Œç’§ã‚’ç›®æŒ‡ã•ãšã€å°ã•ãå§‹ã‚ã¦é‹ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚‚ã¨ã«æ”¹å–„ã—ã¦ã„ãã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒåŠ¹æœçš„ã§ã™ã€‚
